<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Cipher Lab — Workspace</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    html { overflow-y: scroll; scrollbar-gutter: stable both-edges; }

    /* =============== Shell =============== */
    .ws-shell{
      min-height: calc(100dvh - 80px);
      display: grid;
      grid-template-rows: 1fr;
      padding: 0;
      box-sizing: border-box;
    }

    .ws-card{
      width: 98vw;
      max-width: none;
      margin: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 0;
      box-shadow: none;
    }

    /* =============== Top Toolbar =============== */
    .ws-topbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(0deg, rgba(0,0,0,0.04), transparent);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .ws-titlewrap{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .ws-dot{
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent-soft);
      flex: 0 0 auto;
    }

    .ws-title{
      margin: 0;
      font-size: 1rem;
      font-weight: 800;
      color: var(--text);
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ws-sub{
      color: var(--muted);
      font-size: .86rem;
      margin-left: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ws-tools{
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tb-btn{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--line-2);
      background: transparent;
      color: var(--text);
      font-weight: 700;
      font-size: .86rem;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .06s ease;
      letter-spacing: .02em;
      white-space: nowrap;
    }

    .tb-btn:hover{
      background: var(--input-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .tb-btn:active{ transform: translateY(1px); }

    .tb-btn.active{
      background: var(--accent);
      border-color: var(--accent);
      color: #0f0f0f;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
    }

    .tb-btn.primary{
      background: var(--accent);
      border-color: var(--accent);
      color: #0f0f0f;
    }

    .tb-btn.primary:hover{
      background: var(--accent-strong);
      border-color: var(--accent-strong);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }

    .ws-status{
      color: var(--muted);
      font-size: .86rem;
      min-width: 88px;
      text-align: right;
    }

    /* =============== Main Grid =============== */
    .ws-grid{
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(460px, 600px);
      gap: 16px;
      padding: 16px;
      box-sizing: border-box;
      align-items: stretch;
    }

    @media (max-width: 980px){
      .ws-grid{ grid-template-columns: 1fr; }
    }

    /* =============== Panels =============== */
    .ws-panel{
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
    }

    .ws-panel h3{
      margin: 0 0 10px;
      color: var(--accent);
      font-size: .98rem;
      letter-spacing: .2px;
    }

    /* =============== Doc Area =============== */
    .doc-wrap{
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 10px;
    }

    .doc-meta{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: .86rem;
    }

    .doc-title{
      width: 100%;
      box-sizing: border-box;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 10px;
      padding: 12px 12px;
      color: var(--text);
      font-weight: 800;
      font-size: 1rem;
    }

    .doc-title:focus{
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .doc-text{
      width: 100%;
      min-height: 380px;
      box-sizing: border-box;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 12px;
      padding: 12px 12px;
      color: var(--text);
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      font-size: 15px;
      line-height: 1.55;
      resize: vertical;
      white-space: pre-wrap;
      word-break: break-word;
      scrollbar-gutter: stable both-edges;
    }

    .doc-text:focus{
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .doc-actions{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    .mini-btn{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--line-2);
      background: transparent;
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .mini-btn:hover{
      background: var(--input-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    /* =============== Right Sidebar =============== */
    .cipher-side{
      display: grid;
      gap: 12px;
      position: sticky;
      top: 74px;
    }

    @media (max-width: 980px){
      .cipher-side{ position: relative; top: 0; }
    }

    .cipher-text{
      width: 100%;
      min-height: 420px;
      box-sizing: border-box;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 12px;
      padding: 14px;
      color: var(--text);
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      font-size: 15px;
      line-height: 1.6;
      resize: vertical;
    }

    .cipher-text:focus{
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .hint{
      color: var(--muted);
      font-size: .86rem;
      line-height: 1.45;
    }

    /* =============== Tool Panel (Dock) =============== */
    .tool-panel{ margin-top: 12px; }
    .tool-card{ display: none; }
    .tool-card.active{ display: grid; gap: 10px; }

    .tool-row{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    select, input[type="number"], input[type="text"]{
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      font-size: 14px;
      transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
    }
    select:focus, input:focus{
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .run-btn{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #0f0f0f;
      font-weight: 800;
      cursor: pointer;
      transition: background .15s ease, box-shadow .18s ease, transform .06s ease;
    }
    .run-btn:hover{
      background: var(--accent-strong);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    .run-btn:active{ transform: translateY(1px); }

    .run-btn.secondary{
      background: transparent;
      border: 1px solid var(--line-2);
      color: var(--text);
      font-weight: 800;
    }
    .run-btn.secondary:hover{
      background: var(--input-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .result{
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 12px;
      padding: 12px 12px;
      color: var(--text);
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 60px;
    }

    /* =============== Substitution MVP =============== */
    .sub-grid{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(46px, 1fr));
      gap: 10px;
    }

    .sub-box{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 8px 6px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
    }

    .sub-top{
      color: var(--text-dim);
      font-size: .82rem;
      font-weight: 900;
      text-transform: lowercase;
    }

    .sub-arrow{
      font-size: .75rem;
      color: var(--muted);
      opacity: .8;
    }

    .sub-input{
      width: 36px;
      height: 34px;
      text-align: center;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text);
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      font-size: 15px;
      transition: .18s ease;
    }
    .sub-input:focus{
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .helper{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      border-top: 1px dashed var(--line);
      padding-top: 10px;
      color: var(--muted);
      font-size: .86rem;
    }

    /* =============== Image Zoom Modal =============== */
    .img-modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 6000;
    }
    .img-modal.open{ display: flex; }

    .img-modal-box{
      width: min(1100px, 92vw);
      height: min(82vh, 820px);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .img-modal-top{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
    }

    .img-modal-title{
      color: var(--text);
      font-weight: 900;
      font-size: .92rem;
    }

    .img-close{
      border: 1px solid var(--line-2);
      background: transparent;
      color: var(--text);
      font-weight: 900;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }
    .img-close:hover{
      background: var(--input-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .img-modal-img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: rgba(255,255,255,0.02);
    }

    /* =========================================================
       MOBILE TOPBAR OVERRIDE
       ========================================================= */
    @media (max-width: 640px){
      html, body,
      .ws-shell,
      .ws-card,
      .ws-topbar,
      .ws-grid,
      .ws-panel,
      .doc-wrap,
      .cipher-side{
        overflow-x: hidden !important;
      }

      .ws-topbar{
        justify-content: flex-start !important;
        flex-wrap: nowrap !important;
        gap: 8px !important;

        overflow-x: auto !important;
        overflow-y: hidden !important;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-x;
        scrollbar-width: none;
        padding-bottom: 10px;
      }
      .ws-topbar::-webkit-scrollbar{ display: none; }

      .ws-titlewrap{
        width: auto !important;
        min-width: max-content !important;
        flex: 0 0 auto !important;
        gap: 6px !important;
      }

      .ws-tools{
        width: auto !important;
        min-width: max-content !important;
        flex: 0 0 auto !important;

        display: flex !important;
        flex-wrap: nowrap !important;
        justify-content: flex-start !important;
        gap: 8px !important;

        overflow: visible !important;
        margin-left: 4px !important;
      }

      .ws-tools .tb-btn{
        flex: 0 0 auto;
        white-space: nowrap;
      }

      .doc-actions, .cipher-upload-actions { justify-content: flex-start; }
      .mini-btn, .img-btn { width: 100%; }
    }

    /* =========================================================
       Upload image buttons + preview (APPEND AT END)
       ========================================================= */

    /* ===== Cipher image uploader ===== */
    .cipher-upload{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--line);
      display: grid;
      gap: 10px;
    }

    .cipher-upload-row{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* ✅ Hidden file input (we trigger it from the Upload button) */
    #cipher-image-input{
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .cipher-upload-actions{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .img-btn{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line-2);
      background: transparent;
      color: var(--text);
      font-weight: 800;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .06s ease;
      white-space: nowrap;
    }
    .img-btn:hover{
      background: var(--input-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }
    .img-btn:active{ transform: translateY(1px); }

    .img-btn.primary{
      background: var(--accent);
      border-color: var(--accent);
      color: #0f0f0f;
    }
    .img-btn.primary:hover{
      background: var(--accent-strong);
      border-color: var(--accent-strong);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }

    .img-btn.danger{
      border-color: rgba(255, 107, 107, 0.35);
      color: #ff8b8b;
    }
    .img-btn.danger:hover{
      background: rgba(255, 107, 107, 0.12);
      border-color: #ff7070;
      box-shadow: 0 0 0 2px rgba(255, 112, 112, 0.18);
    }

    .img-btn:disabled{
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none !important;
    }

    .cipher-upload-status{
      color: var(--muted);
      font-size: .86rem;
      min-height: 18px;
    }

    /* ===== Preview ===== */
    .cipher-img-wrap{
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--line);
      gap: 10px;
    }

    .cipher-img{
      width: 100%;
      max-height: 360px;
      border-radius: 12px;
      border: 1px solid var(--line);
      object-fit: contain;
      background: rgba(255,255,255,0.02);
      cursor: zoom-in;
    }
  </style>
</head>

<body>
  {% include 'base_nav.html' %}

  <main class="ws-shell">
    <section class="ws-card" aria-label="Cipher Workspace">
      <!-- Top Bar -->
      <header class="ws-topbar">
        <div class="ws-titlewrap">
          <span class="ws-dot" aria-hidden="true"></span>
          <h1 class="ws-title">Workspace</h1>
          <span class="ws-sub" id="ws-id">#{{ ws.id }}</span>
        </div>

        <div class="ws-tools" role="toolbar" aria-label="Workspace tools">
          <button class="tb-btn active" data-tool="frequency" type="button">Frequency</button>
          <button class="tb-btn" data-tool="substitution" type="button">Substitution</button>
          <button class="tb-btn" data-tool="replacer" type="button">Replace</button>
          <button class="tb-btn" data-tool="spacer" type="button">Spacer</button>
          <button class="tb-btn" data-tool="remove_spaces" type="button">No spaces</button>
          <button class="tb-btn" data-tool="remove_punctuation" type="button">No punct</button>
          <button class="tb-btn" data-tool="breaker" type="button">Breaker</button>

          <button class="tb-btn primary" id="save-btn" type="button">Save</button>
          <div class="ws-status" id="save-status">—</div>
        </div>
      </header>

      <div class="ws-grid">
        <!-- Left: Doc + Tool Dock -->
        <div class="ws-panel">
          <div class="doc-wrap">
            <div class="doc-meta">
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                <span style="color:var(--text-dim);font-weight:800;">Notes / Plaintext</span>
                <span style="opacity:.7;">• autosave is manual in MVP</span>
              </div>
              <div style="color:var(--muted);">
                Updated: <span id="updated-at">{{ ws.updated_at if ws.updated_at else "—" }}</span>
              </div>
            </div>

            <input id="ws-title-input" class="doc-title" placeholder="Workspace title"
                   value="{{ ws.title or 'Untitled Workspace' }}"/>

            <textarea id="ws-notes" class="doc-text" placeholder="Write notes, partial plaintext, hypotheses…">{{ ws.notes or "" }}</textarea>

            <div class="doc-actions">
              <button class="mini-btn" id="insert-tool-output" type="button">Insert tool output → doc</button>
              <button class="mini-btn" id="copy-doc" type="button">Copy doc</button>
            </div>

            <!-- Tool Dock -->
            <div class="ws-panel tool-panel" style="padding: 14px;">
              <h3>Tool Dock</h3>

              <!-- Frequency -->
              <div class="tool-card active" id="tool-frequency">
                <div class="tool-row">
                  <button class="run-btn" id="run-frequency" type="button">Run frequency</button>
                  <button class="run-btn secondary" id="copy-tool" type="button">Copy output</button>
                </div>
                <div class="result" id="tool-output">Run a tool to see output here.</div>
                <div class="hint">
                  Uses your existing <code>/tools/run</code> API (<code>tool_type=frequency</code>).
                </div>
              </div>

              <!-- Substitution -->
              <div class="tool-card" id="tool-substitution">
                <div class="hint">
                  Map plaintext letters (top) → ciphertext letters (input). This MVP applies the mapping live to the cipher text below.
                </div>

                <div class="sub-grid" id="sub-grid"></div>

                <div class="helper">
                  <div>Tip: enter ciphertext letters as <strong>A–Z</strong> under each marker.</div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="run-btn secondary" id="sub-clear" type="button">Clear mapping</button>
                    <button class="run-btn secondary" id="sub-reset" type="button">Reset view</button>
                    <button class="run-btn" id="sub-frequency" type="button">Freq from cipher</button>
                  </div>
                </div>

                <div class="result" id="sub-freq-output">Frequency output will appear here.</div>
              </div>

              <!-- Text Replacer -->
              <div class="tool-card" id="tool-replacer">
                <div class="tool-row" style="align-items:flex-end;">
                  <div style="display:grid;gap:6px;flex:1;">
                    <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Find</label>
                    <input id="rep-find" type="text" placeholder="e.g. XQ" />
                  </div>
                  <div style="display:grid;gap:6px;flex:1;">
                    <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Replace</label>
                    <input id="rep-with" type="text" placeholder="e.g. TH" />
                  </div>
                  <button class="run-btn" id="run-replace" type="button">Run</button>
                </div>

                <div class="result" id="tool-output-replace">Output will appear here.</div>
                <div class="hint">Calls <code>/tools/run</code> with <code>tool_type=text_replacer</code>.</div>
              </div>

              <!-- Spacer -->
              <div class="tool-card" id="tool-spacer">
                <div class="tool-row" style="align-items:flex-end;">
                  <div style="display:grid;gap:6px;">
                    <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Block length</label>
                    <input id="spacer-len" type="number" min="1" value="5" style="width:120px;" />
                  </div>
                  <button class="run-btn" id="run-spacer" type="button">Run</button>
                </div>

                <div class="result" id="tool-output-spacer">Output will appear here.</div>
                <div class="hint">Calls <code>/tools/run</code> with <code>tool_type=text_spacer</code>.</div>
              </div>

              <!-- Remove spaces -->
              <div class="tool-card" id="tool-remove_spaces">
                <div class="tool-row">
                  <button class="run-btn" id="run-remove-spaces" type="button">Remove spaces</button>
                </div>
                <div class="result" id="tool-output-remove-spaces">Output will appear here.</div>
              </div>

              <!-- Remove punctuation -->
              <div class="tool-card" id="tool-remove_punctuation">
                <div class="tool-row">
                  <button class="run-btn" id="run-remove-punct" type="button">Remove punctuation</button>
                </div>
                <div class="result" id="tool-output-remove-punct">Output will appear here.</div>
              </div>

              <!-- Breaker -->
              <div class="tool-card" id="tool-breaker">
                <div class="hint">
                  Calls <code>/breaker</code>. Optional fixed-map format: <code>AB=TH, CD=ER</code>
                </div>

                <div class="tool-row" style="align-items:flex-end;">
                  <div style="display:grid;gap:6px;flex:1;min-width:180px;">
                    <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Cipher type</label>
                    <select id="breaker-type">
                      <option value="auto">auto</option>
                      <option value="caesar">caesar</option>
                      <option value="vigenere" selected>vigenere</option>
                      <option value="affine">affine</option>
                      <option value="amsco">amsco</option>
                      <option value="railfence">railfence</option>
                      <option value="columnar">columnar</option>
                      <option value="permutation">permutation</option>
                      <option value="polybius">polybius</option>
                      <option value="substitution">substitution</option>
                      <option value="atbash">atbash</option>
                      <option value="base64">base64</option>
                      <option value="hex">hex</option>
                      <option value="binary">binary</option>
                      <option value="baconian">baconian</option>
                    </select>
                  </div>

                  <button class="run-btn" id="run-breaker" type="button">Run breaker</button>
                  <button class="run-btn secondary" id="copy-breaker" type="button">Copy output</button>
                </div>

                <div style="display:grid;gap:6px;margin-top:6px;">
                  <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Known plaintext / fixed map (optional)</label>
                  <input id="breaker-known" type="text" placeholder="e.g. AB=TH, CD=ER" />
                </div>

                <div class="result" id="breaker-output">Run breaker to see output here.</div>
              </div>

            </div>
          </div>
        </div>

        <!-- Right: Cipher View -->
        <aside class="ws-panel cipher-side" aria-label="Cipher sidebar">
          <div class="ws-panel" style="padding:14px;">
            <h3>Cipher View</h3>

            <!-- Hidden file input (triggered by Upload button) -->
            <input id="cipher-image-input" type="file" accept="image/*" />

            <div class="cipher-upload">
              <div class="cipher-upload-row">
                <div class="cipher-upload-actions">
                  <button class="img-btn primary" id="upload-cipher-image" type="button">Upload image</button>
                  <button class="img-btn danger" id="delete-cipher-image" type="button">Remove</button>
                </div>
              </div>
              <div class="cipher-upload-status" id="cipher-image-status">—</div>
            </div>

            <!-- ✅ Preview ON TOP of textarea -->
            <div class="cipher-img-wrap" id="cipher-image-wrap">
              <h3 style="margin-bottom:8px;">Cipher Image</h3>
              <img id="cipher-img" class="cipher-img" src="" alt="Cipher image" />
              <div class="hint">Tap/click to zoom.</div>
            </div>

            <textarea id="cipher-text" class="cipher-text" placeholder="Paste ciphertext here…">{{ ws.cipher_text or "" }}</textarea>

            <div class="hint" style="margin-top:8px;">
              Paste your cipher here. Tools read from this box. Save stores it in the workspace.
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Image Zoom Modal -->
  <div id="img-modal" class="img-modal" aria-hidden="true">
    <div class="img-modal-box" role="dialog" aria-modal="true" aria-label="Cipher image zoom">
      <div class="img-modal-top">
        <div class="img-modal-title">Cipher Image</div>
        <button class="img-close" id="img-close" type="button">Close</button>
      </div>
      <img id="img-modal-img" class="img-modal-img" alt="Cipher image zoomed" />
    </div>
  </div>

  <script>
    // ===========================
    // Helpers
    // ===========================
    function escapeHtml(str) {
      return (str || "").replace(/[&<>"']/g, s =>
        ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s])
      );
    }

    async function toolsRun(tool_type, payload = {}) {
      const formData = new FormData();
      formData.append("tool_type", tool_type);
      formData.append("text", payload.text ?? "");
      if (payload.block_length != null) formData.append("block_length", String(payload.block_length));
      if (payload.to_replace != null) formData.append("to_replace", payload.to_replace);
      if (payload.replacement != null) formData.append("replacement", payload.replacement);

      const res = await fetch("/tools/run", { method: "POST", body: formData });
      const data = await res.json();
      return data.text || "";
    }

    async function breakerRunRequest(payload = {}) {
      const fd = new FormData();
      fd.append("text", payload.text ?? "");
      fd.append("cipher_type", (payload.cipher_type ?? "vigenere").toLowerCase());
      fd.append("known_plaintext", payload.known_plaintext ?? "");

      const res = await fetch("/breaker", { method: "POST", body: fd });
      const data = await res.json();
      return data;
    }

    function setStatus(msg) {
      const el = document.getElementById("save-status");
      if (el) el.textContent = msg;
    }

    // ===========================
    // Toolbar switching
    // ===========================
    const toolButtons = Array.from(document.querySelectorAll(".tb-btn[data-tool]"));
    const toolCards = {
      frequency: document.getElementById("tool-frequency"),
      substitution: document.getElementById("tool-substitution"),
      replacer: document.getElementById("tool-replacer"),
      spacer: document.getElementById("tool-spacer"),
      remove_spaces: document.getElementById("tool-remove_spaces"),
      remove_punctuation: document.getElementById("tool-remove_punctuation"),
      breaker: document.getElementById("tool-breaker"),
    };

    function showTool(name) {
      toolButtons.forEach(b => b.classList.toggle("active", b.dataset.tool === name));
      Object.entries(toolCards).forEach(([k, el]) => {
        if (!el) return;
        el.classList.toggle("active", k === name);
      });
    }

    toolButtons.forEach(btn => {
      btn.addEventListener("click", () => showTool(btn.dataset.tool));
    });

    // ===========================
    // Save
    // ===========================
    const saveBtn = document.getElementById("save-btn");
    const notesEl = document.getElementById("ws-notes");
    const titleEl = document.getElementById("ws-title-input");
    const cipherEl = document.getElementById("cipher-text");

    async function saveWorkspace() {
      setStatus("Saving…");
      try {
        const fd = new FormData();
        fd.append("title", titleEl.value || "");
        fd.append("notes", notesEl.value || "");
        fd.append("cipher_text", cipherEl.value || "");

        const res = await fetch(`/workspaces/{{ ws.id }}/save`, { method: "POST", body: fd });
        const data = await res.json();
        if (!data.ok) throw new Error("save failed");
        setStatus("Saved ✓");
        setTimeout(() => setStatus("—"), 1400);
      } catch {
        setStatus("Save failed");
        setTimeout(() => setStatus("—"), 1600);
      }
    }

    saveBtn?.addEventListener("click", saveWorkspace);

    // ===========================
    // Insert output → doc (includes tool name)
    // ===========================
    const insertBtn = document.getElementById("insert-tool-output");

    const TOOL_LABELS = {
      frequency: "Frequency",
      substitution: "Substitution",
      replacer: "Replace",
      spacer: "Spacer",
      remove_spaces: "No spaces",
      remove_punctuation: "No punct",
      breaker: "Breaker",
    };

    function getActiveToolOutput() {
      const active = document.querySelector(".tool-card.active");
      if (!active) return { tool: "Tool", text: "" };

      const id = active.id || "";
      const toolKey = id.startsWith("tool-") ? id.slice(5) : "tool";
      const toolLabel = TOOL_LABELS[toolKey] || toolKey;

      const out = active.querySelector(".result");
      return { tool: toolLabel, text: out ? out.textContent : "" };
    }

    insertBtn?.addEventListener("click", () => {
      const { tool, text } = getActiveToolOutput();
      if (!text || text.trim() === "" || text.trim() === "Run a tool to see output here.") return;

      const stamp = new Date().toLocaleString("en-GB", {
        day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit"
      }).replace(",", "");

      notesEl.value += (notesEl.value ? "\n\n" : "") + `--- ${tool} output (${stamp}) ---\n` + text + "\n";
      notesEl.focus();
    });

    document.getElementById("copy-doc")?.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(notesEl.value || "");
        setStatus("Copied");
        setTimeout(() => setStatus("—"), 900);
      } catch {}
    });

    // ===========================
    // Frequency
    // ===========================
    const freqBtn = document.getElementById("run-frequency");
    const copyToolBtn = document.getElementById("copy-tool");
    const outMain = document.getElementById("tool-output");

    freqBtn?.addEventListener("click", async () => {
      outMain.textContent = "Running…";
      try {
        const text = cipherEl.value || "";
        const out = await toolsRun("frequency", { text });
        outMain.textContent = out || "(no output)";
      } catch {
        outMain.textContent = "Error running frequency.";
      }
    });

    copyToolBtn?.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText((outMain.textContent || "").trim());
        setStatus("Copied");
        setTimeout(() => setStatus("—"), 900);
      } catch {}
    });

    // ===========================
    // Substitution (client-side mapping MVP)
    // ===========================
    const alphabet = "abcdefghijklmnopqrstuvwxyz".split("");
    const subGrid = document.getElementById("sub-grid");
    const subFreqBtn = document.getElementById("sub-frequency");
    const subFreqOut = document.getElementById("sub-freq-output");

    const mapping = {}; // plain -> cipher uppercase
    let originalCipher = (cipherEl.value || "").toUpperCase();

    function renderSubGrid() {
      if (!subGrid) return;
      subGrid.innerHTML = "";
      alphabet.forEach(plain => {
        mapping[plain] = mapping[plain] || "";
        const box = document.createElement("div");
        box.className = "sub-box";
        box.innerHTML = `
          <div class="sub-top">${plain}</div>
          <div class="sub-arrow">↓</div>
          <input class="sub-input" maxlength="1" data-plain="${plain}" placeholder="…" value="${escapeHtml(mapping[plain] || "")}">
        `;
        subGrid.appendChild(box);
      });

      subGrid.querySelectorAll(".sub-input").forEach(inp => {
        inp.addEventListener("input", () => {
          const plain = inp.dataset.plain;
          const c = (inp.value || "").toUpperCase().replace(/[^A-Z]/g, "");
          inp.value = c;
          mapping[plain] = c;
          applySubMapping();
        });
      });
    }

    function applySubMapping() {
      const text = originalCipher || "";
      let out = "";

      for (const ch of text) {
        let replaced = false;
        for (const [plain, cipher] of Object.entries(mapping)) {
          if (cipher && ch === cipher) {
            out += plain;
            replaced = true;
            break;
          }
        }
        if (!replaced) out += ch;
      }
      cipherEl.value = out;
    }

    cipherEl?.addEventListener("input", () => {
      originalCipher = (cipherEl.value || "").toUpperCase();
    });

    document.getElementById("sub-clear")?.addEventListener("click", () => {
      Object.keys(mapping).forEach(k => mapping[k] = "");
      renderSubGrid();
      applySubMapping();
    });

    document.getElementById("sub-reset")?.addEventListener("click", () => {
      cipherEl.value = originalCipher;
      subFreqOut.textContent = "Frequency output will appear here.";
    });

    subFreqBtn?.addEventListener("click", async () => {
      subFreqOut.textContent = "Running…";
      try {
        const out = await toolsRun("frequency", { text: originalCipher });
        subFreqOut.textContent = out || "(no output)";
      } catch {
        subFreqOut.textContent = "Error running frequency.";
      }
    });

    renderSubGrid();

    // ===========================
    // Text Replacer
    // ===========================
    const repFind = document.getElementById("rep-find");
    const repWith = document.getElementById("rep-with");
    const repRun = document.getElementById("run-replace");
    const repOut = document.getElementById("tool-output-replace");

    repRun?.addEventListener("click", async () => {
      repOut.textContent = "Running…";
      try {
        const out = await toolsRun("text_replacer", {
          text: cipherEl.value || "",
          to_replace: repFind.value || "",
          replacement: repWith.value || ""
        });
        repOut.textContent = out || "(no output)";
      } catch {
        repOut.textContent = "Error running replacer.";
      }
    });

    // ===========================
    // Spacer
    // ===========================
    const spacerRun = document.getElementById("run-spacer");
    const spacerLen = document.getElementById("spacer-len");
    const spacerOut = document.getElementById("tool-output-spacer");

    spacerRun?.addEventListener("click", async () => {
      spacerOut.textContent = "Running…";
      try {
        const out = await toolsRun("text_spacer", {
          text: cipherEl.value || "",
          block_length: Number(spacerLen.value || 5)
        });
        spacerOut.textContent = out || "(no output)";
      } catch {
        spacerOut.textContent = "Error running spacer.";
      }
    });

    // ===========================
    // Remove spaces / punctuation
    // ===========================
    const rsBtn = document.getElementById("run-remove-spaces");
    const rsOut = document.getElementById("tool-output-remove-spaces");

    rsBtn?.addEventListener("click", async () => {
      rsOut.textContent = "Running…";
      try {
        const out = await toolsRun("remove_spaces", { text: cipherEl.value || "" });
        rsOut.textContent = out || "(no output)";
      } catch {
        rsOut.textContent = "Error running remove spaces.";
      }
    });

    const rpBtn = document.getElementById("run-remove-punct");
    const rpOut = document.getElementById("tool-output-remove-punct");

    rpBtn?.addEventListener("click", async () => {
      rpOut.textContent = "Running…";
      try {
        const out = await toolsRun("remove_punctuation", { text: cipherEl.value || "" });
        rpOut.textContent = out || "(no output)";
      } catch {
        rpOut.textContent = "Error running remove punctuation.";
      }
    });

    // ===========================
    // Breaker
    // ===========================
    const breakerTypeEl = document.getElementById("breaker-type");
    const breakerKnownEl = document.getElementById("breaker-known");
    const breakerRunBtn = document.getElementById("run-breaker");
    const breakerCopyBtn = document.getElementById("copy-breaker");
    const breakerOutEl = document.getElementById("breaker-output");

    breakerRunBtn?.addEventListener("click", async () => {
      breakerOutEl.textContent = "Running…";
      try {
        const data = await breakerRunRequest({
          text: cipherEl.value || "",
          cipher_type: breakerTypeEl?.value || "vigenere",
          known_plaintext: breakerKnownEl?.value || ""
        });

        const cipher = data?.cipher ?? "—";
        const key = (data?.key === null || data?.key === undefined || data?.key === "") ? "—" : String(data.key);
        const plain = data?.text ?? "";

        breakerOutEl.textContent =
          `Cipher: ${cipher}\n` +
          `Key: ${key}\n\n` +
          `${plain || "(no output)"}`;
      } catch (e) {
        breakerOutEl.textContent = "Error running breaker.";
      }
    });

    breakerCopyBtn?.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText((breakerOutEl.textContent || "").trim());
        setStatus("Copied");
        setTimeout(() => setStatus("—"), 900);
      } catch {}
    });

    // ===========================
    // Cipher Image upload/delete (ONE BUTTON FLOW)
    // - Click "Upload image" -> opens file picker
    // - After picking a file, it auto-uploads
    // ===========================
    const imgInput = document.getElementById("cipher-image-input");
    const imgUploadBtn = document.getElementById("upload-cipher-image");
    const imgDeleteBtn = document.getElementById("delete-cipher-image");
    const imgStatus = document.getElementById("cipher-image-status");

    const imgWrap = document.getElementById("cipher-image-wrap");
    const img = document.getElementById("cipher-img");

    function showCipherImage(src) {
      if (!imgWrap || !img) return;
      img.src = src;
      imgWrap.style.display = "grid";
    }

    function hideCipherImage() {
      if (!imgWrap || !img) return;
      img.src = "";
      imgWrap.style.display = "none";
    }

    async function uploadSelectedImage() {
      const file = imgInput?.files?.[0];
      if (!file) return;

      if (imgStatus) imgStatus.textContent = "Uploading…";
      if (imgUploadBtn) imgUploadBtn.disabled = true;

      try {
        const fd = new FormData();
        fd.append("image", file);

        const res = await fetch(`/workspaces/{{ ws.id }}/image`, { method: "POST", body: fd });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "upload failed");

        // assumes your image-serving route is /uploads/<filename>
        const url = `/uploads/${encodeURIComponent(data.filename)}?v=${Date.now()}`;
        showCipherImage(url);

        const updatedEl = document.getElementById("updated-at");
        if (updatedEl && data.updated_at) updatedEl.textContent = data.updated_at;

        if (imgStatus) imgStatus.textContent = "Uploaded ✓";
        setTimeout(() => { if (imgStatus) imgStatus.textContent = "—"; }, 1200);
      } catch {
        if (imgStatus) imgStatus.textContent = "Upload failed";
        setTimeout(() => { if (imgStatus) imgStatus.textContent = "—"; }, 1600);
      } finally {
        if (imgUploadBtn) imgUploadBtn.disabled = false;
        // reset input so selecting the same file again triggers change
        if (imgInput) imgInput.value = "";
      }
    }

    // One-button UX:
    // 1) click upload -> open picker
    // 2) on file chosen -> upload
    imgUploadBtn?.addEventListener("click", () => imgInput?.click());
    imgInput?.addEventListener("change", uploadSelectedImage);

    imgDeleteBtn?.addEventListener("click", async () => {
      if (imgStatus) imgStatus.textContent = "Removing…";

      try {
        const res = await fetch(`/workspaces/{{ ws.id }}/image/delete`, { method: "POST" });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "delete failed");

        hideCipherImage();

        const updatedEl = document.getElementById("updated-at");
        if (updatedEl && data.updated_at) updatedEl.textContent = data.updated_at;

        if (imgStatus) imgStatus.textContent = "Removed ✓";
        setTimeout(() => { if (imgStatus) imgStatus.textContent = "—"; }, 1200);
      } catch {
        if (imgStatus) imgStatus.textContent = "Remove failed";
        setTimeout(() => { if (imgStatus) imgStatus.textContent = "—"; }, 1600);
      }
    });

    // If workspace already has an image, show it on load
    {% if ws.cipher_image_filename %}
      showCipherImage("{{ url_for('uploaded_file', filename=ws.cipher_image_filename) }}");
    {% endif %}

    // ===========================
    // Image zoom (preview)
    // ===========================
    const modal = document.getElementById("img-modal");
    const modalImg = document.getElementById("img-modal-img");
    const closeBtn = document.getElementById("img-close");

    function openImgModal(src) {
      if (!modal || !modalImg) return;
      modalImg.src = src;
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
    }
    function closeImgModal() {
      if (!modal) return;
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
    }

    img?.addEventListener("click", () => openImgModal(img.src));
    closeBtn?.addEventListener("click", closeImgModal);
    modal?.addEventListener("click", (e) => {
      if (e.target === modal) closeImgModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeImgModal();
    });

    // ===========================
    // Default tool state
    // ===========================
    showTool("frequency");
    setStatus("—");
  </script>
</body>
</html>
