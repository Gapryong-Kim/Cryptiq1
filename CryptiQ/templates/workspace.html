<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Cipher Lab â€” Workspace</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<style>
  html { overflow-y: scroll; scrollbar-gutter: stable both-edges; }

  /* =============== Shell =============== */
  .ws-shell{
    min-height: calc(100dvh - 80px);
    display: grid;
    grid-template-rows: 1fr;
    padding: 0;
    box-sizing: border-box;
  }

  .ws-card{
    width: 98vw;
    max-width: none;
    margin: 0;
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 0;
    box-shadow: none;
  }

  /* =============== Top Toolbar =============== */
  .ws-topbar{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 14px;
    border-bottom: 1px solid var(--line);
    background: linear-gradient(0deg, rgba(0,0,0,0.04), transparent);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .ws-titlewrap{
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }

  .ws-dot{
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 10px var(--accent-soft);
    flex: 0 0 auto;
  }

  .ws-title{
    margin: 0;
    font-size: 1rem;
    font-weight: 800;
    color: var(--text);
    letter-spacing: .2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .ws-sub{
    color: var(--muted);
    font-size: .86rem;
    margin-left: 8px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .ws-tools{
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .tb-btn{
    padding: 9px 12px;
    border-radius: 999px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 700;
    font-size: .86rem;
    cursor: pointer;
    transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .06s ease;
    letter-spacing: .02em;
    white-space: nowrap;
  }

  .tb-btn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .tb-btn:active{ transform: translateY(1px); }

  .tb-btn.active{
    background: var(--accent);
    border-color: var(--accent);
    color: #0f0f0f;
    box-shadow: 0 6px 16px rgba(0,0,0,.35);
  }

  .tb-btn.primary{
    background: var(--accent);
    border-color: var(--accent);
    color: #0f0f0f;
  }

  .tb-btn.primary:hover{
    background: var(--accent-strong);
    border-color: var(--accent-strong);
    box-shadow: 0 8px 20px rgba(0,0,0,.35);
  }

  .ws-status{
    color: var(--muted);
    font-size: .86rem;
    min-width: 88px;
    text-align: right;
  }

  /* =============== Main Grid =============== */
  .ws-grid{
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(460px, 600px);
    gap: 16px;
    padding: 16px;
    box-sizing: border-box;
    align-items: stretch;
  }

  @media (max-width: 980px){
    .ws-grid{ grid-template-columns: 1fr; }
  }

  /* =============== Panels =============== */
  .ws-panel{
    background: var(--panel-2);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 14px;
  }

  .ws-panel h3{
    margin: 0 0 10px;
    color: var(--accent);
    font-size: .98rem;
    letter-spacing: .2px;
  }

  /* =============== Doc Area =============== */
  .doc-wrap{
    display: grid;
    grid-template-rows: auto auto 1fr auto;
    gap: 10px;
  }

  .doc-meta{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
    color: var(--muted);
    font-size: .86rem;
  }

  .doc-title{
    width: 100%;
    box-sizing: border-box;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 10px;
    padding: 12px 12px;
    color: var(--text);
    font-weight: 800;
    font-size: 1rem;
  }

  .doc-title:focus{
    outline: none;
    border-color: var(--accent);
    background: var(--input-focus);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .doc-text{
    width: 100%;
    min-height: 380px;
    box-sizing: border-box;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 12px 12px;
    color: var(--text);
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: 15px;
    line-height: 1.55;
    resize: vertical;
    white-space: pre-wrap;
    word-break: break-word;
    scrollbar-gutter: stable both-edges;
  }

  .doc-text:focus{
    outline: none;
    border-color: var(--accent);
    background: var(--input-focus);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .doc-actions{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
  }

  .mini-btn{
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 700;
    cursor: pointer;
    transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
  }
  .mini-btn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  /* =============== Right Sidebar =============== */
  .cipher-side{
    display: grid;
    gap: 12px;
    position: sticky;
    top: 74px;
  }

  @media (max-width: 980px){
    .cipher-side{ position: relative; top: 0; }
  }

  .cipher-text{
    width: 100%;
    min-height: 420px;
    box-sizing: border-box;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 14px;
    color: var(--text);
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: 15px;
    line-height: 1.6;
    resize: vertical;
  }

  .cipher-text:focus{
    outline: none;
    border-color: var(--accent);
    background: var(--input-focus);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .hint{
    color: var(--muted);
    font-size: .86rem;
    line-height: 1.45;
  }

  /* =============== Tool Panel (Dock) =============== */
  .tool-panel{ margin-top: 12px; }
  .tool-card{ display: none; }
  .tool-card.active{ display: grid; gap: 10px; }

  .tool-row{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  select, input[type="number"], input[type="text"]{
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    color: var(--text);
    border-radius: 10px;
    padding: 10px 12px;
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: 14px;
    transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
  }
  select:focus, input:focus{
    outline: none;
    border-color: var(--accent);
    background: var(--input-focus);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .run-btn{
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--accent);
    background: var(--accent);
    color: #0f0f0f;
    font-weight: 800;
    cursor: pointer;
    transition: background .15s ease, box-shadow .18s ease, transform .06s ease;
  }
  .run-btn:hover{
    background: var(--accent-strong);
    box-shadow: 0 8px 20px rgba(0,0,0,.35);
  }
  .run-btn:active{ transform: translateY(1px); }

  /* CoLab toggle states */
  .run-btn.secondary{
    background: var(--accent);
    border-color: var(--accent);
    color: #0f0f0f;
  }
  .run-btn.secondary:hover{
    background: var(--accent-strong);
    border-color: var(--accent-strong);
  }

  .run-btn.danger{
    background: transparent;
    border-color: var(--line-2);
    color: var(--text);
  }
  .run-btn.danger:hover{
    border-color: rgba(255,255,255,0.25);
  }

  .result{
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 12px 12px;
    color: var(--text);
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: 14px;
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 60px;
  }

  /* =============== Substitution MVP =============== */
  .sub-grid{
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(46px, 1fr));
    gap: 10px;
  }

  .sub-box{
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 8px 6px;
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 12px;
  }

  .sub-top{
    color: var(--text-dim);
    font-size: .82rem;
    font-weight: 900;
    text-transform: lowercase;
  }

  .sub-arrow{
    font-size: .75rem;
    color: var(--muted);
    opacity: .8;
  }

  .sub-input{
    width: 36px;
    height: 34px;
    text-align: center;
    border: 1px solid var(--input-border);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text);
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: 15px;
    transition: .18s ease;
  }
  .sub-input:focus{
    outline: none;
    border-color: var(--accent);
    background: var(--input-focus);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .helper{
    display: flex;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
    border-top: 1px dashed var(--line);
    padding-top: 10px;
    color: var(--muted);
    font-size: .86rem;
  }

  /* =========================================================
     MOBILE TOPBAR OVERRIDE
     ========================================================= */
  @media (max-width: 640px){
    html, body,
    .ws-shell,
    .ws-card,
    .ws-topbar,
    .ws-grid,
    .ws-panel,
    .doc-wrap,
    .cipher-side{
      overflow-x: hidden !important;
    }

    .ws-topbar{
      justify-content: flex-start !important;
      flex-wrap: nowrap !important;
      gap: 8px !important;

      overflow-x: auto !important;
      overflow-y: hidden !important;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x;
      scrollbar-width: none;
      padding-bottom: 10px;
    }
    .ws-topbar::-webkit-scrollbar{ display: none; }

    .ws-titlewrap{
      width: auto !important;
      min-width: max-content !important;
      flex: 0 0 auto !important;
      gap: 6px !important;
    }

    .ws-tools{
      width: auto !important;
      min-width: max-content !important;
      flex: 0 0 auto !important;

      display: flex !important;
      flex-wrap: nowrap !important;
      justify-content: flex-start !important;
      gap: 8px !important;

      overflow: visible !important;
      margin-left: 4px !important;
    }

    .ws-tools .tb-btn{
      flex: 0 0 auto;
      white-space: nowrap;
    }

    .doc-actions, .cipher-upload-actions { justify-content: flex-start; }
    .mini-btn, .img-btn { width: 100%; }
  }

  /* =========================================================
     Upload image buttons + preview
     ========================================================= */
  .cipher-upload{
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px dashed var(--line);
    display: grid;
    gap: 10px;
  }

  .cipher-upload-row{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  #cipher-image-input{
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .cipher-upload-actions{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  .img-btn{
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 800;
    cursor: pointer;
    transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .06s ease;
    white-space: nowrap;
  }
  .img-btn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }
  .img-btn:active{ transform: translateY(1px); }

  .img-btn.primary{
    background: var(--accent);
    border-color: var(--accent);
    color: #0f0f0f;
  }
  .img-btn.primary:hover{
    background: var(--accent-strong);
    border-color: var(--accent-strong);
    box-shadow: 0 8px 20px rgba(0,0,0,.35);
  }

  .img-btn.danger{
    border-color: rgba(255, 107, 107, 0.35);
    color: #ff8b8b;
  }
  .img-btn.danger:hover{
    background: rgba(255, 107, 107, 0.12);
    border-color: #ff7070;
    box-shadow: 0 0 0 2px rgba(255, 112, 112, 0.18);
  }

  .img-btn:disabled{
    opacity: 0.45;
    cursor: not-allowed;
    box-shadow: none !important;
  }

  .cipher-upload-status{
    color: var(--muted);
    font-size: .86rem;
    min-height: 18px;
  }

  .cipher-img-wrap{
    display: none;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px dashed var(--line);
    gap: 10px;
  }

  .cipher-img{
    width: 100%;
    max-height: 360px;
    border-radius: 12px;
    border: 1px solid var(--line);
    object-fit: contain;
    background: rgba(255,255,255,0.02);
    cursor: zoom-in;
  }

  /* ===========================
     Split-scroll layout
     =========================== */
  @media (min-width: 981px){
    .ws-shell{
      height: calc(100dvh - 80px);
      overflow: hidden;
    }

    .ws-grid{
      height: calc(100dvh - 80px - 58px);
      overflow: hidden;
    }

    .ws-grid > .ws-panel{
      height: 100%;
      overflow-y: auto;
      scrollbar-gutter: stable both-edges;
    }

    .cipher-side{
      position: relative;
      top: auto;
      height: 100%;
      overflow-y: auto;
      scrollbar-gutter: stable both-edges;
    }

    .cipher-side .ws-panel{ height: auto; }
  }

  @media (max-width: 980px){
    .ws-shell{ height: auto; overflow: visible; }
    .ws-grid{ height: auto; overflow: visible; }
    .ws-grid > .ws-panel{ height: auto; overflow: visible; }
    .cipher-side{ height: auto; overflow: visible; }
  }

  /* =========================================================
     Image tabs + kebab menu
     ========================================================= */
  .cipher-tabs{
    display: none;
    margin-top: 10px;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    overflow: visible;
  }
  .cipher-tabs.show{ display: flex; }

  .cipher-tab-wrap{
    position: relative;
    display: inline-flex;
    overflow: visible;
    z-index: 1;
  }

  .cipher-tab{
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 800;
    font-size: .82rem;
    cursor: pointer;
    transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
    max-width: 100%;
  }
  .cipher-tab:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }
  .cipher-tab.active{
    background: var(--accent);
    border-color: var(--accent);
    color: #0f0f0f;
  }

  .cipher-tab-label{
    display: inline-block;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .cipher-tab-more{
    background: none;
    border: none;
    padding: 0 4px;
    margin-left: 2px;
    color: inherit;
    font-weight: 900;
    font-size: 1rem;
    line-height: 1;
    cursor: pointer;
    opacity: .6;
  }
  .cipher-tab-more:hover{ opacity: 1; }

  .cipher-menu-item{
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 10px 10px;
    border-radius: 10px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--text);
    font-weight: 800;
    cursor: pointer;
    text-align: left;
  }
  .cipher-menu-item:hover{
    background: var(--input-hover);
    border-color: var(--line-2);
  }
  .cipher-menu-item.danger{
    color: #ff8b8b;
  }
  .cipher-menu-item.danger:hover{
    background: rgba(255, 107, 107, 0.12);
    border-color: rgba(255, 107, 107, 0.35);
  }

  .cipher-tab-input{
    width: 190px;
    max-width: 62vw;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    color: var(--text);
    border-radius: 10px;
    padding: 8px 10px;
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: 13px;
    font-weight: 800;
  }
  .cipher-tab-input:focus{
    outline: none;
    border-color: var(--accent);
    background: var(--input-focus);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  /* ===== Confirm modal ===== */
  .cmodal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9000;
  }
  .cmodal.open{ display: flex; }

  .cmodal-backdrop{
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  .cmodal-box{
    position: relative;
    width: min(520px, 92vw);
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    padding: 12px;
    display: grid;
    gap: 10px;
    animation: cmodalPop .12s ease-out;
  }
  @keyframes cmodalPop{
    from { transform: translateY(6px) scale(.98); opacity: .6; }
    to   { transform: translateY(0) scale(1); opacity: 1; }
  }

  .cmodal-top{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 4px 4px 0;
  }

  .cmodal-title{
    color: var(--text);
    font-weight: 900;
    font-size: .98rem;
  }

  .cmodal-x{
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    border-radius: 10px;
    padding: 8px 10px;
    cursor: pointer;
  }
  .cmodal-x:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .cmodal-body{
    color: var(--muted);
    line-height: 1.45;
    padding: 0 4px;
  }

  .cmodal-actions{
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 6px 4px 2px;
    flex-wrap: wrap;
  }

  .cmodal-btn{
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    cursor: pointer;
  }
  .cmodal-btn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .cmodal-btn.ghost{ opacity: .95; }

  .cmodal-btn.danger{
    border-color: rgba(255, 107, 107, 0.35);
    color: #ff8b8b;
  }
  .cmodal-btn.danger:hover{
    background: rgba(255, 107, 107, 0.12);
    border-color: #ff7070;
    box-shadow: 0 0 0 2px rgba(255, 112, 112, 0.18);
  }

  /* floating menu (portal) */
  .cipher-float-menu{
    position: fixed;
    min-width: 170px;
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 12px;
    box-shadow: 0 18px 50px rgba(0,0,0,.45);
    padding: 6px;
    display: none;
    z-index: 99999;
  }
  .cipher-float-menu.open{ display: grid; gap: 4px; }

  /* =========================================================
     AUTOSAVE PILL + SPINNER
     ========================================================= */
  .autosave-pill{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 5px 10px;
    border-radius: 999px;
    border: 1px solid var(--line-2);
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    font-weight: 800;
    font-size: .78rem;
  }

  .autosave-pill.saving{
    color: var(--text);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .spinner{
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,.18);
    border-top-color: var(--accent);
    display: none;
    animation: spin .75s linear infinite;
  }

  .autosave-pill.saving .spinner{ display: inline-block; }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* =========================================================
     Labs Pro upsell modal
     ========================================================= */
  .promodal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 8000;
  }
  .promodal.open{ display: flex; }

  .promodal-backdrop{
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.68);
    backdrop-filter: blur(7px);
  }

  .promodal-box{
    position: relative;
    width: min(560px, 92vw);
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: 0 22px 70px rgba(0,0,0,.6);
    overflow: hidden;
    animation: cmodalPop .12s ease-out;
  }

  .promodal-hero{
    padding: 16px 16px 12px;
    border-bottom: 1px solid var(--line);
    background:
      radial-gradient(70% 60% at 15% 20%, rgba(0,255,213,.16) 0%, rgba(0,255,213,0) 60%),
      radial-gradient(55% 50% at 85% 10%, rgba(0,255,213,.10) 0%, rgba(0,255,213,0) 55%);
  }

  .promodal-top{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .promodal-title{
    font-weight: 1000;
    color: var(--text);
    font-size: 1.05rem;
    letter-spacing: .1px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .pro-chip{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    background: var(--accent);
    color: #0f0f0f;
    font-weight: 1000;
    font-size: .78rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    border: 1px solid color-mix(in oklab, var(--accent) 70%, black);
    box-shadow: 0 0 0 3px var(--accent-soft);
    position: relative;
    overflow: hidden;
  }

  .pro-chip::after{
    content:"";
    position:absolute;
    inset:-40% -70%;
    background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.28) 45%, transparent 70%);
    transform: translateX(-80%);
    animation: proShine 2.6s ease-in-out infinite;
  }
  @keyframes proShine{
    0%{ transform: translateX(-80%); }
    55%{ transform: translateX(80%); }
    100%{ transform: translateX(80%); }
  }

  .promodal-x{
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    border-radius: 12px;
    padding: 8px 10px;
    cursor: pointer;
  }
  .promodal-x:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .promodal-body{
    padding: 14px 16px 10px;
    color: var(--text-dim);
    line-height: 1.55;
  }

  .promodal-list{
    margin: 10px 0 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 8px;
  }
  .promodal-list li{
    display: flex;
    gap: 10px;
    align-items: flex-start;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    font-weight: 800;
  }
  .promodal-list .tick{
    color: var(--accent);
    font-weight: 1000;
  }

  .promodal-actions{
    padding: 12px 16px 16px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-wrap: wrap;
  }

  .promodal-btn{
    padding: 11px 14px;
    border-radius: 12px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 1000;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  .promodal-btn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .promodal-btn.primary{
    background: var(--accent);
    color: #0f0f0f;
    border-color: var(--accent);
    box-shadow: 0 10px 26px rgba(0,0,0,0.35), 0 0 0 3px var(--accent-soft);
  }
  .promodal-btn.primary:hover{ filter: brightness(1.05); transform: translateY(-1px); }

  /* =========================================================
     HISTORY MODAL (Labs Pro)
     ========================================================= */
  .hmodal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 8500;
  }
  .hmodal.open{ display: flex; }

  .hmodal-backdrop{
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  .hmodal-box{
    position: relative;
    width: min(760px, 94vw);
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    overflow: hidden;
    animation: cmodalPop .12s ease-out;
  }

  .hmodal-top{
    padding: 14px 14px 10px;
    border-bottom: 1px solid var(--line);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }
  .hmodal-title{
    font-weight: 1000;
    color: var(--text);
    font-size: 1rem;
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .hmodal-x{
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    border-radius: 12px;
    padding: 8px 10px;
    cursor: pointer;
  }
  .hmodal-x:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .hmodal-body{
    padding: 12px 14px 10px;
    color: var(--muted);
    display: grid;
    gap: 10px;
  }

  .hlist{
    margin: 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 10px;
    max-height: min(60vh, 520px);
    overflow: auto;
    scrollbar-gutter: stable both-edges;
  }

  .hitem{
    border: 1px solid var(--line);
    border-radius: 14px;
    background: rgba(255,255,255,0.03);
    padding: 10px 12px;
    display: grid;
    gap: 10px;
  }

  .hrow{
    display: flex;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
    align-items: baseline;
  }

  .hwhen{
    color: var(--text);
    font-weight: 900;
    font-size: .92rem;
  }
  .hmeta{
    color: var(--muted);
    font-weight: 800;
    font-size: .82rem;
  }

  .hactions{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .hbtn{
    padding: 9px 12px;
    border-radius: 12px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    cursor: pointer;
  }
  .hbtn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .hbtn.primary{
    background: var(--accent);
    border-color: var(--accent);
    color: #0f0f0f;
  }
  .hbtn.primary:hover{
    background: var(--accent-strong);
    border-color: var(--accent-strong);
    box-shadow: 0 8px 20px rgba(0,0,0,.35);
    transform: translateY(-1px);
  }

  .hstatus{
    font-size: .86rem;
    color: var(--muted);
    min-height: 18px;
  }

  /* =========================================================
     CoLab modal (sharing + collaborators)
     ========================================================= */
  .colab{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 8600;
  }
  .colab.open{ display: flex; }

  .colab-backdrop{
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.68);
      backdrop-filter: blur(7px);
      -webkit-backdrop-filter: blur(7px);
  }

  .colab-box{
    position: relative;
    width: min(760px, 94vw);
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: 0 22px 70px rgba(0,0,0,.6);
    overflow: hidden;
    animation: cmodalPop .12s ease-out;
  }

  .colab-hero{
    padding: 14px 16px 12px;
    border-bottom: 1px solid var(--line);
    background:
      radial-gradient(70% 60% at 15% 20%, rgba(0,255,213,.16) 0%, rgba(0,255,213,0) 60%),
      radial-gradient(55% 50% at 85% 10%, rgba(0,255,213,.10) 0%, rgba(0,255,213,0) 55%);
  }

  .colab-top{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .colab-title{
    font-weight: 1000;
    color: var(--text);
    font-size: 1.05rem;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .colab-x{
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    border-radius: 12px;
    padding: 8px 10px;
    cursor: pointer;
  }
  .colab-x:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .colab-body{
    padding: 14px 16px 16px;
    display: grid;
    gap: 12px;
    color: var(--muted);
  }

  .colab-row{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
  }

  .colab-chip{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--line-2);
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    font-weight: 900;
    font-size: .78rem;
  }
  .colab-chip.on{
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
    color: var(--text);
  }

  .colab-actions{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .colab-linkbox{
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.03);
    border-radius: 14px;
    padding: 12px;
    display: grid;
    gap: 10px;
  }

  .colab-linkrow{
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .colab-link{
    flex: 1;
    min-width: 220px;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 10px 12px;
    color: var(--text);
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: 13px;
  }

  .colab-divider{
    height: 1px;
    background: var(--line);
    opacity: .9;
    margin: 2px 0 0;
  }

  .colab-list{
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 10px;
    max-height: min(46vh, 420px);
    overflow: auto;
    scrollbar-gutter: stable both-edges;
  }

  .colab-item{
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.03);
    border-radius: 14px;
    padding: 10px 12px;
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  .colab-who{
    display: grid;
    gap: 2px;
    min-width: 220px;
  }
  .colab-name{
    color: var(--text);
    font-weight: 1000;
    font-size: .95rem;
  }
  .colab-meta{
    color: var(--muted);
    font-weight: 800;
    font-size: .82rem;
  }

  .colab-item-actions{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-end;
    align-items: center;
  }

  .colab-status{
    min-height: 18px;
    font-size: .86rem;
    color: var(--muted);
  }

  .colab-warn{
    border: 1px solid rgba(255, 193, 7, 0.35);
    background: rgba(255, 193, 7, 0.08);
    color: #ffd36b;
    border-radius: 14px;
    padding: 10px 12px;
    font-weight: 900;
    font-size: .86rem;
    display: none;
  }
  .colab-warn.show{ display:block; }

  /* role controls */
  .role-wrap{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .role-label{
    color: var(--muted);
    font-weight: 900;
    font-size: .78rem;
    letter-spacing: .02em;
  }
  .role-select{
    padding: 9px 10px;
    border-radius: 12px;
    border: 1px solid var(--line-2);
    background: rgba(255,255,255,0.02);
    color: var(--text);
    font-weight: 900;
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: 13px;
  }
  .role-select:focus{
    outline:none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }
  .role-badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border: 1px solid var(--line-2);
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    font-weight: 1000;
    font-size: .75rem;
    letter-spacing:.02em;
  }
  .role-badge.owner{
    border-color: rgba(255, 215, 0, 0.35);
    color: #ffd36b;
    background: rgba(255, 215, 0, 0.08);
  }

  /* =========================================================
     PRO toolbar button style (single source of truth)
     ========================================================= */
  .tb-btn.pro{
    position: relative;
    background: linear-gradient(135deg,
      color-mix(in oklab, var(--accent) 88%, white),
      var(--accent)
    );
    border: 1px solid rgba(255, 215, 0, 0.25);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.04),
      0 8px 22px rgba(0,0,0,0.35);
    color: #0b0b0b;
    font-weight: 900;
  }

  .tb-btn.pro:hover{
    border-color: rgba(255, 215, 0, 0.45);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,0.06),
      0 10px 28px rgba(0,0,0,0.45);
  }

  .tb-btn.pro:first-of-type{
    position: relative;
    margin-left: 14px;
  }
  .tb-btn.pro:first-of-type::before{
    content: "";
    position: absolute;
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 60%;
    background: linear-gradient(
      to bottom,
      transparent,
      rgba(255, 200, 0, 0.35),
      transparent
    );
  }

  /* =========================================================
     Image Lightbox (true fullscreen)
     ========================================================= */
  .img-lightbox{
    position: fixed;
    inset: 0;
    z-index: 99999;
    background: rgba(0,0,0,.85);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 10px;
    box-sizing: border-box;
  }
  .img-lightbox.open{ display: flex; }

  .img-lightbox-img{
    width: min(96vw, 1400px);
    height: min(92vh, 900px);
    max-width: 96vw;
    max-height: 92vh;
    object-fit: contain;
    display: block;
    border-radius: 12px;
    background: #111;
  }

  .img-lightbox-close{
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 100000;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.55);
    color: #fff;
    cursor: pointer;
  }

  /* =========================================================
     Labs Tour (single deduped block)
     ========================================================= */
  .tour-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    z-index: 9000;
  }
  .tour-overlay.open{ display:block; }

  .tour-highlight{
    position: fixed;
    pointer-events: none;
    z-index: 9001;
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.32);
    border: 2px solid rgba(0,255,209,0.28);
    outline: 1px solid rgba(0,255,209,0.14);
    border-radius: 14px;
    transition:
      left .16s ease,
      top .16s ease,
      width .16s ease,
      height .16s ease,
      border-radius .16s ease;
    will-change: left, top, width, height;
  }

  .tour-card{
    position: fixed;
    width: min(360px, calc(100vw - 24px));
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.55);
    padding: 14px 14px 12px;
    z-index: 9002;
    transition: none; /* no chasing */
  }

  .tour-title{
    font-weight: 1000;
    color: var(--accent);
    margin: 0 0 6px;
    font-size: 1.02rem;
  }

  .tour-body{
    margin: 0 0 10px;
    color: var(--text-dim);
    line-height: 1.5;
    font-size: 0.95rem;
  }

  .tour-actions{
    display:flex;
    justify-content: space-between;
    gap:10px;
    flex-wrap: wrap;
    align-items:center;
  }
  .tour-actions .left,
  .tour-actions .right{
    display:flex;
    gap:8px;
    align-items:center;
  }

  .tour-btn{
    padding: 9px 11px;
    border-radius: 12px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 950;
    cursor: pointer;
    transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .08s ease;
  }
  .tour-btn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }
  .tour-btn:active{ transform: translateY(1px); }

  .tour-btn.primary{
    background: var(--accent);
    color: #0f0f0f;
    border-color: var(--accent);
    box-shadow: 0 10px 26px rgba(0,0,0,0.35), 0 0 0 3px var(--accent-soft);
  }
  .tour-btn.primary:hover{ filter: brightness(1.05); transform: translateY(-1px); }
  .tour-btn.primary:active{ transform: translateY(0px); }

  .tour-step{
    color: var(--muted);
    font-weight: 900;
    font-size: .85rem;
  }

  @media (prefers-reduced-motion: reduce){
    .tour-highlight{ transition:none; }
  }

  /* =========================================================
     Rich notes editor
     ========================================================= */
  .rte-bar{
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
    padding:10px 10px;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: rgba(255,255,255,0.03);
  }

  .rte-select{
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    color: var(--text);
    border-radius: 10px;
    padding: 8px 10px;
    font-weight: 900;
    font-size: 13px;
  }

  .rte-btn{
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    cursor: pointer;
    user-select:none;
    transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .06s ease;
  }
  .rte-btn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }
  .rte-btn:active{ transform: translateY(1px); }

  .rte-btn.active{
    background: var(--accent);
    border-color: var(--accent);
    color: #0f0f0f;
  }

  .rte-sep{
    width:1px;
    height:26px;
    background: var(--line);
    opacity:.8;
    margin: 0 2px;
  }
  .rte-grow{ flex:1; }

  .doc-rich{
    width: 100%;
    min-height: 380px;
    box-sizing: border-box;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 12px;
    padding: 12px 12px;
    color: var(--text);
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-size: var(--notes-font-size, 16px);
    line-height: 1.55;
    overflow:auto;
    white-space: normal;
    word-break: break-word;
  }

  .doc-rich:empty::before,
  .doc-rich.is-empty::before{
    content: attr(data-placeholder);
    color: var(--muted);
    opacity: .8;
    pointer-events: none;
  }

.doc-rich:focus{
    outline: none;
    border-color: var(--accent);
    background: var(--input-focus);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .doc-rich p{ margin: 0 0 10px; }
  .doc-rich ul, .doc-rich ol{ margin: 0 0 10px 22px; }
  .doc-rich a{ color: var(--accent); text-decoration: underline; }
  .doc-rich code{
    font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
    font-size: .95em;
    padding: 2px 6px;
    border-radius: 10px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.04);
  }
  .doc-rich mark{
    background: rgba(255, 235, 59, 0.22);
    color: var(--text);
    padding: 1px 4px;
    border-radius: 6px;
  }

  /* =========================================================
     Link modal (single deduped block)
     ========================================================= */
  #link-modal{
    position: fixed;
    inset: 0;
    display: none;
    place-items: center;
    z-index: 9999;
    padding: 18px;
  }
  #link-modal.open{ display: grid; }

  #link-modal::before{
    content:"";
    position:absolute;
    inset:0;
    background: rgba(0,0,0,.58);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  #link-modal .link-card{
    position: relative;
    width: min(520px, 94vw);
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    box-shadow:
      0 20px 55px rgba(0,0,0,.55),
      0 1px 0 rgba(255,255,255,.06) inset;
    padding: 18px 18px 16px;
    color: var(--text);
    animation: linkPop .14s ease-out;
  }

  @keyframes linkPop{
    from{ transform: translateY(8px) scale(.985); opacity: 0; }
    to  { transform: translateY(0)   scale(1);    opacity: 1; }
  }

  #link-modal .link-head{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }

  #link-modal .link-title{
    font-size: 16px;
    font-weight: 900;
    letter-spacing: .2px;
    margin: 0;
  }

  #link-modal #link-x{
    appearance: none;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color: var(--text);
    font-size: 20px;
    line-height: 1;
    width: 36px;
    height: 36px;
    border-radius: 12px;
    cursor: pointer;
    padding: 0;
    display:flex;
    align-items:center;
    justify-content:center;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }

  #link-modal #link-x:hover{
    background: rgba(255,255,255,.07);
    border-color: rgba(255,255,255,.18);
    transform: translateY(-1px);
  }
  #link-modal #link-x:active{ transform: translateY(0px); }

  #link-modal .link-label{
    display:block;
    font-size: 12px;
    font-weight: 800;
    letter-spacing: .25px;
    color: var(--muted);
    margin: 10px 0 8px;
  }

  #link-modal #link-url{
    width: 100%;
    height: 44px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    color: var(--text);
    padding: 0 12px;
    outline: none;
    box-shadow: 0 1px 0 rgba(255,255,255,.05) inset;
  }

  #link-modal #link-url::placeholder{
    color: rgba(255,255,255,.28);
  }

  #link-modal #link-url:focus{
    /* softer, less neon (matches Pro modal vibe) */
    border-color: rgba(255,255,255,.18);
    background: rgba(0,0,0,.22);
    box-shadow:
      0 0 0 3px rgba(0,198,165,.08),
      0 1px 0 rgba(255,255,255,.05) inset;
  }

  #link-modal .link-actions{
    display:flex;
    justify-content:flex-end;
    gap: 10px;
    margin-top: 14px;
  }

  #link-modal .link-btn{
    height: 40px;
    padding: 0 14px;
    border-radius: 12px;
    font-weight: 900;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    color: var(--text);
    cursor:pointer;
    transition: transform .12s ease, background .12s ease, border-color .12s ease, filter .12s ease;
  }

  #link-modal .link-btn:hover{
    background: rgba(255,255,255,.07);
    border-color: rgba(255,255,255,.18);
    transform: translateY(-1px);
  }
  #link-modal .link-btn:active{ transform: translateY(0px); }

  #link-modal .link-btn.primary{
    background: rgba(0,198,165,.20);
    border-color: rgba(0,198,165,.40);
  }
  #link-modal .link-btn.primary:hover{
    filter: brightness(1.05);
  }

  @media (max-width: 520px){
    #link-modal .link-card{ padding: 16px; border-radius: 14px; }
    #link-modal .link-actions{ flex-direction: column-reverse; }
    #link-modal .link-btn{ width: 100%; }
  }

  /* =========================================================
     Clear notes confirm modal (matches Pro popup aesthetic)
     ========================================================= */
  #clear-notes-modal{
    position: fixed;
    inset: 0;
    display: none;
    place-items: center;
    z-index: 9999;
    padding: 18px;
  }
  #clear-notes-modal.open{ display: grid; }
  #clear-notes-modal::before{
    content:"";
    position:absolute;
    inset:0;
    background: rgba(0,0,0,.58);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }
  #clear-notes-modal .cn-card{
    position: relative;
    width: min(520px, 94vw);
    background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 16px;
    box-shadow: 0 24px 60px rgba(0,0,0,.55);
    padding: 18px 18px 16px;
  }
  #clear-notes-modal .cn-head{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 8px;
  }
  #clear-notes-modal .cn-title{
    font-size: 16px;
    font-weight: 900;
    letter-spacing: .2px;
    margin: 0;
  }
  #clear-notes-modal #cn-x{
    appearance: none;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color: var(--text);
    font-size: 20px;
    line-height: 1;
    width: 36px;
    height: 36px;
    border-radius: 12px;
    cursor: pointer;
    padding: 0;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #clear-notes-modal #cn-x:hover{ background: rgba(255,255,255,.07); }
  #clear-notes-modal .cn-sub{
    margin: 0 0 14px;
    color: rgba(255,255,255,.72);
    font-size: 13px;
    line-height: 1.35;
  }
  #clear-notes-modal .cn-actions{
    display:flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 6px;
  }
  #clear-notes-modal .cn-btn{
    appearance: none;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.04);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 12px;
    font-weight: 800;
    cursor: pointer;
    min-width: 110px;
  }
  #clear-notes-modal .cn-btn.ghost{
    background: transparent;
  }
  #clear-notes-modal .cn-btn.ghost:hover{
    background: rgba(255,255,255,.05);
  }
  #clear-notes-modal .cn-btn.danger{
    background: rgba(255,65,95,.16);
    border-color: rgba(255,65,95,.32);
    color: rgba(255,255,255,.92);
  }
  #clear-notes-modal .cn-btn.danger:hover{
    background: rgba(255,65,95,.22);
  }

</style>



</head>

<body>
  {% include 'base_nav.html' %}

  <main class="ws-shell">
    <section class="ws-card" aria-label="Cipher Workspace">
      <!-- Top Bar -->
      <header class="ws-topbar">
        <div class="ws-titlewrap">
          <span class="ws-dot" aria-hidden="true"></span>
          <h1 class="ws-title">My Cipher Lab</h1>
          <span class="ws-sub" id="ws-id">#{{ ws.id }}</span>
        </div>

        <div class="ws-tools" role="toolbar" aria-label="Workspace tools">
          <button class="tb-btn active" data-tool="frequency" type="button">Frequency</button>
          <button class="tb-btn" data-tool="substitution" type="button">Substitution</button>
          <button class="tb-btn" data-tool="replacer" type="button">Replace</button>
          <button class="tb-btn" data-tool="spacer" type="button">Spacer</button>
          <button class="tb-btn" data-tool="remove_spaces" type="button">No spaces</button>
          <button class="tb-btn" data-tool="remove_punctuation" type="button">No punct</button>
          <button class="tb-btn" data-tool="breaker" type="button">Breaker</button>

          <!-- PRO buttons -->
          <button class="tb-btn pro" id="ws-colab" type="button" title="CoLab (sharing + collaborators)">
            CoLab
            <span class="pro-chip-mini">
              <span class="spark" aria-hidden="true"></span>
              <span class="pro-badge">PRO</span>
            </span>
          </button>

          <button class="tb-btn pro" id="ws-export-pdf" type="button" title="Export this lab as a PDF">
            Export PDF
            <span class="pro-chip-mini">
              <span class="spark" aria-hidden="true"></span>
              <span class="pro-badge">PRO</span>
            </span>
          </button>

          <button class="tb-btn pro" id="ws-clone" type="button" title="Clone this lab">
            Clone
            <span class="pro-chip-mini">
              <span class="spark" aria-hidden="true"></span>
              <span class="pro-badge">PRO</span>
            </span>
          </button>

          <button class="tb-btn pro" id="ws-history" type="button" title="View lab history snapshots">
            History
            <span class="pro-chip-mini">
              <span class="spark" aria-hidden="true"></span>
              <span class="pro-badge">PRO</span>
            </span>
          </button>
        </div>
      </header>

      <div class="ws-grid">
        <!-- Left: Doc + Tool Dock -->
        <div class="ws-panel">
          <div class="doc-wrap">
            <div class="doc-meta">
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                <span style="color:var(--text-dim);font-weight:800;">Notes / Plaintext</span>

                <!-- Autosave indicator -->
                <span class="autosave-pill" id="autosave-pill" aria-live="polite">
                  <span class="spinner" id="autosave-spinner" aria-hidden="true"></span>
                  <span id="autosave-text">Autosave on</span>
                </span>
              </div>

              <div style="color:var(--muted);">
                Updated: <span id="updated-at">{{ ws.updated_at if ws.updated_at else "â€”" }}</span>
              </div>
            </div>

            <input
              id="ws-title-input"
              class="doc-title"
              placeholder="Lab title"
              value="{{ ws.title or 'Untitled Workspace' }}"
            />

            <!-- ===== Notes toolbar ===== -->
<div class="rte-bar" id="notes-rte-bar" aria-label="Notes editor toolbar">
  <select class="rte-select" id="rte-font">
    <option value="Inter">Inter</option>
    <option value="system-ui">System</option>
    <option value="Fira Code">Fira Code</option>
    <option value="JetBrains Mono">JetBrains Mono</option>
    <option value="Georgia">Georgia</option>
  </select>

  <select class="rte-select" id="rte-size">
    <option value="12">12</option>
    <option value="14">14</option>
    <option value="16" selected>16</option>
    <option value="18">18</option>
    <option value="22">22</option>
    <option value="28">28</option>
  </select>

  <span class="rte-sep"></span>

  <button class="rte-btn" type="button" data-cmd="bold" title="Bold"><b>B</b></button>
  <button class="rte-btn" type="button" data-cmd="italic" title="Italic"><i>I</i></button>
  <button class="rte-btn" type="button" data-cmd="underline" title="Underline"><u>U</u></button>
  <button class="rte-btn" type="button" data-cmd="strikeThrough" title="Strike">S</button>

  <span class="rte-sep"></span>

  <button class="rte-btn" type="button" data-cmd="insertUnorderedList" title="Bullets">â€¢ List</button>
  <button class="rte-btn" type="button" data-cmd="insertOrderedList" title="Numbered">1. List</button>
  <button class="rte-btn" type="button" data-cmd="outdent" title="Outdent">â†</button>
  <button class="rte-btn" type="button" data-cmd="indent" title="Indent">â†’</button>

  <span class="rte-sep"></span>

  <button class="rte-btn" type="button" id="rte-link" title="Insert link">Link</button>
  <button class="rte-btn" type="button" id="rte-unlink" title="Remove link">Unlink</button>

  <span class="rte-sep"></span>

  <button class="rte-btn" type="button" id="rte-code" title="Code style">{ }</button>
  <button class="rte-btn" type="button" id="rte-highlight" title="Highlight">Mark</button>

  <span class="rte-sep"></span>

  <button class="rte-btn" type="button" data-cmd="undo" title="Undo">â†º</button>
  <button class="rte-btn" type="button" data-cmd="redo" title="Redo">â†»</button>

  <span class="rte-grow"></span>

  <button class="rte-btn" type="button" id="rte-clear" title="Clear formatting">Clear</button>
</div>

<!-- ===== Notes editor surface ===== -->
<div
  id="ws-notes-editor"
  class="doc-rich"
  contenteditable="true"
  spellcheck="true"
  data-placeholder="Write notes, partial plaintext, hypothesesâ€¦"
>{{ (ws.notes_html_safe or (ws.notes or "")) | safe }}</div>

<!-- fallback (optional). You can remove if you donâ€™t need forms posting notes -->
<textarea id="ws-notes" name="notes" style="display:none;">{{ ws.notes or "" }}</textarea>


            <div class="doc-actions">
              <button class="mini-btn" id="insert-tool-output" type="button">Insert tool output â†’ doc</button>
              <button class="mini-btn" id="copy-doc" type="button">Copy doc</button>
            </div>

            <!-- Tool Dock -->
            <div class="ws-panel tool-panel" style="padding: 14px;">
              <h3>Tool Dock</h3>

              <!-- Frequency -->
              <div class="tool-card active" id="tool-frequency">
                <div class="tool-row">
                  <button class="run-btn" id="run-frequency" type="button">Run frequency</button>
                  <button class="run-btn secondary" id="copy-tool" type="button">Copy output</button>
                </div>
                <div class="result" id="tool-output">Run a tool to see output here.</div>
                <div class="hint">
                  Use this to get an idea of what kind of cipher you're working with.
                </div>
              </div>

              <!-- Substitution -->
              <div class="tool-card" id="tool-substitution">
                <div class="hint">
                  Map plaintext letters (top) â†’ ciphertext letters (input). This MVP applies the mapping live to the cipher text below.
                </div>

                <div class="sub-grid" id="sub-grid"></div>

                <div class="helper">
                  <div>Tip: enter ciphertext letters as <strong>Aâ€“Z</strong> under each marker.</div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="run-btn secondary" id="sub-clear" type="button">Clear mapping</button>
                    <button class="run-btn secondary" id="sub-reset" type="button">Reset view</button>
                    <button class="run-btn" id="sub-frequency" type="button">Freq from cipher</button>
                  </div>
                </div>

                <div class="result" id="sub-freq-output">Frequency output will appear here.</div>
              </div>

              <!-- Text Replacer -->
              <div class="tool-card" id="tool-replacer">
                <div class="tool-row" style="align-items:flex-end;">
                  <div style="display:grid;gap:6px;flex:1;">
                    <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Find</label>
                    <input id="rep-find" type="text" placeholder="e.g. XQ" />
                  </div>
                  <div style="display:grid;gap:6px;flex:1;">
                    <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Replace</label>
                    <input id="rep-with" type="text" placeholder="e.g. TH" />
                  </div>
                  <button class="run-btn" id="run-replace" type="button">Run</button>
                </div>  

                <div class="result" id="tool-output-replace">Output will appear here.</div>
                <div class="hint">Calls <code>/tools/run</code> with <code>tool_type=text_replacer</code>.</div>
              </div>

              <!-- Spacer -->
              <div class="tool-card" id="tool-spacer">
                <div class="tool-row" style="align-items:flex-end;">
                  <div style="display:grid;gap:6px;">
                    <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Block length</label>
                    <input id="spacer-len" type="number" min="1" value="5" style="width:120px;" />
                  </div>
                  <button class="run-btn" id="run-spacer" type="button">Run</button>
                </div>

                <div class="result" id="tool-output-spacer">Output will appear here.</div>
                <div class="hint">Calls <code>/tools/run</code> with <code>tool_type=text_spacer</code>.</div>
              </div>

              <!-- Remove spaces -->
              <div class="tool-card" id="tool-remove_spaces">
                <div class="tool-row">
                  <button class="run-btn" id="run-remove-spaces" type="button">Remove spaces</button>
                </div>
                <div class="result" id="tool-output-remove-spaces">Output will appear here.</div>
              </div>

              <!-- Remove punctuation -->
              <div class="tool-card" id="tool-remove_punctuation">
                <div class="tool-row">
                  <button class="run-btn" id="run-remove-punct" type="button">Remove punctuation</button>
                </div>
                <div class="result" id="tool-output-remove-punct">Output will appear here.</div>
              </div>

              <!-- Breaker -->
              <div class="tool-card" id="tool-breaker">
                <div class="hint">
                  Calls <code>/breaker</code>. Optional fixed-map format: <code>AB=TH, CD=ER</code>
                </div>

                <div class="tool-row" style="align-items:flex-end;">
                  <div style="display:grid;gap:6px;flex:1;min-width:180px;">
                    <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Cipher type</label>
                    <select id="breaker-type">
                      <option value="auto">auto</option>
                      <option value="caesar">caesar</option>
                      <option value="vigenere" selected>vigenere</option>
                      <option value="affine">affine</option>
                      <option value="amsco">amsco</option>
                      <option value="railfence">railfence</option>
                      <option value="columnar">columnar</option>
                      <option value="permutation">permutation</option>
                      <option value="polybius">polybius</option>
                      <option value="substitution">substitution</option>
                      <option value="atbash">atbash</option>
                      <option value="base64">base64</option>
                      <option value="hex">hex</option>
                      <option value="binary">binary</option>
                      <option value="baconian">baconian</option>
                    </select>
                  </div>

                  <button class="run-btn" id="run-breaker" type="button">Run breaker</button>
                  <button class="run-btn secondary" id="copy-breaker" type="button">Copy output</button>
                </div>

                <div style="display:grid;gap:6px;margin-top:6px;">
                  <label style="color:var(--muted);font-weight:800;font-size:.86rem;">Known plaintext / fixed map (optional)</label>
                  <input id="breaker-known" type="text" placeholder="e.g. AB=TH, CD=ER" />
                </div>

                <div class="result" id="breaker-output">Run breaker to see output here.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Cipher View -->
        <aside class="ws-panel cipher-side" aria-label="Cipher sidebar">
          <div class="ws-panel" style="padding:14px;">
            <h3>Cipher View</h3>

            <input id="cipher-image-input" type="file" accept="image/*" style="display:none;" />

            <div class="cipher-upload">
              <div class="cipher-upload-row">
                <div class="cipher-upload-actions">
                  <button class="img-btn primary" id="upload-cipher-image" type="button">Upload image</button>
                  <button class="img-btn danger" id="delete-cipher-image" type="button">Remove</button>
                </div>
              </div>

              <div class="cipher-upload-status" id="cipher-image-status">â€”</div>

              <div class="cipher-tabs" id="cipher-tabs" aria-label="Cipher image tabs"></div>
              <div class="hint" id="cipher-tabs-hint" style="display:none;margin-top:-2px;">
                Tip: double-click a tab to rename it.
              </div>
            </div>

            <div class="cipher-img-wrap" id="cipher-image-wrap" style="display:none;">
              <h3 style="margin-bottom:8px;">Cipher Image</h3>
              <img id="cipher-img" class="cipher-img" src="" alt="Cipher image" />
              <div class="hint">Tap/click to zoom.</div>
            </div>

            <textarea id="cipher-text" class="cipher-text" placeholder="Paste ciphertext hereâ€¦">{{ ws.cipher_text or "" }}</textarea>

            <div class="hint" style="margin-top:8px;">
              Paste your cipher here. Tools read from this box. Save stores it in the workspace.
            </div>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Confirm Delete Modal -->
  <div id="confirm-modal" class="cmodal" aria-hidden="true">
    <div class="cmodal-backdrop" data-close="1"></div>

    <div class="cmodal-box" role="dialog" aria-modal="true" aria-label="Confirm">
      <div class="cmodal-top">
        <div class="cmodal-title" id="cmodal-title">Confirm</div>
        <button class="cmodal-x" id="cmodal-x" type="button" aria-label="Close">âœ•</button>
      </div>

      <div class="cmodal-body" id="cmodal-body">Are you sure?</div>

      <div class="cmodal-actions">
        <button class="cmodal-btn ghost" id="cmodal-cancel" type="button">Cancel</button>
        <button class="cmodal-btn danger" id="cmodal-confirm" type="button">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Labs Pro Modal -->
  <div id="pro-modal" class="promodal" aria-hidden="true">
    <div class="promodal-backdrop" data-pro-close="1"></div>

    <div class="promodal-box" role="dialog" aria-modal="true" aria-label="Labs Pro required">
      <div class="promodal-hero">
        <div class="promodal-top">
          <div class="promodal-title">
            <span class="pro-chip">PRO</span>
            <span id="pro-title">Labs Pro required</span>
          </div>
          <button class="promodal-x" id="pro-x" type="button" aria-label="Close">âœ•</button>
        </div>
      </div>

      <div class="promodal-body">
        <div id="pro-body">Youâ€™ve hit the free limit. Upgrade to Labs Pro to keep going.</div>

        <ul class="promodal-list">
          <li><span class="tick">âœ“</span> Export lab as PDF</li>
          <li><span class="tick">âœ“</span> Clone any lab instantly</li>
          <li><span class="tick">âœ“</span> Lab history (snapshots)</li>
          <li><span class="tick">âœ“</span> Unlimited Labs</li>
          <li><span class="tick">âœ“</span> Unlimited Tabs (images)</li>
          <li><span class="tick">âœ“</span> Pro badge across the site</li>
        </ul>
      </div>

      <div class="promodal-actions">
        <button class="promodal-btn" id="pro-cancel" type="button">Not now</button>
        <a class="promodal-btn primary" id="pro-go" href="/labs-pro">View Labs Pro</a>
      </div>
    </div>
  </div>

  <!-- History Modal (Pro) -->
  <div id="history-modal" class="hmodal" aria-hidden="true">
    <div class="hmodal-backdrop" data-hclose="1"></div>
    <div class="hmodal-box" role="dialog" aria-modal="true" aria-label="Lab history">
      <div class="hmodal-top">
        <div class="hmodal-title">
          <span class="pro-chip" style="box-shadow:none;">PRO</span>
          Lab history
        </div>
        <button class="hmodal-x" id="history-x" type="button" aria-label="Close">âœ•</button>
      </div>
      <div class="hmodal-body">
        <div class="hstatus" id="history-status">â€”</div>
        <ul class="hlist" id="history-list"></ul>
      </div>
    </div>
  </div>

  <!-- CoLab Modal (sharing + collaborators) -->
<div id="colab-modal" class="colab" aria-hidden="true">
  <div class="colab-backdrop" data-colab-close="1"></div>

  <div class="colab-box" role="dialog" aria-modal="true" aria-label="CoLab">
    <div class="colab-hero">
      <div class="colab-top">
        <div class="colab-title">
          <span style="display:inline-flex;align-items:center;gap:10px;">
            <span class="ws-dot" aria-hidden="true" style="width:10px;height:10px;"></span>
            CoLab
          </span>
          <span class="colab-chip" id="colab-chip">Sharing: off</span>
        </div>
        <button class="colab-x" id="colab-x" type="button" aria-label="Close">âœ•</button>
      </div>
    </div>

    <div class="colab-body">
      <div class="colab-status" id="colab-status">â€”</div>

      <div class="colab-warn" id="colab-warn">
        Only the lab owner can enable/disable sharing, change roles, or remove collaborators.
      </div>

      <div class="colab-row">
        <div class="hint" style="max-width: 56ch;">
          Turn on sharing to generate a join link. Anyone with the link who is logged in can join (default role is editor â€” you can change it below).
        </div>

        <div class="colab-actions">
          <!-- âœ… Single toggle button -->
          <button class="run-btn" id="colab-toggle" type="button">Enable sharing</button>
        </div>
      </div>

      <div class="colab-linkbox" id="colab-linkbox" style="display:none;">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
          <div style="font-weight:1000;color:var(--text);">Share link</div>
          <div class="hint">Send this to friends.</div>
        </div>

        <div class="colab-linkrow">
          <input class="colab-link" id="colab-link" readonly value="" />
          <button  class="run-btn danger" id="colab-copy" type="button" style="text-decoration:solid;"x>Copy</button>
          <a class="run-btn" id="colab-open" href="#" target="_blank" rel="noopener">Open</a>
        </div>

        <div class="colab-divider"></div>

        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
          <div style="font-weight:1000;color:var(--text);">Collaborators</div>
          <button class="run-btn secondary" id="colab-refresh" type="button">Refresh</button>
        </div>

        <ul class="colab-list" id="colab-list"></ul>
      </div>
    </div>
  </div>
</div>


  <!-- Image Zoom Lightbox -->
  <div id="img-modal" class="img-lightbox" aria-hidden="true">
    <button id="img-close" class="img-lightbox-close" type="button">Close</button>
    <img id="img-modal-img" class="img-lightbox-img" alt="Cipher image preview">
  </div>
<div class="tour-overlay" id="tour-overlay" aria-hidden="true"></div>
<div class="tour-highlight" id="tour-highlight" style="display:none;"></div>

<div class="tour-card" id="tour-card" style="display:none;" role="dialog" aria-modal="true">
  <div class="tour-title" id="tour-title">â€”</div>
  <p class="tour-body" id="tour-body">â€”</p>

  <div class="tour-actions">
    <div class="left">
      <button class="tour-btn" id="tour-skip" type="button">Skip</button>
      <span class="tour-step" id="tour-step">1/1</span>
    </div>
    <div class="right">
      <button class="tour-btn" id="tour-back" type="button">Back</button>
      <button class="tour-btn primary" id="tour-next" type="button">Next</button>
    </div>
  </div>
</div>
<div id="link-modal" aria-hidden="true">
  <div class="link-card" role="dialog" aria-modal="true" aria-labelledby="link-title">
    <div class="link-head">
      <h3 class="link-title" id="link-title">Add link</h3>
      <button id="link-x" type="button" aria-label="Close">Ã—</button>
    </div>

    <label class="link-label" for="link-url">URL</label>
    <input id="link-url" type="url" inputmode="url" autocomplete="off"
           placeholder="https://example.com" />

    <div class="link-actions">
      <button id="link-cancel" type="button" class="link-btn ghost">Cancel</button>
      <button id="link-confirm" type="button" class="link-btn primary">Insert link</button>
    </div>
  </div>
</div>

<div id="clear-notes-modal" aria-hidden="true">
  <div class="cn-card" role="dialog" aria-modal="true" aria-labelledby="cn-title">
    <div class="cn-head">
      <h3 class="cn-title" id="cn-title">Clear notes?</h3>
      <button id="cn-x" type="button" aria-label="Close">Ã—</button>
    </div>
    <p class="cn-sub">This will permanently delete everything in the notes box.</p>
    <div class="cn-actions">
      <button id="cn-cancel" type="button" class="cn-btn ghost">Cancel</button>
      <button id="cn-confirm" type="button" class="cn-btn danger">Clear notes</button>
    </div>
  </div>
</div>



<script>
  // ===== Plan flag (client-side Pro gating) =====
  // Some endpoints may return 200 even when the feature should be Pro-only.
  const USER_IS_PRO = {{ 'true' if user and (user.get('is_pro') or user.get('pro') or (user.get('plan') in ['pro','labs_pro','labspro','premium'])) else 'false' }};

  // ===========================
  // Viewer / role gate (server truth)
  // ===========================
  const VIEWER_ROLE = "{{ viewer_role }}"; // "owner" | "editor" | "viewer"
  const CAN_EDIT = {{ "true" if viewer_can_edit else "false" }};

  // ===========================
  // Helpers
  // ===========================
  function escapeHtml(str) {
    return (str || "").replace(/[&<>"']/g, s =>
      ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s])
    );
  }

  async function toolsRun(tool_type, payload = {}) {
    const formData = new FormData();
    formData.append("tool_type", tool_type);
    formData.append("text", payload.text ?? "");
    if (payload.block_length != null) formData.append("block_length", String(payload.block_length));
    if (payload.to_replace != null) formData.append("to_replace", payload.to_replace);
    if (payload.replacement != null) formData.append("replacement", payload.replacement);

    const res = await fetch("/tools/run", { method: "POST", body: formData });
    const data = await res.json();
    return data.text || "";
  }

  async function breakerRunRequest(payload = {}) {
    const fd = new FormData();
    fd.append("text", payload.text ?? "");
    fd.append("cipher_type", (payload.cipher_type ?? "vigenere").toLowerCase());
    fd.append("known_plaintext", payload.known_plaintext ?? "");

    const res = await fetch("/breaker", { method: "POST", body: fd });
    const data = await res.json();
    return data;
  }

  function setStatus(msg) {
    const el = document.getElementById("save-status");
    if (el) el.textContent = msg;

    const pill = document.getElementById("autosave-pill");
    const text = document.getElementById("autosave-text");
    if (!pill || !text) return;

    if (!CAN_EDIT) {
      pill.classList.remove("saving");
      text.textContent = "View-only";
      return;
    }

    const m = (msg || "").toLowerCase();

    if (m.includes("saving")) {
      pill.classList.add("saving");
      text.textContent = "Savingâ€¦";
      return;
    }
    if (m.includes("saved")) {
      pill.classList.remove("saving");
      text.textContent = "Saved";
      return;
    }
    if (m.includes("failed")) {
      pill.classList.remove("saving");
      text.textContent = "Save failed";
      return;
    }
    if (m.includes("unsaved")) {
      pill.classList.remove("saving");
      text.textContent = "Unsaved changes";
      return;
    }

    pill.classList.remove("saving");
    text.textContent = "Autosave on";
  }

  // ===== Custom confirm modal (NO window.confirm) =====
  function confirmDeleteModal({
    title = "Confirm",
    message = "Are you sure?",
    confirmText = "Confirm",
    cancelText = "Cancel",
    danger = false
  } = {}) {
    const modal = document.getElementById("confirm-modal");
    const titleEl = document.getElementById("cmodal-title");
    const bodyEl = document.getElementById("cmodal-body");
    const btnCancel = document.getElementById("cmodal-cancel");
    const btnConfirm = document.getElementById("cmodal-confirm");
    const btnX = document.getElementById("cmodal-x");

    if (!modal || !btnCancel || !btnConfirm) return Promise.resolve(false);

    titleEl.textContent = title;
    bodyEl.textContent = message;

    btnCancel.textContent = cancelText;
    btnConfirm.textContent = confirmText;

    btnConfirm.classList.toggle("danger", !!danger);

    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");
    setTimeout(() => btnConfirm.focus(), 0);

    return new Promise((resolve) => {
      const cleanup = (result) => {
        modal.classList.remove("open");
        modal.setAttribute("aria-hidden", "true");

        btnCancel.removeEventListener("click", onCancel);
        btnConfirm.removeEventListener("click", onConfirm);
        btnX?.removeEventListener("click", onCancel);
        modal.removeEventListener("click", onBackdrop);
        document.removeEventListener("keydown", onKey);

        resolve(result);
      };

      const onCancel = () => cleanup(false);
      const onConfirm = () => cleanup(true);

      const onBackdrop = (e) => {
        const closeEl = e.target?.closest?.("[data-close='1']");
        if (closeEl) cleanup(false);
      };

      const onKey = (e) => {
        if (e.key === "Escape") cleanup(false);
        if (e.key === "Enter") cleanup(true);
      };

      btnCancel.addEventListener("click", onCancel);
      btnConfirm.addEventListener("click", onConfirm);
      btnX?.addEventListener("click", onCancel);
      modal.addEventListener("click", onBackdrop);
      document.addEventListener("keydown", onKey);
    });
  }

  // ===== Info modal (single OK) =====
  function infoModal({ title = "Notice", message = "â€”", okText = "OK" } = {}) {
    const modal = document.getElementById("confirm-modal");
    const btnCancel = document.getElementById("cmodal-cancel");
    const btnConfirm = document.getElementById("cmodal-confirm");
    const btnX = document.getElementById("cmodal-x");

    if (!modal || !btnCancel || !btnConfirm) return Promise.resolve();

    const prevCancelDisplay = btnCancel.style.display;
    const prevConfirmDanger = btnConfirm.classList.contains("danger");

    btnCancel.style.display = "none";
    btnConfirm.classList.remove("danger");

    return confirmDeleteModal({
      title,
      message,
      confirmText: okText,
      cancelText: "Cancel"
    }).finally(() => {
      btnCancel.style.display = prevCancelDisplay;
      btnConfirm.classList.toggle("danger", prevConfirmDanger);
      btnX?.blur?.();
    });
  }

  // ===== Labs Pro modal =====
  function openProModal({
    title = "Labs Pro required",
    body = "This feature is available on Labs Pro.",
    href = "/labs-pro",
    cta = "View Labs Pro"
  } = {}) {
    const modal = document.getElementById("pro-modal");
    const titleEl = document.getElementById("pro-title");
    const bodyEl = document.getElementById("pro-body");
    const btnX = document.getElementById("pro-x");
    const btnCancel = document.getElementById("pro-cancel");
    const btnGo = document.getElementById("pro-go");

    if (!modal || !titleEl || !bodyEl || !btnCancel || !btnGo) return;

    titleEl.textContent = title;
    bodyEl.textContent = body;
    btnGo.textContent = cta;
    btnGo.href = href;

    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");

    const close = () => {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      btnCancel.removeEventListener("click", onClose);
      btnX?.removeEventListener("click", onClose);
      modal.removeEventListener("click", onBackdrop);
      document.removeEventListener("keydown", onKey);
    };

    const onClose = () => close();
    const onBackdrop = (e) => {
      const closeEl = e.target?.closest?.("[data-pro-close='1']");
      if (closeEl) close();
    };
    const onKey = (e) => {
      if (e.key === "Escape") close();
    };

    btnCancel.addEventListener("click", onClose);
    btnX?.addEventListener("click", onClose);
    modal.addEventListener("click", onBackdrop);
    document.addEventListener("keydown", onKey);
  }

  // ============================================================
  // PRO / PERMISSION GATES
  // ============================================================
  function isProError(data) {
    const err = String(data?.error || "").toLowerCase();
    return (
      data?.pro_required === true ||
      err.includes("pro") ||
      err.includes("upgrade") ||
      err.includes("payment") ||
      err.includes("subscribe") ||
      err.includes("plan limit") ||
      err.includes("free limit")
    );
  }

  async function handleForbidden(res, data, context = "action") {
    if (res?.status !== 403) return false;
    if (isProError(data)) return false;

    const msg =
      data?.error ||
      (context === "colab"
        ? "You donâ€™t have permission to do that in this lab. Only the owner can manage sharing/collaborators."
        : "You donâ€™t have permission to do that in this lab.");

    await infoModal({ title: "Permission denied", message: msg, okText: "OK" });
    return true;
  }

  function maybeHandleProGate(res, data, context = "action") {
    const status = res?.status;

    if (status === 402) {
      openProModal({
        title: "Labs Pro required",
        body: context === "history"
          ? "Lab history is a Labs Pro feature. Upgrade to browse snapshots and restore older versions."
          : context === "clone"
            ? "Cloning a lab is a Labs Pro feature."
            : context === "export"
              ? "Exporting a lab as PDF is a Labs Pro feature."
              : context === "colab"
                ? "CoLab (sharing + collaborators) is a Labs Pro feature."
                : context === "tabs"
                  ? "Unlimited tabs (images) is a Labs Pro feature."
                  : "This is a Labs Pro feature.",
        href: "/labs-pro",
        cta: "Upgrade to Pro"
      });
      return true;
    }

    if (status === 403 && isProError(data)) {
      openProModal({
        title: "Labs Pro required",
        body: data?.error || "This is a Labs Pro feature.",
        href: "/labs-pro",
        cta: "View Labs Pro"
      });
      return true;
    }

    if (isProError(data)) {
      openProModal({
        title: "Labs Pro required",
        body: data?.error || "This is a Labs Pro feature.",
        href: "/labs-pro",
        cta: "View Labs Pro"
      });
      return true;
    }

    return false;
  }

  // ===========================
  // Toolbar switching
  // ===========================
  const toolButtons = Array.from(document.querySelectorAll(".tb-btn[data-tool]"));
  const toolCards = {
    frequency: document.getElementById("tool-frequency"),
    substitution: document.getElementById("tool-substitution"),
    replacer: document.getElementById("tool-replacer"),
    spacer: document.getElementById("tool-spacer"),
    remove_spaces: document.getElementById("tool-remove_spaces"),
    remove_punctuation: document.getElementById("tool-remove_punctuation"),
    breaker: document.getElementById("tool-breaker"),
  };

  function showTool(name) {
    toolButtons.forEach(b => b.classList.toggle("active", b.dataset.tool === name));
    Object.entries(toolCards).forEach(([k, el]) => {
      if (!el) return;
      el.classList.toggle("active", k === name);
    });
  }

  toolButtons.forEach(btn => btn.addEventListener("click", () => showTool(btn.dataset.tool)));

  // ===========================
  // Notes editor elements
  // ===========================
  const notesHiddenEl = document.getElementById("ws-notes");
  const notesEditorEl = document.getElementById("ws-notes-editor");

  // Ensure any existing links have sane defaults
  postProcessLinks(notesEditorEl);

  // Placeholder (contenteditable isn't truly :empty because browsers inject <br>)
  function updateNotesPlaceholder(){
    if (!notesEditorEl) return;
    const html = (notesEditorEl.innerHTML || "").replace(/\u200B/g, "").trim().toLowerCase();
    const text = (notesEditorEl.textContent || "").replace(/\u200B/g, "").trim();
    const isEmpty = (!text) && (html === "" || html === "<br>" || html === "<div><br></div>" || html === "<p><br></p>");
    notesEditorEl.classList.toggle("is-empty", isEmpty);
  }
  updateNotesPlaceholder();
  notesEditorEl.addEventListener("input", updateNotesPlaceholder);
  notesEditorEl.addEventListener("focus", updateNotesPlaceholder);
  notesEditorEl.addEventListener("blur", updateNotesPlaceholder);

  const titleEl = document.getElementById("ws-title-input");
  const cipherEl = document.getElementById("cipher-text");

  function syncNotesHidden() {
    if (notesHiddenEl && notesEditorEl) notesHiddenEl.value = notesEditorEl.innerHTML;
  }

  function applyViewOnlyUI() {
    if (CAN_EDIT) return;

    if (titleEl) { titleEl.readOnly = true; titleEl.setAttribute("aria-readonly", "true"); }
    if (notesEditorEl) { notesEditorEl.contentEditable = "false"; notesEditorEl.setAttribute("aria-readonly", "true"); }
    if (cipherEl) { cipherEl.readOnly = true; cipherEl.setAttribute("aria-readonly", "true"); }

    const imgUploadBtn = document.getElementById("upload-cipher-image");
    const imgDeleteBtn = document.getElementById("delete-cipher-image");
    if (imgUploadBtn) { imgUploadBtn.disabled = true; imgUploadBtn.title = "View-only"; }
    if (imgDeleteBtn) { imgDeleteBtn.disabled = true; imgDeleteBtn.title = "View-only"; }

    const insertBtn = document.getElementById("insert-tool-output");
    if (insertBtn) { insertBtn.disabled = true; insertBtn.title = "View-only"; }

    const subGrid = document.getElementById("sub-grid");
    subGrid?.querySelectorAll?.("input, button, select")?.forEach?.(el => {
      el.disabled = true;
      el.title = "View-only";
    });
    document.querySelectorAll("#sub-clear, #sub-reset").forEach(el => {
      el.disabled = true;
      el.title = "View-only";
    });

    setStatus("â€”");
  }

  applyViewOnlyUI();

  // ===========================
  // Save + Autosave
  // ===========================
  const AUTOSAVE_DELAY_MS = 900;
  const FORCE_SAVE_MAX_MS = 9000;

  let dirty = false;
  let saving = false;
  let autosaveTimer = null;
  let forceTimer = null;
  let lastSavedPayload = null;
  let saveQueued = false;

  let internalCipherUpdate = false;

  function currentPayload() {
    const notesHtml = notesEditorEl ? notesEditorEl.innerHTML : (notesHiddenEl?.value || "");
    return {
      title: (titleEl?.value || "").trim(),
      notes: notesHtml,
      cipher_text: cipherEl?.value || ""
    };
  }

  function payloadEquals(a, b) {
    if (!a || !b) return false;
    return a.title === b.title && a.notes === b.notes && a.cipher_text === b.cipher_text;
  }

  function markDirty() {
    if (!CAN_EDIT) return;
    if (!dirty) setStatus("Unsaved changes");
    dirty = true;

    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => triggerAutosave("debounce"), AUTOSAVE_DELAY_MS);

    if (!forceTimer) {
      forceTimer = setTimeout(() => {
        forceTimer = null;
        triggerAutosave("force");
      }, FORCE_SAVE_MAX_MS);
    }
  }

  async function triggerAutosave(reason = "auto") {
    if (!CAN_EDIT) return;
    if (saving) { saveQueued = true; return; }

    const payload = currentPayload();
    if (!dirty || payloadEquals(payload, lastSavedPayload)) { dirty = false; return; }

    await saveWorkspace(payload, reason);

    if (saveQueued) {
      saveQueued = false;
      await triggerAutosave("queued");
    }
  }

  async function saveWorkspace(payloadOverride = null, reason = "manual") {
    if (!CAN_EDIT) {
      if (reason === "manual" || reason === "hotkey") {
        await infoModal({
          title: "View-only",
          message: "You have viewer access, so you canâ€™t edit or save changes in this lab.",
          okText: "OK"
        });
      }
      return;
    }

    syncNotesHidden();
    const payload = payloadOverride || currentPayload();

    saving = true;
    setStatus("Savingâ€¦");

    try {
      const fd = new FormData();
      fd.append("title", payload.title);
      fd.append("notes", payload.notes);
      fd.append("cipher_text", payload.cipher_text);

      const res = await fetch(`/workspaces/{{ ws.id }}/save`, { method: "POST", body: fd });

      if (res.status === 401) {
        window.location.href = "{{ url_for('login') }}?next={{ url_for('workspace_view', ws_id=ws.id) }}";
        return;
      }

      const data = await res.json().catch(() => ({}));

      if (res.status === 403) {
        await handleForbidden(res, data, "action");
        dirty = false;
        setStatus("â€”");
        return;
      }

      if (!data.ok) throw new Error(data.error || "save failed");

      const updatedEl = document.getElementById("updated-at");
      if (updatedEl && data.updated_at) updatedEl.textContent = data.updated_at;

      lastSavedPayload = payload;
      dirty = false;

      setStatus("Saved âœ“");
      setTimeout(() => setStatus("â€”"), 1400);
    } catch {
      dirty = true;
      setStatus("Save failed");
      setTimeout(() => setStatus("Unsaved changes"), 1600);
    } finally {
      saving = false;
    }
  }

  lastSavedPayload = currentPayload();

  if (CAN_EDIT) {
    titleEl?.addEventListener("input", markDirty, { passive: true });

    notesEditorEl?.addEventListener("input", () => {
      // Remove ZWSP anchors once real text is present
      notesEditorEl.querySelectorAll('span[data-rte-fs="1"]').forEach(sp => {
        if (sp.textContent && sp.textContent.includes("\u200b") && sp.textContent.length > 1) {
          sp.textContent = sp.textContent.replaceAll("\u200b", "");
        }
      });

      syncNotesHidden();
      markDirty();
    }, { passive: true });

    cipherEl?.addEventListener("input", () => {
      if (internalCipherUpdate) return;
      markDirty();
    }, { passive: true });

    [titleEl, cipherEl].forEach(el => {
      if (!el) return;
      el.addEventListener("blur", () => triggerAutosave("blur"));
      el.addEventListener("change", () => markDirty(), { passive: true });
    });

    notesEditorEl?.addEventListener("blur", () => triggerAutosave("blur"));

    document.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
        e.preventDefault();
        dirty = true;
        triggerAutosave("hotkey");
      }
    });

    window.addEventListener("beforeunload", (e) => {
      if (!dirty) return;
      triggerAutosave("beforeunload");
      e.preventDefault();
      e.returnValue = "";
    });
  } else {
    document.addEventListener("keydown", async (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
        e.preventDefault();
        await infoModal({ title: "View-only", message: "You canâ€™t save changes because you have viewer access.", okText: "OK" });
      }
    });
  }

  // ===========================
  // Link modal (IN-SITE, no prompt)
  // ===========================
  const linkModal  = document.getElementById("link-modal");

  // ===== Clear notes confirm modal =====
  const clearNotesModal = document.getElementById("clear-notes-modal");
  const cnX = document.getElementById("cn-x");
  const cnCancel = document.getElementById("cn-cancel");
  const cnConfirm = document.getElementById("cn-confirm");

  function openClearNotesModal(){
    if (!clearNotesModal) return;
    clearNotesModal.classList.add("open");
    clearNotesModal.setAttribute("aria-hidden","false");
    setTimeout(() => cnConfirm?.focus(), 0);
  }
  function closeClearNotesModal(){
    if (!clearNotesModal) return;
    clearNotesModal.classList.remove("open");
    clearNotesModal.setAttribute("aria-hidden","true");
  }

  clearNotesModal?.addEventListener("click", (e) => {
    if (e.target === clearNotesModal) closeClearNotesModal();
  });
  clearNotesModal?.querySelector(".cn-card")?.addEventListener("click", (e) => e.stopPropagation());

  cnX?.addEventListener("click", closeClearNotesModal);
  cnCancel?.addEventListener("click", closeClearNotesModal);

  cnConfirm?.addEventListener("click", () => {
    closeClearNotesModal();
    if (!CAN_EDIT) return;
    if (!notesEditorEl) return;
    notesEditorEl.innerHTML = "";
    focusEditor();
    try { placeCaretAtEnd(notesEditorEl); } catch {}
    try { updateNotesPlaceholder(); } catch {}
    syncNotesHidden();
    markDirty();
  });

  document.addEventListener("keydown", (e) => {
    if (!clearNotesModal?.classList.contains("open")) return;
    if (e.key === "Escape") {
      e.preventDefault();
      closeClearNotesModal();
    }
  });

  const linkUrlEl  = document.getElementById("link-url");
  const linkCancel = document.getElementById("link-cancel");
  const linkConfirm= document.getElementById("link-confirm");
  const linkX      = document.getElementById("link-x");

  let savedRange = null;

  function openLinkModal() {
    if (!CAN_EDIT) return;
    if (!linkModal || !linkUrlEl || !notesEditorEl) return;

    // Save selection
    const sel = window.getSelection();
    if (sel && sel.rangeCount) savedRange = sel.getRangeAt(0);

    linkUrlEl.value = "";
    linkModal.classList.add("open");
    linkModal.setAttribute("aria-hidden", "false");

    setTimeout(() => linkUrlEl.focus(), 0);
  }

  function closeLinkModal() {
    if (!linkModal) return;
    linkModal.classList.remove("open");
    linkModal.setAttribute("aria-hidden", "true");
    savedRange = null;
  }


  // Ensure created links behave nicely
  function postProcessLinks(rootEl){
    const root = rootEl || notesEditorEl;
    if (!root) return;
    root.querySelectorAll?.("a[href]")?.forEach?.((a) => {
      // open in new tab by default
      if (!a.getAttribute("target")) a.setAttribute("target","_blank");
      if (!a.getAttribute("rel")) a.setAttribute("rel","noopener");
    });
  }

  linkCancel?.addEventListener("click", closeLinkModal);
  linkX?.addEventListener("click", closeLinkModal);

  // backdrop close
  linkModal?.addEventListener("click", (e) => {
    if (e.target === linkModal) closeLinkModal();
  });

    // escape close + enter submit (only while the modal input is focused)
  linkUrlEl?.addEventListener("keydown", (e) => {
    if (!linkModal?.classList.contains("open")) return;
    if (e.key === "Escape") {
      e.preventDefault();
      closeLinkModal();
      return;
    }
    if (e.key === "Enter") {
      e.preventDefault();
      linkConfirm?.click();
    }
  });

  // prevent backdrop-close from clicks inside the card
  linkModal?.querySelector?.(".link-card")?.addEventListener?.("click", (e) => e.stopPropagation());

  linkConfirm?.addEventListener("click", () => {
    if (!CAN_EDIT) return closeLinkModal();
    if (!savedRange) return closeLinkModal();

    let url = (linkUrlEl?.value || "").trim();
    if (!url) return;

    // Normalise URL (so "example.com" works)
    if (!/^https?:\/\//i.test(url) && !/^mailto:/i.test(url)) {
      url = "https://" + url;
    }

    // restore selection (modal focus can steal it)
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(savedRange);

    const range = sel.rangeCount ? sel.getRangeAt(0) : null;
    const anc = range.commonAncestorContainer;
    const ancEl = anc.nodeType === 1 ? anc : anc.parentNode;
    if (!range || !notesEditorEl || !ancEl || !notesEditorEl.contains(ancEl)) return closeLinkModal();

    const makeLink = () => {
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      return a;
    };

    // If selection is collapsed, insert a link node with visible text (Word-like)
    if (range.collapsed) {
      const a = makeLink();
      a.textContent = url;

      range.insertNode(a);

      // place caret after the link
      const after = document.createRange();
      after.setStartAfter(a);
      after.collapse(true);
      sel.removeAllRanges();
      sel.addRange(after);

    } else {
      // Wrap selected content in a link
      const a = makeLink();

      try {
        range.surroundContents(a);
      } catch {
        // Fallback for complex selections
        const frag = range.extractContents();
        a.appendChild(frag);
        range.insertNode(a);
      }

      // place caret after the link
      const after = document.createRange();
      after.setStartAfter(a);
      after.collapse(true);
      sel.removeAllRanges();
      sel.addRange(after);
    }

    postProcessLinks(notesEditorEl);
    syncNotesHidden();
    markDirty();
    closeLinkModal();
  });

  // Make links openable inside the editor.
// - Normal click: opens link (prevents losing selection confusion)
// - Shift+click: lets you place the caret/edit the link text normally
notesEditorEl?.addEventListener("mousedown", (e) => {
  const a = e.target?.closest?.("a[href]");
  if (!a) return;

  // Shift+click = edit / caret placement (don't open)
  if (e.shiftKey) return;

  // Open links normally inside the editor
  e.preventDefault();
  e.stopPropagation();
  window.open(a.href, "_blank", "noopener");
});

notesEditorEl?.addEventListener("mousemove", (e) => {
    const a = e.target?.closest?.("a");
    notesEditorEl.style.cursor = a ? "pointer" : "";
  });

  // ===========================
  // Notes RTE toolbar wiring
  // ===========================
  (function setupNotesRTE() {
    const bar = document.getElementById("notes-rte-bar");
    if (!bar || !notesEditorEl) return;

    try { document.execCommand("styleWithCSS", false, true); } catch {}

    const fontSel = document.getElementById("rte-font");
    const sizeSel = document.getElementById("rte-size");

    function setActiveStates() {
      const cmds = ["bold", "italic", "underline", "strikeThrough"];
      for (const c of cmds) {
        const btn = bar.querySelector(`[data-cmd="${c}"]`);
        if (!btn) continue;
        try { btn.classList.toggle("active", document.queryCommandState(c)); } catch {}
      }
    }

    function focusEditor() { notesEditorEl.focus(); }

    bar.querySelectorAll("[data-cmd]").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!CAN_EDIT) return;
        const cmd = btn.getAttribute("data-cmd");
        focusEditor();
        try { document.execCommand(cmd); } catch {}
        setActiveStates();
        syncNotesHidden();
        markDirty();
      });
    });

    fontSel?.addEventListener("change", () => {
      if (!CAN_EDIT) return;
      focusEditor();
      const v = fontSel.value;
      try { document.execCommand("fontName", false, v); } catch {}
      syncNotesHidden();
      markDirty();
    });

    
    
    // -------- Font size (Word-like) --------
    // Behavior:
    // - If you SELECT text and change size -> selected text changes.
    // - If caret only and you change size -> it becomes the "typing size" for newly inserted text,
    //   without changing existing text after the caret.

    let pendingFontSizePx = null;
    let savedNotesRange = null; // last selection inside notes editor


    function nearestOptionValue(selectEl, px) {
      if (!selectEl) return null;
      const opts = Array.from(selectEl.options).map(o => parseInt(o.value, 10)).filter(n => !isNaN(n));
      if (!opts.length) return null;
      let best = opts[0], bestd = Math.abs(opts[0] - px);
      for (const v of opts) {
        const d = Math.abs(v - px);
        if (d < bestd) { best = v; bestd = d; }
      }
      return best;
    }

    function isRangeInEditor(range) {
      if (!notesEditorEl || !range) return false;
      const c = range.commonAncestorContainer.nodeType === 1
        ? range.commonAncestorContainer
        : range.commonAncestorContainer.parentNode;
      return !!(c && notesEditorEl.contains(c));
    }

    function saveCurrentNotesRange() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      const r = sel.getRangeAt(0);
      if (!isRangeInEditor(r)) return;
      // store a clone so it survives DOM changes
      savedNotesRange = r.cloneRange();
    }

    function restoreSavedNotesRange() {
      if (!savedNotesRange) return;
      const sel = window.getSelection();
      if (!sel) return;
      sel.removeAllRanges();
      sel.addRange(savedNotesRange);
    }

    function wrapRangeFontSize(range, sizePx) {
      const wrapper = document.createElement("span");
      wrapper.style.fontSize = sizePx;
      wrapper.setAttribute("data-rte-fs", "1");

      try {
        range.surroundContents(wrapper);
      } catch {
        const frag = range.extractContents();
        wrapper.appendChild(frag);
        range.insertNode(wrapper);
      }
      return wrapper;
    }

    function mergeWithNeighbors(span) {
      // Returns the surviving node after merges (so callers can keep a valid caret target)
      if (!span || span.nodeType !== 1) return span;
      const fs = span.style.fontSize;
      const prev = span.previousSibling;
      const next = span.nextSibling;

      const canMerge = (n) =>
        n && n.nodeType === 1 &&
        n.matches('span[data-rte-fs="1"]') &&
        (n.style.fontSize || "") === fs;

      if (canMerge(prev)) {
        while (span.firstChild) prev.appendChild(span.firstChild);
        span.remove();
        span = prev;
      }
      if (canMerge(next)) {
        while (next.firstChild) span.appendChild(next.firstChild);
        next.remove();
      }
      return span;
    }

    function applyNotesFontSize(px) {
      if (!notesEditorEl) return;
      const sizePx = (parseInt(px, 10) || 16) + "px";

      focusEditor();
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;

      const range = sel.getRangeAt(0);
      if (!isRangeInEditor(range)) return;

      if (!range.collapsed) {
        // Change selected text
        const wrapped = wrapRangeFontSize(range, sizePx);

        const merged = mergeWithNeighbors(wrapped);

        // Move caret to end of styled region (keep caret target valid even if merge removed the original wrapper)
        sel.removeAllRanges();
        const r2 = document.createRange();
        r2.selectNodeContents(merged);
        r2.collapse(false);
        sel.addRange(r2);

        pendingFontSizePx = null; // selection change is explicit; keep pending off
        pendingFontSizePx = null; // selection change is explicit; keep pending off
        return;
      }

      // Caret only: set "typing size" for new inserts (Word-like)
      pendingFontSizePx = sizePx;
    }

    // Initialize dropdown default (UI only)
    if (sizeSel && !sizeSel.value) sizeSel.value = "16";

    // Keep dropdown in sync with caret position (doesn't change content)
    document.addEventListener("selectionchange", () => {
      if (!notesEditorEl || !sizeSel) return;
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      const range = sel.getRangeAt(0);
      if (!isRangeInEditor(range)) return;
      saveCurrentNotesRange();

      // If user has just set a pending size, keep the dropdown reflecting that
      if (pendingFontSizePx) {
        const v = parseInt(pendingFontSizePx, 10);
        const nearest = nearestOptionValue(sizeSel, v);
        if (nearest !== null) sizeSel.value = String(nearest);
        return;
      }

      // Otherwise reflect actual computed size at caret
      const node = range.startContainer.nodeType === 1 ? range.startContainer : range.startContainer.parentNode;
      if (!node) return;
      const computed = window.getComputedStyle(node).fontSize || "";
      const px = parseInt(computed, 10);
      if (!isNaN(px)) {
        const nearest = nearestOptionValue(sizeSel, px);
        if (nearest !== null) sizeSel.value = String(nearest);
      }
    });

    sizeSel?.addEventListener("change", () => {
      if (!CAN_EDIT) return;
      // Restore the user's selection (dropdown click may have collapsed it)
      focusEditor();
      restoreSavedNotesRange();

      const px = parseInt(sizeSel.value, 10) || 16;
      applyNotesFontSize(px);
      syncNotesHidden();
      markDirty();
    });

    
    function insertSizedTextAtCaret(text, sizePx) {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return false;
      const range = sel.getRangeAt(0);
      if (!range.collapsed) return false;
      if (!isRangeInEditor(range)) return false;

      const span = document.createElement("span");
      span.style.fontSize = sizePx;
      span.setAttribute("data-rte-fs", "1");
      span.textContent = text;

      range.insertNode(span);
      const merged = mergeWithNeighbors(span);

      sel.removeAllRanges();
      const r2 = document.createRange();
      r2.setStartAfter(merged);
      r2.collapse(true);
      sel.addRange(r2);
      return true;
    }

// Apply pending font size only to newly inserted text (no placeholders; doesn't affect existing text after caret)
    notesEditorEl?.addEventListener("beforeinput", (e) => {
      if (!CAN_EDIT) return;
      if (!pendingFontSizePx) return;

      // Only handle normal text insertion (let browser handle paste, delete, paragraph etc.)
      if (e.inputType !== "insertText") return;
      if (typeof e.data !== "string" || e.data.length === 0) return;

      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;
      const range = sel.getRangeAt(0);
      if (!range.collapsed) return;
      if (!isRangeInEditor(range)) return;

      e.preventDefault();

      const data = (e.data === " ") ? "Â " : e.data;
      insertSizedTextAtCaret(data, pendingFontSizePx);

      syncNotesHidden();
      markDirty();
    })

    // Ensure Space doesn't scroll the page when a pending font size is active
    notesEditorEl?.addEventListener("keydown", (e) => {
      if (!CAN_EDIT) return;
      if (!pendingFontSizePx) return;
      if (e.key !== " ") return;

      const ok = insertSizedTextAtCaret("\u00A0", pendingFontSizePx);
      if (ok) {
        e.preventDefault();
        syncNotesHidden();
        markDirty();
      }
    });
;
// âœ… NO prompt â€” open in-site modal

    document.getElementById("rte-link")?.addEventListener("click", (e) => {
      e.preventDefault();
      if (!CAN_EDIT) return;
      focusEditor();

      // Save selection BEFORE modal steals focus
      const sel = window.getSelection();
      if (sel && sel.rangeCount) savedRange = sel.getRangeAt(0);

      openLinkModal();
    });

    document.getElementById("rte-unlink")?.addEventListener("click", () => {
      if (!CAN_EDIT) return;
      focusEditor();
      try { document.execCommand("unlink"); } catch {}
      syncNotesHidden();
      markDirty();
    });

    document.getElementById("rte-code")?.addEventListener("click", () => {
      if (!CAN_EDIT) return;
      focusEditor();
      const selText = window.getSelection()?.toString() || "";
      try { document.execCommand("insertHTML", false, `<code>${escapeHtml(selText)}</code>`); } catch {}
      syncNotesHidden();
      markDirty();
    });

    document.getElementById("rte-highlight")?.addEventListener("click", () => {
      if (!CAN_EDIT) return;
      focusEditor();
      try { document.execCommand("hiliteColor", false, "rgba(255,235,59,0.22)"); } catch {}
      syncNotesHidden();
      markDirty();
    });

    document.getElementById("rte-clear")?.addEventListener("click", () => {
      if (!CAN_EDIT) return;
      openClearNotesModal();
    });

    notesEditorEl.addEventListener("keyup", setActiveStates);
    notesEditorEl.addEventListener("mouseup", setActiveStates);
  })();

  // ===========================
  // Insert output â†’ doc
  // ===========================
  const insertBtn = document.getElementById("insert-tool-output");

  const TOOL_LABELS = {
    frequency: "Frequency",
    substitution: "Substitution",
    replacer: "Replace",
    spacer: "Spacer",
    remove_spaces: "No spaces",
    remove_punctuation: "No punct",
    breaker: "Breaker",
  };

  function getActiveToolOutput() {
    const active = document.querySelector(".tool-card.active");
    if (!active) return { tool: "Tool", text: "" };

    const id = active.id || "";
    const toolKey = id.startsWith("tool-") ? id.slice(5) : "tool";
    const toolLabel = TOOL_LABELS[toolKey] || toolKey;

    const out = active.querySelector(".result");
    return { tool: toolLabel, text: out ? out.textContent : "" };
  }

  function insertHtmlAtCaret(html) {
    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return;

    const range = sel.getRangeAt(0);
    range.deleteContents();

    const template = document.createElement("template");
    template.innerHTML = html;

    const frag = template.content;
    const lastNode = frag.lastChild;

    range.insertNode(frag);

    if (lastNode) {
      range.setStartAfter(lastNode);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
  }

  insertBtn?.addEventListener("click", async () => {
    if (!CAN_EDIT) {
      await infoModal({ title: "View-only", message: "You have viewer access, so you canâ€™t modify notes.", okText: "OK" });
      return;
    }

    const { tool, text } = getActiveToolOutput();
    if (!text || text.trim() === "" || text.trim() === "Run a tool to see output here.") return;

    const stamp = new Date().toLocaleString("en-GB", {
      day: "2-digit", month: "short", hour: "2-digit", minute: "2-digit"
    }).replace(",", "");

    const safeText = escapeHtml(text).replace(/\n/g, "<br>");

    const block = `
      <div style="margin:14px 0;padding:12px;border:1px dashed var(--line);border-radius:12px;background:rgba(255,255,255,0.03);">
        <div style="font-weight:1000;color:var(--text);margin-bottom:6px;">
          ${escapeHtml(tool)} output
          <span style="color:var(--muted);font-weight:900;">(${escapeHtml(stamp)})</span>
        </div>
        <div style="font-family:'Fira Code','JetBrains Mono',monospace;font-size:13px;line-height:1.6;white-space:pre-wrap;">
          ${safeText}
        </div>
      </div>
    `;

    notesEditorEl?.focus();
    insertHtmlAtCaret(block);
    syncNotesHidden();
    markDirty();
  });

  document.getElementById("copy-doc")?.addEventListener("click", async () => {
    try {
      const plain = notesEditorEl ? notesEditorEl.innerText : (notesHiddenEl?.value || "");
      await navigator.clipboard.writeText(plain);
      setStatus("Copied");
      setTimeout(() => setStatus("â€”"), 900);
    } catch {}
  });

  // ===========================
  // Frequency
  // ===========================
  const freqBtn = document.getElementById("run-frequency");
  const copyToolBtn = document.getElementById("copy-tool");
  const outMain = document.getElementById("tool-output");

  freqBtn?.addEventListener("click", async () => {
    outMain.textContent = "Runningâ€¦";
    try {
      const text = cipherEl?.value || "";
      const out = await toolsRun("frequency", { text });
      outMain.textContent = out || "(no output)";
    } catch {
      outMain.textContent = "Error running frequency.";
    }
  });

  copyToolBtn?.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText((outMain.textContent || "").trim());
      setStatus("Copied");
      setTimeout(() => setStatus("â€”"), 900);
    } catch {}
  });

  // ===========================
  // Substitution (client-side mapping MVP)
  // ===========================
  const alphabet = "abcdefghijklmnopqrstuvwxyz".split("");
  const subGrid = document.getElementById("sub-grid");
  const subFreqBtn = document.getElementById("sub-frequency");
  const subFreqOut = document.getElementById("sub-freq-output");

  const mapping = {};
  let originalCipher = (cipherEl?.value || "").toUpperCase();

  function renderSubGrid() {
    if (!subGrid) return;
    subGrid.innerHTML = "";

    alphabet.forEach(plain => {
      mapping[plain] = mapping[plain] || "";
      const box = document.createElement("div");
      box.className = "sub-box";
      box.innerHTML = `
        <div class="sub-top">${plain}</div>
        <div class="sub-arrow">â†“</div>
        <input class="sub-input" maxlength="1" data-plain="${plain}" placeholder="â€¦" value="${escapeHtml(mapping[plain] || "")}" ${CAN_EDIT ? "" : "disabled"}>
      `;
      subGrid.appendChild(box);
    });

    subGrid.querySelectorAll(".sub-input").forEach(inp => {
      inp.addEventListener("input", async () => {
        if (!CAN_EDIT) return;
        const plain = inp.dataset.plain;
        const c = (inp.value || "").toUpperCase().replace(/[^A-Z]/g, "");
        inp.value = c;
        mapping[plain] = c;
        applySubMapping();
      });
    });
  }

  function applySubMapping() {
    if (!CAN_EDIT) return;

    const text = originalCipher || "";
    let out = "";

    for (const ch of text) {
      let replaced = false;
      for (const [plain, cipher] of Object.entries(mapping)) {
        if (cipher && ch === cipher) {
          out += plain;
          replaced = true;
          break;
        }
      }
      if (!replaced) out += ch;
    }

    internalCipherUpdate = true;
    cipherEl.value = out;
    internalCipherUpdate = false;

    markDirty();
  }

  cipherEl?.addEventListener("input", () => {
    if (internalCipherUpdate) return;
    if (!CAN_EDIT) {
      internalCipherUpdate = true;
      cipherEl.value = (lastSavedPayload?.cipher_text ?? originalCipher ?? "");
      internalCipherUpdate = false;
      return;
    }
    originalCipher = (cipherEl.value || "").toUpperCase();
  });

  document.getElementById("sub-clear")?.addEventListener("click", async () => {
    if (!CAN_EDIT) {
      await infoModal({ title: "View-only", message: "Viewers canâ€™t modify ciphertext.", okText: "OK" });
      return;
    }
    Object.keys(mapping).forEach(k => mapping[k] = "");
    renderSubGrid();
    applySubMapping();
  });

  document.getElementById("sub-reset")?.addEventListener("click", async () => {
    if (!CAN_EDIT) {
      await infoModal({ title: "View-only", message: "Viewers canâ€™t modify ciphertext.", okText: "OK" });
      return;
    }
    internalCipherUpdate = true;
    cipherEl.value = originalCipher;
    internalCipherUpdate = false;
    subFreqOut.textContent = "Frequency output will appear here.";
    markDirty();
  });

  subFreqBtn?.addEventListener("click", async () => {
    subFreqOut.textContent = "Runningâ€¦";
    try {
      const out = await toolsRun("frequency", { text: originalCipher });
      subFreqOut.textContent = out || "(no output)";
    } catch {
      subFreqOut.textContent = "Error running frequency.";
    }
  });

  renderSubGrid();

  // ===========================
  // Text Replacer
  // ===========================
  const repFind = document.getElementById("rep-find");
  const repWith = document.getElementById("rep-with");
  const repRun = document.getElementById("run-replace");
  const repOut = document.getElementById("tool-output-replace");

  repRun?.addEventListener("click", async () => {
    repOut.textContent = "Runningâ€¦";
    try {
      const out = await toolsRun("text_replacer", {
        text: cipherEl?.value || "",
        to_replace: repFind?.value || "",
        replacement: repWith?.value || ""
      });
      repOut.textContent = out || "(no output)";
    } catch {
      repOut.textContent = "Error running replacer.";
    }
  });

  // ===========================
  // Spacer
  // ===========================
  const spacerRun = document.getElementById("run-spacer");
  const spacerLen = document.getElementById("spacer-len");
  const spacerOut = document.getElementById("tool-output-spacer");

  spacerRun?.addEventListener("click", async () => {
    spacerOut.textContent = "Runningâ€¦";
    try {
      const out = await toolsRun("text_spacer", {
        text: cipherEl?.value || "",
        block_length: Number(spacerLen?.value || 5)
      });
      spacerOut.textContent = out || "(no output)";
    } catch {
      spacerOut.textContent = "Error running spacer.";
    }
  });

  // ===========================
  // Remove spaces / punctuation
  // ===========================
  const rsBtn = document.getElementById("run-remove-spaces");
  const rsOut = document.getElementById("tool-output-remove-spaces");

  rsBtn?.addEventListener("click", async () => {
    rsOut.textContent = "Runningâ€¦";
    try {
      const out = await toolsRun("remove_spaces", { text: cipherEl?.value || "" });
      rsOut.textContent = out || "(no output)";
    } catch {
      rsOut.textContent = "Error running remove spaces.";
    }
  });

  const rpBtn = document.getElementById("run-remove-punct");
  const rpOut = document.getElementById("tool-output-remove-punct");

  rpBtn?.addEventListener("click", async () => {
    rpOut.textContent = "Runningâ€¦";
    try {
      const out = await toolsRun("remove_punctuation", { text: cipherEl?.value || "" });
      rpOut.textContent = out || "(no output)";
    } catch {
      rpOut.textContent = "Error running remove punctuation.";
    }
  });

  // ===========================
  // Breaker
  // ===========================
  const breakerTypeEl = document.getElementById("breaker-type");
  const breakerKnownEl = document.getElementById("breaker-known");
  const breakerRunBtn = document.getElementById("run-breaker");
  const breakerCopyBtn = document.getElementById("copy-breaker");
  const breakerOutEl = document.getElementById("breaker-output");

  breakerRunBtn?.addEventListener("click", async () => {
    breakerOutEl.textContent = "Runningâ€¦";
    try {
      const data = await breakerRunRequest({
        text: cipherEl?.value || "",
        cipher_type: breakerTypeEl?.value || "vigenere",
        known_plaintext: breakerKnownEl?.value || ""
      });

      const cipher = data?.cipher ?? "â€”";
      const key = (data?.key === null || data?.key === undefined || data?.key === "") ? "â€”" : String(data.key);
      const plain = data?.text ?? "";

      breakerOutEl.textContent =
        `Cipher: ${cipher}\n` +
        `Key: ${key}\n\n` +
        `${plain || "(no output)"}`;
    } catch {
      breakerOutEl.textContent = "Error running breaker.";
    }
  });

  breakerCopyBtn?.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText((breakerOutEl.textContent || "").trim());
      setStatus("Copied");
      setTimeout(() => setStatus("â€”"), 900);
    } catch {}
  });

  // ============================================================
  // Cipher Image tabs + upload/delete + rename + kebab menu (PORTAL)
  // ============================================================
  const imgInput = document.getElementById("cipher-image-input");
  const imgUploadBtn = document.getElementById("upload-cipher-image");
  const imgDeleteBtn = document.getElementById("delete-cipher-image");
  const imgStatus = document.getElementById("cipher-image-status");

  const tabsEl = document.getElementById("cipher-tabs");
  const tabsHint = document.getElementById("cipher-tabs-hint");

  const imgWrap = document.getElementById("cipher-image-wrap");
  const img = document.getElementById("cipher-img");

  let images = [];
  let activeImageId = null;

  let floatMenuEl = null;
  let floatMenuForId = null;

  function ensureFloatMenu() {
    if (floatMenuEl) return floatMenuEl;

    floatMenuEl = document.createElement("div");
    floatMenuEl.className = "cipher-float-menu";
    floatMenuEl.innerHTML = `
      <button class="cipher-menu-item" type="button" data-action="rename">
        Rename <span style="opacity:.7;">â†µ</span>
      </button>
      <button class="cipher-menu-item danger" type="button" data-action="delete">
        Delete <span style="opacity:.7;">âŒ«</span>
      </button>
    `;

    floatMenuEl.addEventListener("click", async (e) => {
      if (!CAN_EDIT) {
        closeFloatMenu();
        await infoModal({ title: "View-only", message: "You canâ€™t edit images with viewer access.", okText: "OK" });
        return;
      }

      const item = e.target?.closest?.(".cipher-menu-item");
      if (!item) return;

      const im = images.find(x => x.id === floatMenuForId);
      if (!im) return closeFloatMenu();

      const action = item.dataset.action;

      if (action === "rename") {
        closeFloatMenu();
        startRenameTab(im.id);
        return;
      }

      if (action === "delete") {
        closeFloatMenu();
        const ok = await confirmDeleteModal({
          title: "Delete image?",
          message: `Delete "${(im.label || "Image").trim()}"? This canâ€™t be undone.`
        });
        if (!ok) return;

        await deleteImageById(im.id);
      }
    });

    document.body.appendChild(floatMenuEl);
    return floatMenuEl;
  }

  function closeFloatMenu() {
    if (!floatMenuEl) return;
    floatMenuEl.classList.remove("open");
    floatMenuEl.style.left = "-9999px";
    floatMenuEl.style.top = "-9999px";
    floatMenuForId = null;
  }

  function openFloatMenuFor(imageId, anchorEl) {
    if (!CAN_EDIT) return;
    const menu = ensureFloatMenu();
    floatMenuForId = imageId;

    menu.classList.add("open");
    menu.style.left = "0px";
    menu.style.top = "0px";

    const r = anchorEl.getBoundingClientRect();
    const mr = menu.getBoundingClientRect();

    const pad = 10;
    let left = r.right - mr.width;
    let top = r.bottom + 8;

    if (left < pad) left = pad;
    if (left + mr.width > window.innerWidth - pad) left = window.innerWidth - mr.width - pad;

    if (top + mr.height > window.innerHeight - pad) {
      top = r.top - mr.height - 8;
    }
    if (top < pad) top = pad;

    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
  }

  function showCipherImage(src) {
    if (!imgWrap || !img) return;
    img.src = src;
    imgWrap.style.display = "grid";
  }

  function hideCipherImage() {
    if (!imgWrap || !img) return;
    img.src = "";
    imgWrap.style.display = "none";
  }

  function setActiveImage(id) {
    activeImageId = id;
    const active = images.find(x => x.id === id);
    if (active && active.url) {
      showCipherImage(active.url + (active.url.includes("?") ? "&" : "?") + "v=" + Date.now());
    } else {
      hideCipherImage();
    }
    renderTabs();
  }

  async function deleteImageById(imageId) {
    if (!CAN_EDIT) {
      await infoModal({ title: "View-only", message: "You canâ€™t delete images with viewer access.", okText: "OK" });
      return;
    }
    if (!imageId) return;

    if (imgStatus) imgStatus.textContent = "Removingâ€¦";

    try {
      const res = await fetch(`/workspaces/{{ ws.id }}/image/delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image_id: imageId })
      });
      const data = await res.json().catch(() => ({}));

      if (await handleForbidden(res, data, "tabs")) {
        if (imgStatus) imgStatus.textContent = "â€”";
        return;
      }
      if (maybeHandleProGate(res, data, "tabs")) {
        if (imgStatus) imgStatus.textContent = "â€”";
        return;
      }

      if (!data.ok) throw new Error(data.error || "delete failed");

      images = images.filter(x => x.id !== imageId);

      const updatedEl = document.getElementById("updated-at");
      if (updatedEl && data.updated_at) updatedEl.textContent = data.updated_at;

      if (images.length === 0) {
        activeImageId = null;
        hideCipherImage();
        closeFloatMenu();
        renderTabs();
      } else {
        closeFloatMenu();
        setActiveImage(images[0].id);
      }

      if (imgStatus) imgStatus.textContent = "Removed âœ“";
      setTimeout(() => { if (imgStatus) imgStatus.textContent = "â€”"; }, 1200);
    } catch {
      if (imgStatus) imgStatus.textContent = "Remove failed";
      setTimeout(() => { if (imgStatus) imgStatus.textContent = "â€”"; }, 1600);
    }
  }

  function renderTabs() {
    if (!tabsEl) return;

    if (!images || images.length === 0) {
      tabsEl.classList.remove("show");
      if (tabsHint) tabsHint.style.display = "none";
      closeFloatMenu();
      return;
    }

    tabsEl.classList.add("show");
    if (tabsHint) tabsHint.style.display = "block";

    tabsEl.innerHTML = "";

    images.forEach((im) => {
      const wrap = document.createElement("div");
      wrap.className = "cipher-tab-wrap";
      wrap.dataset.imageId = String(im.id);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "cipher-tab" + (im.id === activeImageId ? " active" : "");
      btn.dataset.imageId = String(im.id);

      const kebab = CAN_EDIT
        ? `<span class="cipher-tab-more" role="button" tabindex="0" aria-label="Tab options" title="Options">â‹®</span>`
        : "";

      btn.innerHTML = `
        <span class="cipher-tab-label" title="${escapeHtml(im.label || "")}">
          ${escapeHtml(im.label || "")}
        </span>
        ${kebab}
      `;

      btn.addEventListener("click", (e) => {
        const isMore = e.target?.closest?.(".cipher-tab-more");
        if (isMore) return;
        closeFloatMenu();
        setActiveImage(im.id);
      });

      const more = btn.querySelector(".cipher-tab-more");
      const openMenu = (ev) => {
        if (!CAN_EDIT) return;
        ev.preventDefault();
        ev.stopPropagation();

        if (floatMenuForId === im.id && floatMenuEl?.classList.contains("open")) {
          closeFloatMenu();
          return;
        }
        openFloatMenuFor(im.id, more);
      };

      more?.addEventListener("click", openMenu);
      more?.addEventListener("keydown", (ev) => {
        if (!CAN_EDIT) return;
        if (ev.key === "Enter" || ev.key === " ") openMenu(ev);
      });

      btn.addEventListener("dblclick", async (e) => {
        if (!CAN_EDIT) return;
        e.preventDefault();
        closeFloatMenu();
        startRenameTab(im.id);
      });

      wrap.appendChild(btn);
      tabsEl.appendChild(wrap);
    });
  }

  function startRenameTab(imageId) {
    if (!CAN_EDIT) return;

    const im = images.find(x => x.id === imageId);
    if (!im || !tabsEl) return;

    const wrap = Array.from(tabsEl.querySelectorAll(".cipher-tab-wrap"))
      .find(w => Number(w.dataset.imageId) === imageId);
    if (!wrap) return;

    closeFloatMenu();

    const oldLabel = (im.label || "").trim() || "Image";

    wrap.innerHTML = `<input class="cipher-tab-input" value="${escapeHtml(oldLabel)}" />`;

    const input = wrap.querySelector(".cipher-tab-input");
    input?.focus();
    input?.select();

    const cancel = () => { renderTabs(); };

    const commit = async () => {
      const newLabel = (input?.value || "").trim();
      const finalLabel = newLabel || oldLabel;

      im.label = finalLabel;
      renderTabs();

      try {
        const res = await fetch(`/workspaces/{{ ws.id }}/image/rename`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image_id: imageId, label: finalLabel })
        });
        const data = await res.json().catch(() => ({}));

        if (await handleForbidden(res, data, "tabs")) return;
        if (maybeHandleProGate(res, data, "tabs")) return;
        if (!data.ok) throw new Error(data.error || "rename failed");
      } catch {
        im.label = oldLabel;
        renderTabs();
        if (imgStatus) {
          imgStatus.textContent = "Rename failed";
          setTimeout(() => { if (imgStatus) imgStatus.textContent = "â€”"; }, 1400);
        }
      }
    };

    input?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") commit();
      if (e.key === "Escape") cancel();
    });
    input?.addEventListener("blur", commit);
  }

  async function loadImages() {
    try {
      const res = await fetch(`/workspaces/{{ ws.id }}/images`);
      const data = await res.json().catch(() => ({}));

      if (await handleForbidden(res, data, "tabs")) return;
      if (maybeHandleProGate(res, data, "tabs")) return;
      if (!data.ok) throw new Error("failed");

      images = Array.isArray(data.images) ? data.images : [];

      if (images.length === 0) {
        activeImageId = null;
        hideCipherImage();
        closeFloatMenu();
        renderTabs();
        return;
      }

      if (!activeImageId || !images.some(x => x.id === activeImageId)) {
        activeImageId = images[0].id;
      }

      renderTabs();
      setActiveImage(activeImageId);
    } catch {
      images = [];
      renderTabs();
    }
  }

  async function uploadSelectedImage() {
    if (!CAN_EDIT) {
      await infoModal({ title: "View-only", message: "You canâ€™t upload images with viewer access.", okText: "OK" });
      if (imgInput) imgInput.value = "";
      return;
    }

    const file = imgInput?.files?.[0];
    if (!file) return;

    if (imgStatus) imgStatus.textContent = "Uploadingâ€¦";
    if (imgUploadBtn) imgUploadBtn.disabled = true;

    try {
      const fd = new FormData();
      fd.append("image", file);

      const res = await fetch(`/workspaces/{{ ws.id }}/image`, { method: "POST", body: fd });
      const data = await res.json().catch(() => ({}));

      if (await handleForbidden(res, data, "tabs")) {
        if (imgStatus) imgStatus.textContent = "â€”";
        return;
      }
      if (maybeHandleProGate(res, data, "tabs")) {
        if (imgStatus) imgStatus.textContent = "â€”";
        return;
      }

      if (!res.ok || !data.ok) throw new Error(data.error || "upload failed");

      const newImg = data.image;
      if (newImg && newImg.id) {
        images.push(newImg);
        closeFloatMenu();
        setActiveImage(newImg.id);
      } else {
        await loadImages();
      }

      const updatedEl = document.getElementById("updated-at");
      if (updatedEl && data.updated_at) updatedEl.textContent = data.updated_at;

      if (imgStatus) imgStatus.textContent = "Uploaded âœ“";
      setTimeout(() => { if (imgStatus) imgStatus.textContent = "â€”"; }, 1200);
    } catch {
      if (imgStatus) imgStatus.textContent = "Upload failed";
      setTimeout(() => { if (imgStatus) imgStatus.textContent = "â€”"; }, 1600);
    } finally {
      if (imgUploadBtn) imgUploadBtn.disabled = !CAN_EDIT ? true : false;
      if (imgInput) imgInput.value = "";
    }
  }

  if (CAN_EDIT) {
    imgUploadBtn?.addEventListener("click", () => imgInput?.click());
    imgInput?.addEventListener("change", uploadSelectedImage);
  } else {
    imgUploadBtn?.addEventListener("click", async () => {
      await infoModal({ title: "View-only", message: "You canâ€™t upload images with viewer access.", okText: "OK" });
    });
    imgInput?.addEventListener("change", () => { if (imgInput) imgInput.value = ""; });
  }

  imgDeleteBtn?.addEventListener("click", async () => {
    if (!CAN_EDIT) {
      await infoModal({ title: "View-only", message: "You canâ€™t delete images with viewer access.", okText: "OK" });
      return;
    }

    if (!activeImageId) {
      if (imgStatus) imgStatus.textContent = "No image selected";
      setTimeout(() => { if (imgStatus) imgStatus.textContent = "â€”"; }, 1200);
      return;
    }

    const active = images.find(x => x.id === activeImageId);
    const ok = await confirmDeleteModal({
      title: "Delete selected image?",
      message: `Delete "${((active?.label) || "Image").trim()}"? This canâ€™t be undone.`
    });
    if (!ok) return;

    await deleteImageById(activeImageId);
  });

  document.addEventListener("click", (e) => {
    const inMenu = e.target?.closest?.(".cipher-float-menu");
    const onKebab = e.target?.closest?.(".cipher-tab-more");
    if (!inMenu && !onKebab) closeFloatMenu();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeFloatMenu();
  });

  document.addEventListener("scroll", () => closeFloatMenu(), true);
  window.addEventListener("resize", () => closeFloatMenu());

  loadImages();

  // ===========================
  // Image zoom (preview)
  // ===========================
  const modal = document.getElementById("img-modal");
  const modalImg = document.getElementById("img-modal-img");
  const closeBtn = document.getElementById("img-close");

  function openImgModal(src) {
    if (!modal || !modalImg) return;
    modalImg.src = src;
    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");
  }
  function closeImgModal() {
    if (!modal) return;
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden", "true");
  }

  img?.addEventListener("click", () => openImgModal(img.src));
  closeBtn?.addEventListener("click", closeImgModal);
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) closeImgModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeImgModal();
  });

  // ===========================
  // PRO FEATURES: Export PDF / Clone / History
  // ===========================
  const exportBtn = document.getElementById("ws-export-pdf");
  const cloneBtn  = document.getElementById("ws-clone");
  const histBtn   = document.getElementById("ws-history");

  async function workspaceCanCreateCheck() {
    try {
      const res = await fetch(`/workspaces/can-create`, { method: "GET" });

      if (res.status === 401) return { ok: false, can_create: false, error: "login required" };

      const data = await res.json().catch(() => ({}));
      if (!res.ok) return { ok: false, can_create: false, error: data.error || "not allowed" };

      if (typeof data.can_create === "boolean") return data;
      return { ok: true, can_create: true };
    } catch {
      return { ok: true, can_create: true };
    }
  }

  exportBtn?.addEventListener("click", async () => {
    try {
      exportBtn.disabled = true;
      setStatus("Preparing PDFâ€¦");

      const res = await fetch(`/workspaces/{{ ws.id }}/export.pdf`, { method: "GET" });

      if (res.status === 402 || res.status === 403) {
        let data = {};
        try { data = await res.json(); } catch {}
        if (await handleForbidden(res, data, "export")) return;
        if (maybeHandleProGate(res, data, "export")) return;
        throw new Error(data.error || "export failed");
      }

      if (!res.ok) throw new Error("export failed");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `cipherlab_lab_{{ ws.id }}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setStatus("Downloaded âœ“");
      setTimeout(() => setStatus("â€”"), 1200);
    } catch {
      setStatus("Export failed");
      setTimeout(() => setStatus("â€”"), 1200);
    } finally {
      exportBtn.disabled = false;
    }
  });



  // ===== Clone (Pro) =====
  const colabBtn = document.getElementById("ws-colab");

  async function tryJson(res){
    try { return await res.json(); } catch { return {}; }
  }

  cloneBtn?.addEventListener("click", async () => {
    try {
      cloneBtn.disabled = true;
      setStatus("Cloningâ€¦");

      // Use a fetch so we can show the Pro modal instead of navigating.
      const res = await fetch(`/workspaces/{{ ws.id }}/clone`, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      const ct = (res.headers.get("content-type") || "").toLowerCase();
      const data = ct.includes("application/json") ? await tryJson(res) : {};

      if (res.status === 402 || res.status === 403) {
        if (await handleForbidden(res, data, "clone")) return;
        if (maybeHandleProGate(res, data, "clone")) return;
      }

      if (res.redirected && res.url) {
        window.location.href = res.url;
        return;
      }

      // If server returns JSON with a redirect
      if (data?.redirect_url) {
        window.location.href = data.redirect_url;
        return;
      }

      if (!res.ok) throw new Error(data?.error || "clone failed");

      // Fallback: reload (some backends clone then return ok)
      window.location.reload();
    } catch {
      setStatus("Clone failed");
      setTimeout(() => setStatus("â€”"), 1200);
    } finally {
      cloneBtn && (cloneBtn.disabled = false);
    }
  });

  // ===== History (Pro) =====
  const historyModal = document.getElementById("history-modal");
  const historyX = document.getElementById("history-x");

  function openHistoryModal(){
    if (!historyModal) return;
    historyModal.classList.add("open");
    historyModal.setAttribute("aria-hidden","false");
  }
  function closeHistoryModal(){
    if (!historyModal) return;
    historyModal.classList.remove("open");
    historyModal.setAttribute("aria-hidden","true");
  }

  historyX?.addEventListener("click", closeHistoryModal);
  historyModal?.addEventListener("click", (e)=>{
    const closeEl = e.target?.closest?.("[data-hclose='1']");
    if (closeEl) closeHistoryModal();
  });

  histBtn?.addEventListener("click", async () => {
    try {
      histBtn.disabled = true;
      setStatus("Loading historyâ€¦");

      // Ask server for history; if it gates Pro, show Pro modal.
      const res = await fetch(`/workspaces/{{ ws.id }}/history`, { method: "GET", headers: { "X-Requested-With":"XMLHttpRequest" } });
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      const data = ct.includes("application/json") ? await tryJson(res) : {};

      if (res.status === 402 || res.status === 403) {
        if (await handleForbidden(res, data, "history")) return;
        if (maybeHandleProGate(res, data, "history")) return;
      }

      if (!res.ok) throw new Error(data?.error || "history failed");

      // If backend returns HTML (non-AJAX), just navigate.
      if (!ct.includes("application/json")) {
        window.location.href = `/workspaces/{{ ws.id }}/history`;
        return;
      }

      // Minimal render if JSON list present
      const listEl = document.getElementById("history-list");
      const statusEl = document.getElementById("history-status");
      if (statusEl) statusEl.textContent = data?.items?.length ? `${data.items.length} snapshots` : "No snapshots yet";
      if (listEl) {
        listEl.innerHTML = "";
        (data.items || []).forEach(item => {
          const li = document.createElement("li");
          li.className = "hitem";
          li.textContent = item.title || item.created_at || "Snapshot";
          listEl.appendChild(li);
        });
      }

      openHistoryModal();
      setStatus("â€”");
    } catch {
      setStatus("History failed");
      setTimeout(() => setStatus("â€”"), 1200);
    } finally {
      histBtn && (histBtn.disabled = false);
    }
  });

  // ===== CoLab (Pro) =====
  const colabModal = document.getElementById("colab-modal");
  const colabX = document.getElementById("colab-x");

  function openColabModal(){
    if (!colabModal) return;
    colabModal.classList.add("open");
    colabModal.setAttribute("aria-hidden","false");
  }
  function closeColabModal(){
    if (!colabModal) return;
    colabModal.classList.remove("open");
    colabModal.setAttribute("aria-hidden","true");
  }

  colabX?.addEventListener("click", closeColabModal);
  colabModal?.addEventListener("click", (e)=>{
    const closeEl = e.target?.closest?.("[data-colab-close='1']");
    if (closeEl) closeColabModal();
  });

  colabBtn?.addEventListener("click", async () => {
    try {
      // CoLab is Pro-only: gate immediately (donâ€™t show the sharing modal to free users).
      if (!USER_IS_PRO) {
        openProModal({
          title: "Labs Pro required",
          body: "CoLab (sharing + collaborators) is a Labs Pro feature.",
          href: "/labs-pro",
          cta: "Upgrade to Pro"
        });
        return;
      }

      colabBtn.disabled = true;
      setStatus("Opening CoLabâ€¦");

      // Ping server; if it gates Pro, show Pro modal. Otherwise open the modal.
      const res = await fetch(`/workspaces/{{ ws.id }}/colab`, { method: "GET", headers: { "X-Requested-With":"XMLHttpRequest" } });
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      const data = ct.includes("application/json") ? await tryJson(res) : {};

      if (res.status === 402 || res.status === 403) {
        if (await handleForbidden(res, data, "colab")) return;
        if (maybeHandleProGate(res, data, "colab")) return;
      }

      // If backend doesn't have this route, just open the modal anyway.
      if (!res.ok && res.status !== 404) throw new Error(data?.error || "colab failed");

      openColabModal();
      setStatus("â€”");
    } catch {
      setStatus("â€”");
    } finally {
      colabBtn && (colabBtn.disabled = false);
    }
  });

  // (clone/history/colab parts unchanged in your snippet; keep them below if you already have them)

  // ===========================
  // Default tool state
  // ===========================
  showTool("frequency");
  setStatus("â€”");
</script>




<!-- =========================
     TOUR SCRIPT (FULL UPDATE)
========================= -->
<script>
(function(){
  const SHOULD_TOUR = {{ 1 if show_tour else 0 }};
  if (!SHOULD_TOUR) return;

  if (typeof CAN_EDIT !== "undefined" && !CAN_EDIT) return;

  const overlay   = document.getElementById("tour-overlay");
  const highlight = document.getElementById("tour-highlight");
  const card      = document.getElementById("tour-card");
  const titleEl   = document.getElementById("tour-title");
  const bodyEl    = document.getElementById("tour-body");
  const stepEl    = document.getElementById("tour-step");
  const btnSkip   = document.getElementById("tour-skip");
  const btnBack   = document.getElementById("tour-back");
  const btnNext   = document.getElementById("tour-next");

  if (!overlay || !highlight || !card || !titleEl || !bodyEl || !stepEl || !btnSkip || !btnBack || !btnNext) return;

  // âœ… MOBILE DETECTION
  const IS_MOBILE =
    matchMedia("(max-width: 820px)").matches ||
    matchMedia("(pointer: coarse)").matches;

  // steps (UPDATED notes selector)
  const steps = [
    { sel:"#ws-title-input", title:"Lab title", body:"Name the puzzle youâ€™re working on. Keeping titles specific makes search + organisation way easier later." },
    { sel:"#cipher-text", title:"Ciphertext", body:"Paste the ciphertext here. This is what most tools read from." },

    // âœ… NEW: target rich editor first, fallback to old textarea if it still exists
    { sel:"#ws-notes-editor, #ws-notes", title:"Notes", body:"Dump cribs, hypotheses, partial plaintext, and anything you donâ€™t want to lose. Autosave keeps it safe." },

    { sel:".tb-btn[data-tool='frequency']", title:"Tools toolbar", body:"Pick a tool here. Frequency is usually a great first step to identify what youâ€™re dealing with." },
    {
      before: () => { if (typeof showTool === "function") showTool("frequency"); },
      sel:"#run-frequency",
      title:"Run Frequency",
      body:"Hit Run to generate frequency analysis. This is one of the fastest ways to identify what cipher youâ€™re dealing with."
    },
    { sel:"#insert-tool-output", title:"Insert output", body:"Quickly drop tool results into your notes so your working stays in one place." }
  ];

  let i = 0;
  let scrollParents = [];
  let rafId = 0;
  let placeTimer1 = 0;
  let placeTimer2 = 0;

  // highlight smoothing state (desktop only)
  let hCur = null;
  let hTgt = null;
  let hAnim = 0;

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function findTarget(step){ return document.querySelector(step.sel) || null; }
  function lerp(a,b,t){ return a + (b - a) * t; }
  function roundPx(n){ return Math.round(n * 2) / 2; } // 0.5px snap reduces shimmer
  function applyPos(el, styleObj){ for (const k in styleObj) el.style[k] = styleObj[k]; }

  function getScrollParents(el){
    const parents = [];
    let p = el ? el.parentElement : null;
    while (p && p !== document.body) {
      const s = getComputedStyle(p);
      const oy = s.overflowY;
      const ox = s.overflowX;
      if (/(auto|scroll|overlay)/.test(oy) || /(auto|scroll|overlay)/.test(ox)) parents.push(p);
      p = p.parentElement;
    }
    parents.push(window);
    return parents;
  }

  function unbindScrollTracking(){
    scrollParents.forEach(p => {
      if (p === window) window.removeEventListener("scroll", onReflow, true);
      else { try { p.removeEventListener("scroll", onReflow); } catch(_e){} }
    });
    scrollParents = [];
  }

  function bindScrollTracking(target){
    unbindScrollTracking();
    scrollParents = getScrollParents(target);
    scrollParents.forEach(p => {
      if (p === window) window.addEventListener("scroll", onReflow, true);
      else p.addEventListener("scroll", onReflow, { passive: true });
    });
  }

  function startHighlightAnim(){
    cancelAnimationFrame(hAnim);
    const step = () => {
      if (!hCur || !hTgt) return;

      const t = 0.22;
      hCur = {
        left:   lerp(hCur.left,   hTgt.left,   t),
        top:    lerp(hCur.top,    hTgt.top,    t),
        width:  lerp(hCur.width,  hTgt.width,  t),
        height: lerp(hCur.height, hTgt.height, t),
        radius: hTgt.radius
      };

      const done =
        Math.abs(hCur.left - hTgt.left) < 0.25 &&
        Math.abs(hCur.top - hTgt.top) < 0.25 &&
        Math.abs(hCur.width - hTgt.width) < 0.25 &&
        Math.abs(hCur.height - hTgt.height) < 0.25;

      highlight.style.left   = roundPx(hCur.left) + "px";
      highlight.style.top    = roundPx(hCur.top) + "px";
      highlight.style.width  = roundPx(hCur.width) + "px";
      highlight.style.height = roundPx(hCur.height) + "px";
      highlight.style.borderRadius = hCur.radius;

      if (!done) hAnim = requestAnimationFrame(step);
    };

    hAnim = requestAnimationFrame(step);
  }

  function place(el){
    const r = el.getBoundingClientRect();
    const cs = getComputedStyle(el);

    // tight-fit highlight
    const bwL = parseFloat(cs.borderLeftWidth) || 0;
    const bwR = parseFloat(cs.borderRightWidth) || 0;
    const bwT = parseFloat(cs.borderTopWidth) || 0;
    const bwB = parseFloat(cs.borderBottomWidth) || 0;

    const glowInset = 0;
    const insetL = bwL - glowInset;
    const insetR = bwR - glowInset;
    const insetT = bwT - glowInset;
    const insetB = bwB - glowInset;

    highlight.style.display = "block";

    const next = {
      left:   (r.left + insetL - 9),
      top:    (r.top  + insetT),
      width:  Math.max(0, r.width  - insetL - insetR),
      height: Math.max(0, r.height - insetT - insetB),
      radius: (cs.borderRadius || "12px")
    };

    // âœ… MOBILE: snap instantly (no highlight animation)
    if (IS_MOBILE){
      cancelAnimationFrame(hAnim);
      hCur = null;
      hTgt = null;
      highlight.style.left   = next.left + "px";
      highlight.style.top    = next.top + "px";
      highlight.style.width  = next.width + "px";
      highlight.style.height = next.height + "px";
      highlight.style.borderRadius = next.radius;
    } else {
      if (!hCur) hCur = { ...next };
      hTgt = next;
      startHighlightAnim();
    }

    // card placement â€” teleport always
    card.style.display = "block";
    card.style.transition = "none";
    const cr = card.getBoundingClientRect();

    const gap = 12;
    const pad = 10;

    const space = {
      top: r.top,
      bottom: window.innerHeight - r.bottom,
      left: r.left,
      right: window.innerWidth - r.right
    };

    const candidates = [
      {
        name: "below",
        top: r.bottom + gap,
        left: clamp(r.left, pad, window.innerWidth - cr.width - pad),
        fits: space.bottom >= cr.height + gap,
        score: space.bottom
      },
      {
        name: "above",
        top: r.top - gap - cr.height,
        left: clamp(r.left, pad, window.innerWidth - cr.width - pad),
        fits: space.top >= cr.height + gap,
        score: space.top
      },
      {
        name: "right",
        top: clamp(r.top, pad, window.innerHeight - cr.height - pad),
        left: r.right + gap,
        fits: space.right >= cr.width + gap,
        score: space.right
      },
      {
        name: "left",
        top: clamp(r.top, pad, window.innerHeight - cr.height - pad),
        left: r.left - gap - cr.width,
        fits: space.left >= cr.width + gap,
        score: space.left
      }
    ];

    let pick = candidates.find(c => c.fits);
    if (!pick) pick = candidates.sort((a,b)=>b.score-a.score)[0];

    const top  = clamp(pick.top,  pad, window.innerHeight - cr.height - pad);
    const left = clamp(pick.left, pad, window.innerWidth  - cr.width  - pad);

    applyPos(card, { top: top + "px", left: left + "px" });
  }

  function schedulePlace(){
    cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(() => {
      const target = findTarget(steps[i]);
      if (target) place(target);
    });
  }

  function render(){
    if (typeof steps[i]?.before === "function") steps[i].before();

    let tries = 0;
    let target = findTarget(steps[i]);
    while (!target && tries < steps.length){
      i = (i + 1) % steps.length;
      if (typeof steps[i]?.before === "function") steps[i].before();
      target = findTarget(steps[i]);
      tries++;
    }
    if (!target) return finish(true);

    titleEl.textContent = steps[i].title;
    bodyEl.textContent  = steps[i].body;
    stepEl.textContent  = `${i+1}/${steps.length}`;

    btnBack.disabled = (i === 0);
    btnNext.textContent = (i === steps.length - 1) ? "Finish" : "Next";

    overlay.classList.add("open");
    overlay.setAttribute("aria-hidden", "false");

    bindScrollTracking(target);

    target.scrollIntoView({
      block: "center",
      inline: "nearest",
      behavior: IS_MOBILE ? "auto" : "smooth"
    });

    clearTimeout(placeTimer1);
    clearTimeout(placeTimer2);

    placeTimer1 = setTimeout(() => schedulePlace(), IS_MOBILE ? 60 : 180);
    placeTimer2 = setTimeout(() => schedulePlace(), IS_MOBILE ? 200 : 260);
  }

  function onReflow(){ schedulePlace(); }

  async function persistSeen(){
    try{
      await fetch("/prefs/labs-tour-seen", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ seen: true })
      });
    }catch(_e){}
  }

  function closeUI(){
    overlay.classList.remove("open");
    overlay.setAttribute("aria-hidden", "true");
    highlight.style.display = "none";
    card.style.display = "none";

    unbindScrollTracking();

    document.body.style.overflow = "";
    window.removeEventListener("resize", onReflow);
    document.removeEventListener("keydown", onKey);

    if (window.visualViewport){
      window.visualViewport.removeEventListener("resize", onReflow);
      window.visualViewport.removeEventListener("scroll", onReflow);
    }

    cancelAnimationFrame(rafId);
    clearTimeout(placeTimer1);
    clearTimeout(placeTimer2);

    cancelAnimationFrame(hAnim);
    hCur = null; hTgt = null;
  }

  async function finish(markSeen){
    closeUI();
    if (markSeen) await persistSeen();
  }

  function onKey(e){
    if (e.key === "Escape") return finish(true);
    if (e.key === "ArrowRight") btnNext.click();
    if (e.key === "ArrowLeft")  btnBack.click();
  }

  btnSkip.addEventListener("click", () => finish(true));
  btnBack.addEventListener("click", () => { if (i > 0) { i--; render(); } });
  btnNext.addEventListener("click", () => {
    if (i >= steps.length - 1) return finish(true);
    i++;
    render();
  });

  // âœ… FIX: donâ€™t let taps inside the card close the tour on mobile
  overlay.addEventListener("click", (e) => {
    if (e.target && card.contains(e.target)) return; // ignore clicks inside card
    finish(true);
  });
  // Also stop bubbling from the card itself (belt + braces)
  card.addEventListener("click", (e) => e.stopPropagation());

  document.body.style.overflow = "hidden";
  window.addEventListener("resize", onReflow);
  document.addEventListener("keydown", onKey);

  if (window.visualViewport){
    window.visualViewport.addEventListener("resize", onReflow);
    window.visualViewport.addEventListener("scroll", onReflow);
  }

  setTimeout(render, 250);
})();
</script>



</body>


</html>





