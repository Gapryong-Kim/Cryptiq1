<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Cipher Lab — Cipher Breaker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    html { overflow-y: scroll; scrollbar-gutter: stable both-edges; }

    .cb-shell {
      min-height: calc(100dvh - 80px);
      display: grid;
      place-items: start center;
      padding: 50px 16px 40px;
      box-sizing: border-box;
    }

    .cb-card {
      width: 100vw;
      max-width: 1080px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--elev-shadow);
      overflow: hidden;
    }

    .cb-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px 20px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(0deg, rgba(0,0,0,0.04), transparent);
    }

    .cb-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent-soft);
    }

    .cb-title {
      margin: 0;
      font-size: 1.1rem;
      letter-spacing: .2px;
      color: var(--text);
      font-weight: 700;
    }

    .cb-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      padding: 18px;
    }

    @media (min-width: 980px) {
      .cb-grid { grid-template-columns: 1.1fr .9fr; gap: 16px; }
    }

    .cb-panel {
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
    }

    .cb-panel h3 {
      margin: 0 0 12px;
      color: var(--accent);
      font-size: 1rem;
      letter-spacing: .2px;
    }

    .cb-row { display: grid; gap: 10px; }

    .cb-help {
      margin-top: 8px;
      color: var(--muted);
      font-size: .92rem;
      line-height: 1.5;
    }

    .cb-actions {
      display: flex; gap: 10px; flex-wrap: wrap;
      align-items: center; margin-top: 6px;
    }

    .btn {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #0f0f0f;
      font-weight: 650;
      font-size: 15px;
      cursor: pointer;
      transition: background .15s ease, box-shadow .18s ease, border-color .18s ease, transform .06s ease;
    }

    .btn:hover {
      background: var(--accent-strong);
      border-color: var(--accent-strong);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }

    .btn:active { transform: translateY(1px); }

    .btn.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line-2);
    }

    .btn.secondary:hover {
      background: var(--input-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .cb-label { font-weight: 600; color: var(--text); }
    .cb-select, .cb-textarea {
      width: 100%;
      box-sizing: border-box;
      color: var(--text);
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
    }

    .cb-select { padding: 10px 12px; font-size: 15px; }
    .cb-textarea {
      min-height: 200px;
      padding: 12px 14px;
      resize: vertical;
      line-height: 1.5;
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      font-size: 15px;
      scrollbar-gutter: stable both-edges;
    }

    .cb-select:hover, .cb-textarea:hover { background: var(--input-hover); }
    .cb-select:focus, .cb-textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .cb-error {
      display: none;
      margin: 12px 0 0;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(255, 83, 83, 0.10);
      border: 1px solid rgba(255, 83, 83, 0.35);
      color: #ff8b8b;
      font-weight: 600;
    }

    .cb-error.show { display: block; }

    .cb-loading {
      display: none;
      align-items: center; gap: 10px;
      color: var(--muted);
      font-size: .95rem;
    }

    .cb-loading.show { display: inline-flex; }

    .spinner {
      border: 4px solid #2a2a2a;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 22px; height: 22px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }

    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    .cb-key {
      margin: 6px 0 10px;
      color: var(--text-dim);
      font-family: 'Fira Code','JetBrains Mono',monospace;
      font-size: .95rem;
      word-break: break-word;
    }

    .cb-pre {
      width: 100%;
      min-height: 220px;
      margin: 0;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 12px 14px;
      color: var(--text);
      font-size: 15px;
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      box-sizing: border-box;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-x: hidden;
      overflow-y: auto;
      scrollbar-gutter: stable both-edges;
    }

    @media (max-width: 480px) {
      .cb-shell { padding: 80px 12px 32px; }
    }
  </style>
</head>

<body>
  {% include 'base_nav.html' %}

  <main class="cb-shell">
    <section class="cb-card cb--square" aria-label="Cipher Breaker">
      <header class="cb-header">
        <span class="cb-dot" aria-hidden="true"></span>
        <h1 class="cb-title">Cipher Breaker</h1>
      </header>

      <div class="cb-grid">
        <!-- LEFT: Input -->
        <div class="cb-panel input-panel">
          <h3>Input</h3>
          <form id="breaker-form" class="cb-row" novalidate>
            <div class="cb-row">
              <label for="cipher_type" class="cb-label">Cipher</label>
              <select name="cipher_type" id="cipher_type" class="cb-select" required>
                <option value="auto">Auto Detect (Try All)</option>
                <option value="caesar" selected>Caesar</option>
                <option value="vigenere">Vigenère</option>
                <option value="affine">Affine</option>
                <option value="amsco">AMSCO</option>
                <option value="railfence">Railfence</option>
                <option value="columnar">Columnar Transposition</option>
                <option value="permutation">Permutation</option>
                <option value="substitution">Basic Substitution</option>
                <option value="polybius">Polybius Square</option>
                <option value="atbash">Atbash</option>
                <option value="base64">Base64</option>
                <option value="hex">Hexadecimal</option>
                <option value="binary">Binary</option>
                <option value="baconian">Baconian</option>
              </select>
            </div>

            <div class="cb-row">
              <label for="ciphertext" class="cb-label">Ciphertext</label>
              <textarea id="ciphertext" name="text" class="cb-textarea"></textarea>
              <p class="cb-help">Tip: longer samples produce better results for classical ciphers.</p>
            </div>

            <div class="cb-actions">
              <button type="submit" id="break-btn" class="btn">Break Cipher</button>
              <button type="button" id="clear-btn" class="btn secondary">Clear</button>
              <div id="loading" class="cb-loading" aria-live="polite">
                <span class="spinner" aria-hidden="true"></span>
                <span>Analyzing…</span>
              </div>
            </div>

            <div id="error-banner" class="cb-error" aria-live="polite">Something went wrong. Please try again.</div>
          </form>
        </div>

        <!-- RIGHT: Output -->
        <div class="cb-panel output-panel">
          <h3>Result</h3>
          <div id="result-key" class="cb-key" style="display:none;"></div>
          <div class="cb-actions" style="margin-bottom: 10px;">
            <button id="copy-btn" class="btn secondary" style="display:none;">Copy Plaintext</button>
          </div>
          <pre id="result-text" class="cb-pre" aria-live="polite"></pre>
        </div>
      </div>
    </section>
  </main>

  <script>
    const form = document.getElementById("breaker-form");
    const breakBtn = document.getElementById("break-btn");
    const clearBtn = document.getElementById("clear-btn");
    const loading = document.getElementById("loading");
    const resultText = document.getElementById("result-text");
    const resultKey = document.getElementById("result-key");
    const copyBtn = document.getElementById("copy-btn");
    const errorBanner = document.getElementById("error-banner");
    const textarea = document.getElementById("ciphertext");

    const funSamples = [
      "I told my toaster to encrypt my breakfast, but it just gave me burnt toast.",
      "This sentence knows it’s about to be encrypted and is very nervous.",
      "My secret code is hidden in plain sight, but even I forgot the key.",
      "Somewhere, a potato is learning Morse code faster than I can learn Python.",
      "Warning: decoding this message may summon unintended consequences.",
      "The cake is a cipher. You just haven’t decrypted it yet.",
      "Behind every random string lies someone trying to be mysterious.",
      "Sometimes I encrypt my thoughts just so I can feel like a secret agent.",
      "I whispered my password to a pigeon. I regret everything.",
      "My diary is written entirely in base64. Even I can’t read it anymore.",
      "The vending machine only accepts encrypted coins.",
      "Somewhere, a cat just brute-forced the Wi-Fi.",
      "My coffee tastes like ciphertext and regret.",
      "I accidentally encrypted my shopping list. Now I just buy random stuff.",
      "Trust no one. Except maybe the hash function.",
      "I lost my key… literally. It’s somewhere in the cipher.",
      "The real ciphertext was the friends we made along the way.",
      "I asked for a decryption key and got a therapy session instead.",
      "The key was under the doormat the whole time."
    ];

    textarea.value = funSamples[Math.floor(Math.random() * funSamples.length)];

    function showError(msg) {
      errorBanner.textContent = msg || "Something went wrong. Please try again.";
      errorBanner.classList.add("show");
    }

    function clearError() { errorBanner.classList.remove("show"); }

    function setLoading(isLoading) {
      loading.classList.toggle("show", isLoading);
      breakBtn.disabled = isLoading;
      clearBtn.disabled = isLoading;
    }

    clearBtn.addEventListener("click", () => {
      textarea.value = funSamples[Math.floor(Math.random() * funSamples.length)];
      resultText.textContent = "";
      resultKey.style.display = "none";
      copyBtn.style.display = "none";
      clearError();
      textarea.focus();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearError();
      const text = textarea.value.trim();
      if (!text) {
        showError("Please paste some ciphertext first.");
        return;
      }

      setLoading(true);
      try {
        const formData = new FormData(form);
        const res = await fetch('{{ url_for("breaker") }}', { method: "POST", body: formData });
        if (!res.ok) throw new Error("Network error");
        const data = await res.json();

        resultText.textContent = data.text || "";
        if (data.key) {
          resultKey.style.display = "block";
          resultKey.textContent = `Key: ${typeof data.key === 'string' ? data.key : JSON.stringify(data.key)}`;
        } else {
          resultKey.style.display = "none";
        }
        copyBtn.style.display = data.text ? "inline-flex" : "none";
        if (!data.text) showError("No plaintext produced. Try a different cipher type or provide more text.");
      } catch (err) {
        showError("Unable to reach the server. Please try again.");
      } finally {
        setLoading(false);
      }
    });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(resultText.textContent || "");
        copyBtn.textContent = "Copied!";
        setTimeout(() => (copyBtn.textContent = "Copy Plaintext"), 1400);
      } catch {
        copyBtn.textContent = "Failed to copy";
        setTimeout(() => (copyBtn.textContent = "Copy Plaintext"), 1400);
      }
    });
  </script>
</body>
</html>
