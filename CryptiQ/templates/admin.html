<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin — The Cipher Lab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    :root{
      --muted: var(--subtext, #bcbcbc);
      --line: var(--border, rgba(255,255,255,0.08));
      --panel-2: var(--panel, #1a1a1a);
      --radius-lg: 14px;
      --radius-sm: 10px;
      --elev-shadow: 0 10px 35px rgba(0,0,0,0.4);
      --danger: #ff4d4f;
      --transition: 0.25s ease;
    }

    /* ===============================
       Admin Dashboard
    =============================== */
    .admin-container {
      width: 100%;
      max-width: 1100px;
      margin: 120px auto 60px;
      padding: 40px 48px;
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--line);
      box-shadow: var(--elev-shadow);
      overflow: hidden; /* ✅ clips borders inside rounded card on mobile */
    }

    .admin-title {
      font-size: 34px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .admin-subtitle {
      color: var(--muted);
      margin-bottom: 20px;
    }

    /* === Search === */
    .admin-search {
      position: relative;
      width: min(620px, 100%);
      margin-bottom: 18px;
    }

    .admin-search input {
      width: 100%;
      padding: 14px 48px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--panel);
      color: var(--text);
      font-size: 1rem;
    }

    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      opacity: 0.6;
      pointer-events: none;
    }

    /* ✅ Table scroll wrapper */
    .admin-table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* === Table === */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
    }

    .admin-table th {
      text-align: left;
      padding: 14px 12px;
      color: var(--accent);
      border-bottom: 1px solid var(--line);
      font-size: 14px;
      font-weight: 700;
    }

    .admin-table td {
      padding: 14px 12px;
      border-bottom: 1px solid var(--line);
      vertical-align: middle;
    }

    .admin-table tr:hover {
      background: var(--panel-2);
    }

    .tag-active { color: var(--accent); font-weight: 700; }
    .tag-banned { color: var(--danger); font-weight: 700; }

    .ban-btn {
      padding: 8px 14px;
      font-weight: 700;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      transition: transform .08s ease;
      white-space: nowrap;
    }

    .ban-btn.ban { background: var(--danger); color: #0f0f0f; }
    .ban-btn.unban { background: var(--accent); color: #0f0f0f; }

    .ban-btn:hover { transform: translateY(-1px); }

    /* ===============================
       CONFIRM MODAL
    =============================== */
    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5000;
    }

    .confirm-overlay.open { display: flex; }

    .confirm-box {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 22px 26px;
      width: min(360px, 90%);
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
      animation: pop .18s ease-out;
      text-align: center;
    }

    .confirm-box h3 {
      margin: 0 0 8px;
      font-size: 1.25rem;
      color: var(--text);
    }

    .confirm-box p {
      color: var(--muted);
      margin-bottom: 18px;
    }

    .confirm-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .confirm-cancel {
      background: var(--panel-2);
      color: var(--text);
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .confirm-confirm {
      background: var(--danger);
      color: #0f0f0f;
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }

    @keyframes pop {
      from { transform: scale(.88); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* ===============================
       MOBILE TABLE FIX (Admin)
    =============================== */
    .admin-table-wrap::-webkit-scrollbar {
      height: 8px;
    }
    .admin-table-wrap::-webkit-scrollbar-thumb {
      background: var(--line);
      border-radius: 8px;
    }

    @media (max-width: 820px) {
      .admin-container {
        margin: 92px 12px 40px;
        padding: 22px 16px;
        border-radius: 12px;
      }

      .admin-title {
        font-size: 28px;
        line-height: 1.15;
      }

      .admin-subtitle {
        margin-bottom: 14px;
        font-size: 0.95rem;
      }

      .admin-search {
        width: 100%;
        margin-bottom: 14px;
      }

      .admin-search input {
        padding: 12px 44px;
        font-size: 0.98rem;
      }

      .search-icon {
        left: 14px;
        width: 18px;
        height: 18px;
      }

      /* ✅ Force horizontal scroll instead of overflowing the card */
      .admin-table {
        min-width: 760px;
      }

      .admin-table th,
      .admin-table td {
        padding: 12px 10px;
        font-size: 0.92rem;
        white-space: nowrap;
      }

      .ban-btn {
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 10px;
      }
    }

    @media (max-width: 480px) {
      .admin-container {
        margin: 84px 10px 34px;
        padding: 18px 12px;
      }

      .admin-title {
        font-size: 24px;
      }

      .admin-search input {
        padding: 12px 42px;
        font-size: 0.95rem;
      }

      .confirm-box {
        width: min(340px, 92%);
        padding: 18px 16px;
      }

      .confirm-actions {
        gap: 10px;
      }

      .confirm-cancel,
      .confirm-confirm {
        padding: 9px 12px;
        width: 45%;
      }
    }
  </style>
</head>

<body>
{% include 'base_nav.html' %}

<div class="admin-container">
  <h1 class="admin-title">Admin Dashboard</h1>
  <p class="admin-subtitle">Manage users and moderation</p>

  <div class="admin-search">
    <input id="admin-search" placeholder="Search users…" />
    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
  </div>

  <!-- ✅ wrap table so it scrolls on mobile instead of overflowing -->
  <div class="admin-table-wrap">
    <table class="admin-table" id="user-table">
      <thead>
        <tr>
          <th>Username</th><th>Email</th><th>Joined</th><th>Status</th><th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
        <tr data-username="{{ u.username|lower }}" data-email="{{ (u.email or '')|lower }}" id="user-{{ u.username }}">
          <td><strong>{{ u.username }}</strong> {% if u.is_admin %}<span class="admin-badge">Admin</span>{% endif %}
            {% if u.is_pro %}
  <span class="pro-badge">PRO</span>
{% endif %}</td>
          
          <td>{{ u.email }}</td>
          <td>{{ u.created_at }}</td>
          <td class="status">
            {% if u.banned %}
              <span class="tag-banned">Banned</span>
            {% else %}
              <span class="tag-active">Active</span>
            {% endif %}
          </td>
          <td>
            {% if u.username == user.username %}
              <em>You</em>
            {% elif u.is_admin %}
              <em>Admin</em>
            {% else %}
              {% if u.banned %}
                <button class="ban-btn unban" data-user="{{ u.username }}" data-banned="1">Unban</button>
              {% else %}
                <button class="ban-btn ban" data-user="{{ u.username }}" data-banned="0">Ban</button>
              {% endif %}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div id="confirm-overlay" class="confirm-overlay">
  <div class="confirm-box">
    <h3 id="confirm-title">Confirm</h3>
    <p id="confirm-text"></p>
    <div class="confirm-actions">
      <button class="confirm-cancel">Cancel</button>
      <button class="confirm-confirm">Confirm</button>
    </div>
  </div>
</div>

<script>
/* ===============================
   FUZZY SEARCH (username + email)
   - tolerant to typos
=============================== */
function levenshtein(a, b) {
  a = (a || "");
  b = (b || "");
  const la = a.length, lb = b.length;
  if (!la) return lb;
  if (!lb) return la;

  const dp = Array.from({ length: lb + 1 }, () => Array(la + 1).fill(0));
  for (let i = 0; i <= lb; i++) dp[i][0] = i;
  for (let j = 0; j <= la; j++) dp[0][j] = j;

  for (let i = 1; i <= lb; i++) {
    for (let j = 1; j <= la; j++) {
      const cost = a[j - 1] === b[i - 1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i - 1][j] + 1,
        dp[i][j - 1] + 1,
        dp[i - 1][j - 1] + cost
      );
    }
  }
  return dp[lb][la];
}

function tokenScore(hay, q) {
  // returns 0 if no meaningful match
  if (!q) return 1;

  if (hay === q) return 10_000;
  if (hay.startsWith(q)) return 6_000;
  if (hay.includes(q)) return 3_000;

  // fuzzy over whole string
  const d = levenshtein(hay, q);
  if (d <= 1) return 1_500;
  if (d <= 2) return 700;
  if (d <= 3) return 250;

  // fuzzy per-word (helps "john g" match "john@gmail.com")
  const words = hay.split(/[^a-z0-9]+/).filter(Boolean);
  let best = 0;
  for (const w of words) {
    if (w === q) best = Math.max(best, 1200);
    else if (w.startsWith(q)) best = Math.max(best, 700);
    else if (w.includes(q)) best = Math.max(best, 420);
    else {
      const dw = levenshtein(w, q);
      if (dw === 1) best = Math.max(best, 260);
      if (dw === 2) best = Math.max(best, 120);
    }
  }
  return best;
}

function scoreRow(username, email, rawQuery) {
  const q = (rawQuery || "").trim().toLowerCase();
  if (!q) return 1;

  const u = (username || "").toLowerCase();
  const e = (email || "").toLowerCase();

  const qParts = q.split(/\s+/).filter(Boolean);

  let score = 0;

  // boost full-query matches
  score += tokenScore(u, q);
  score += tokenScore(e, q);

  // also score each token (so "john gm" works)
  for (const t of qParts) {
    if (t.length <= 1) continue;
    score += tokenScore(u, t);
    score += tokenScore(e, t);
  }

  return score;
}

const adminSearchEl = document.getElementById("admin-search");
adminSearchEl.addEventListener("input", () => {
  const raw = adminSearchEl.value;
  const rows = document.querySelectorAll("#user-table tbody tr");

  rows.forEach(r => {
    const u = r.dataset.username || "";
    const e = r.dataset.email || "";
    const s = scoreRow(u, e, raw);

    // threshold: hide weak matches when query exists
    r.style.display = (raw.trim() ? s >= 300 : true) ? "" : "none";
  });
});


/* ===============================
   CONFIRM MODAL LOGIC
=============================== */
const overlay = document.getElementById("confirm-overlay");
const text = document.getElementById("confirm-text");
let pendingAction = null;

function openConfirm(msg, action) {
  text.textContent = msg;
  pendingAction = action;
  overlay.classList.add("open");
}

function closeConfirm() {
  overlay.classList.remove("open");
  pendingAction = null;
}

overlay.addEventListener("click", e => {
  if (e.target === overlay) closeConfirm();
});

document.querySelector(".confirm-cancel").onclick = closeConfirm;
document.querySelector(".confirm-confirm").onclick = () => {
  if (pendingAction) pendingAction();
  closeConfirm();
};


/* ===============================
   BAN / UNBAN
=============================== */
document.addEventListener("click", e => {
  const btn = e.target.closest(".ban-btn");
  if (!btn) return;

  const username = btn.dataset.user;
  const banned = btn.dataset.banned === "1";

  openConfirm(
    banned ? `Unban ${username}?` : `Ban ${username}?`,
    () => toggleBan(username, banned)
  );
});

async function toggleBan(username, currentlyBanned) {
  const row = document.getElementById(`user-${username}`);
  const status = row.querySelector(".status");
  const btn = row.querySelector(".ban-btn");

  btn.disabled = true;
  btn.textContent = "Updating…";

  try {
    const res = await fetch("/admin/ban_user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, banned: currentlyBanned ? 0 : 1 })
    });

    const data = await res.json();
    if (!res.ok || !data.ok) {
      alert(data.error || "Failed");
      return;
    }

    if (data.banned) {
      status.innerHTML = `<span class="tag-banned">Banned</span>`;
      btn.textContent = "Unban";
      btn.className = "ban-btn unban";
      btn.dataset.banned = "1";
    } else {
      status.innerHTML = `<span class="tag-active">Active</span>`;
      btn.textContent = "Ban";
      btn.className = "ban-btn ban";
      btn.dataset.banned = "0";
    }
  } catch (err) {
    console.error(err);
    alert("Network error");
  } finally {
    btn.disabled = false;
  }
}
</script>

</body>
</html>
