{% extends "base_nav.html" %}
{% block content %}

<style>

/* === Admin Page Styles (Self-contained) === */

.admin-wrapper {
    padding: 140px 20px 40px;
    max-width: 1100px;
    margin: auto;
}

.admin-title {
    font-size: 42px;
    font-weight: 800;
    margin-bottom: 15px;
    color: var(--accent);
    text-shadow: 0 0 18px var(--accentglow);
}

/* Card container */
.admin-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 22px;
    margin-top: 35px;
}

.admin-card {
    background: var(--panel);
    border-radius: 16px;
    padding: 22px;
    box-shadow: 0 0 15px var(--shadow);
    transition: 0.25s;
    border: 1px solid var(--border);
}

.admin-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 0 25px var(--accentglow);
}

/* Headings */
.admin-card h3 {
    margin-top: 0;
    color: var(--accent);
    font-size: 22px;
    margin-bottom: 8px;
}

/* Buttons */
.admin-btn {
    margin-top: 8px;
    display: inline-block;
    padding: 6px 12px;
    border-radius: 8px;
    background: var(--accent);
    color: black;
    font-weight: bold;
    text-decoration: none;
    box-shadow: 0 0 10px var(--accentglow);
    cursor: pointer;
    border: none;
    font-size: 14px;
}

.admin-btn:hover {
    box-shadow: 0 0 16px var(--accentglow);
}

/* Tables */
.admin-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 35px;
}

.admin-table th {
    text-align: left;
    padding: 12px;
    border-bottom: 1px solid var(--border);
    color: var(--accent);
}

.admin-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border2);
}

.admin-table tr:hover {
    background: var(--panel2);
}

/* Status tags */
.tag-active {
    color: #00ffae;
    font-weight: bold;
}

.tag-banned {
    color: #ff2e5f;
    font-weight: bold;
}

</style>

<div class="admin-wrapper">

    <h1 class="admin-title">Admin Dashboard</h1>

    <p style="opacity: 0.85;">Manage everything from posts to users, announcements, ciphers, and more.</p>

    <!-- Quick Access Cards -->
    <div class="admin-grid">

        <div class="admin-card">
            <h3>Create New Post</h3>
            <p>Add a new post to the community feed.</p>
            <a href="/admin/new-post" class="admin-btn">Open</a>
        </div>

        <div class="admin-card">
            <h3>Announcements</h3>
            <p>Publish site-wide updates for all users.</p>
            <a href="/admin/announcements" class="admin-btn">Open</a>
        </div>

        <div class="admin-card">
            <h3>Weekly Cipher</h3>
            <p>Update the weekly challenge puzzle + leaderboard.</p>
            <a href="/admin/weekly" class="admin-btn">Open</a>
        </div>

        <div class="admin-card">
            <h3>User Management</h3>
            <p>Ban users, manage permissions, reset passwords.</p>
            <a href="/admin/users" class="admin-btn">Open</a>
        </div>

    </div>

    <!-- Users Table -->
    {% if users %}
    <h2 style="margin-top: 50px; color: var(--accent);">Users</h2>

    <table class="admin-table">
        <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Joined</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>

        {% for u in users %}
        <tr id="user-{{ u.id }}">
            <td>{{ u.username }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.created_at }}</td>
            <td class="status">
                {% if u.banned %}
                    <span class="tag-banned">Banned</span>
                {% else %}
                    <span class="tag-active">Active</span>
                {% endif %}
            </td>
            <td>
                {% if u.id != user.id %}
                <button class="admin-btn" onclick="toggleBan({{ u.id }}, {{ 'true' if u.banned else 'false' }})">
                    {% if u.banned %}Unban{% else %}Ban{% endif %}
                </button>

                <button class="admin-btn" onclick="toggleAdmin({{ u.id }}, {{ 'true' if u.is_admin else 'false' }})">
                    {% if u.is_admin %}Demote{% else %}Promote{% endif %}
                </button>

                <button class="admin-btn" onclick="deleteUser({{ u.id }})">Delete</button>
                {% else %}
                <em>Self</em>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}

</div>

<script>
async function toggleBan(userId, currentlyBanned) {
    const response = await fetch(`/admin/users/${userId}/ban`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ban: !currentlyBanned})
    });
    const data = await response.json();
    if(data.success){
        const row = document.getElementById(`user-${userId}`);
        row.querySelector('.status').innerHTML = data.banned ? '<span class="tag-banned">Banned</span>' : '<span class="tag-active">Active</span>';
        row.querySelector('button:nth-child(1)').textContent = data.banned ? 'Unban' : 'Ban';
    }
}

async function toggleAdmin(userId, currentlyAdmin) {
    const response = await fetch(`/admin/users/${userId}/admin`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({admin: !currentlyAdmin})
    });
    const data = await response.json();
    if(data.success){
        const row = document.getElementById(`user-${userId}`);
        row.querySelector('button:nth-child(2)').textContent = data.is_admin ? 'Demote' : 'Promote';
    }
}

async function deleteUser(userId){
    if(!confirm('Are you sure you want to delete this user?')) return;
    const response = await fetch(`/admin/users/${userId}/delete`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    });
    const data = await response.json();
    if(data.success){
        const row = document.getElementById(`user-${userId}`);
        row.remove();
    }
}
</script>

{% endblock %}
