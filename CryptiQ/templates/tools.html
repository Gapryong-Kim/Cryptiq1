<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CryptiQ — Tools</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Page shell ===== */
    .tools-shell {
      width: 100%;
      max-width: 820px;
      margin: 120px auto 60px;
      background: var(--panel);
      padding: 40px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--line);
      box-shadow: var(--elev-shadow);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .tools-title {
      color: var(--accent);
      text-align: center;
      font-size: 1.9rem;
      font-weight: 800;
      margin: 0 0 6px;
      letter-spacing: .2px;
    }
    .tools-subtitle {
      text-align: center;
      color: var(--muted);
      margin: 0 0 8px;
      font-size: .95rem;
    }

    /* Selector row */
    .tools-row {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 14px;
      align-items: center;
    }
    .cipher-label { color: var(--text-dim); font-weight: 600; }

    #tool-select {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: var(--radius-sm);
      color: var(--text);
      padding: 12px 14px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      box-sizing: border-box;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }
    #tool-select:hover { background: var(--input-hover); }
    #tool-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
      background: var(--input-focus);
    }

    /* Tool card */
    .tool-card {
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .tool-description {
      color: var(--muted);
      font-size: .95rem;
      line-height: 1.55;
      background: transparent;
      border-radius: var(--radius-md);
      padding: 0;
      margin: 0;
    }

    /* Inputs */
    textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      padding: 14px;
      font-family: 'Fira Code', 'JetBrains Mono', monospace;
      font-size: 1rem;
      min-height: 160px;
      resize: vertical;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
      box-sizing: border-box;
    }
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .inline-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
    .num-input {
      width: 90px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .num-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    /* Buttons */
    .btn {
      background: var(--accent);
      border: 1px solid var(--accent);
      color: #0f0f0f;
      border-radius: var(--radius-sm);
      padding: 12px 18px;
      font-weight: 800;
      cursor: pointer;
      transition: background .15s ease, box-shadow .18s ease, border-color .18s ease, transform .06s ease;
      display: inline-flex;
      align-items: center;
      gap: .5rem;
    }
    .btn:hover { background: var(--accent-strong); box-shadow: 0 6px 18px rgba(0,0,0,.35); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line);
    }
    .btn.secondary:hover { border-color: var(--accent); }

    /* Outputs */
    .result-box {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 14px;
      white-space: pre-wrap;
      color: var(--text);
      font-family: 'Fira Code', monospace;
      font-size: .95rem;
      min-height: 48px;
    }

    /* Substitution grid */
    #substitution-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(46px, 1fr));
      gap: 10px;
      margin-top: 6px;
      justify-items: center;
      align-items: end;
    }
    .sub-letter-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      width: 48px;
      padding: 8px 6px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
    }
    .sub-top {
      color: var(--text-dim);
      font-size: .85rem;
      font-weight: 700;
      letter-spacing: .3px;
      line-height: 1;
    }
    .sub-arrow {
      font-size: .8rem;
      color: var(--muted-2);
      line-height: 1;
      user-select: none;
    }
    .sub-input {
      width: 36px;
      height: 34px;
      text-align: center;
      border: 1px solid var(--input-border);
      border-radius: var(--radius-sm);
      background: var(--input-bg);
      color: var(--text);
      font-family: 'Fira Code', monospace;
      font-size: 15px;
      text-transform: lowercase;
      transition: .18s ease;
    }
    .sub-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    /* Helper bar */
    .helper-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
      border-top: 1px dashed var(--line);
      padding-top: 12px;
      margin-top: -4px;
    }
    .helper-right { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Mobile tweaks */
    @media (max-width: 860px) {
      .tools-shell { margin: 110px 16px 48px; padding: 24px; }
      .tools-row { grid-template-columns: 1fr; gap: 8px; }
      .btn { width: 100%; justify-content: center; }
      .helper-right .btn { width: auto; }
    }
    @media (max-width: 480px) {
      .tools-title { font-size: 1.6rem; }
      .sub-letter-box { width: 44px; padding: 6px; }
      .sub-input { width: 32px; height: 32px; font-size: 14px; }
    }
  </style>
</head>
<body>
  {% include 'base_nav.html' %}

  <div class="tools-shell">
    <h1 class="tools-title">Tools</h1>
    <p class="tools-subtitle">Pick a tool to analyse or prep your ciphertext. Mobile-friendly, snappy, and clean.</p>

    <div class="tools-row">
      <label for="tool-select" class="cipher-label">Select Tool</label>
      <select id="tool-select">
        <option value="">— Choose a Tool —</option>
        <option value="frequency">Frequency Analyzer</option>
        <option value="polybius">Polybius Standardizer</option>
        <option value="substitution">Substitution Cipher Analyzer</option>
        <option value="unique">Unique Symbol Finder</option>
        <option value="text_spacer">Text Spacer</option>
      </select>
    </div>

    <div id="tool-container" class="tool-card" style="display:none;"></div>
  </div>

  <script>
    const toolSelect = document.getElementById("tool-select");
    const toolContainer = document.getElementById("tool-container");
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

    const toolExplanations = {
      frequency: "Counts how often each letter appears. Great first step for substitution-style ciphers.",
      polybius:  "Normalizes Polybius outputs to a clean letter stream you can feed into other tools.",
      substitution: "Map each ciphertext letter to a plaintext guess. Cipher (top) → your guess (bottom). Live preview updates in the textarea.",
      unique:    "Splits text into blocks of length n and counts unique blocks. Helpful for pattern hunting.",
      text_spacer: "Removes spaces, then re-blocks your text into fixed-size chunks for readability and analysis."
    };

    const showCard = () => { toolContainer.style.display = 'flex'; };

    toolSelect.addEventListener("change", async () => {
      toolContainer.innerHTML = "";
      const selected = toolSelect.value;
      if (!selected) { toolContainer.style.display = 'none'; return; }
      showCard();

      /* ---------- Substitution Analyzer ---------- */
      if (selected === "substitution") {
        toolContainer.innerHTML = `
          <p class="tool-description">${toolExplanations['substitution']}</p>
          <textarea id="ciphertext" placeholder="Paste ciphertext here…"></textarea>
          <div id="substitution-row" aria-label="Substitution grid"></div>

          <div class="helper-bar">
            <div class="helper-left" style="color:var(--muted);font-size:.92rem;">
              Tip: Enter lowercase plaintext guesses. Use Frequency Analyzer for hints.
            </div>
            <div class="helper-right">
              <button class="btn secondary" id="clear-mapping" type="button">Clear Mapping</button>
              <button class="btn secondary" id="reset-text" type="button">Reset Text</button>
            </div>
          </div>

          <div class="result-box" id="frequency-output" aria-live="polite"></div>
        `;

        const substitutionRow = document.getElementById("substitution-row");
        const mapping = {};   // mapping[cipherLetter] = plaintextGuess(lowercase) or ""
        let originalText = "";
        const textarea = document.getElementById("ciphertext");
        const freqOutput = document.getElementById("frequency-output");

        // Build tiles: Cipher on top → user input (plaintext) below, with a small arrow
        alphabet.forEach(cipherLetter => {
          const box = document.createElement("div");
          box.className = "sub-letter-box";
          const top = document.createElement("span");
          top.className = "sub-top";
          top.textContent = cipherLetter;

          const arrow = document.createElement("span");
          arrow.className = "sub-arrow";
          arrow.textContent = "↓";

          const input = document.createElement("input");
          input.className = "sub-input";
          input.maxLength = 1;
          input.dataset.cipher = cipherLetter;
          input.placeholder = "…";

          input.addEventListener("input", () => {
            const cipher = input.dataset.cipher;
            const plain = (input.value || "").toLowerCase();
            mapping[cipher] = plain;
            updateTextarea();
          });

          box.appendChild(top);
          box.appendChild(arrow);
          box.appendChild(input);
          substitutionRow.appendChild(box);
          mapping[cipherLetter] = "";
        });

        // Live textarea mapping
        textarea.addEventListener("input", async () => {
          originalText = textarea.value.toUpperCase();
          updateTextarea();

          // frequency call
          if (originalText.trim()) {
            try {
              const formData = new FormData();
              formData.append("text", originalText);
              formData.append("tool_type", "frequency");
              const res = await fetch("/tools/run", { method: "POST", body: formData });
              const data = await res.json();
              freqOutput.innerText = data.text || "";
            } catch (e) {
              freqOutput.innerText = "Error fetching frequency analysis.";
            }
          } else {
            freqOutput.innerText = "";
          }
        });

        function updateTextarea() {
          // Render plaintext guesses inline (letters not mapped stay as original)
          let out = "";
          for (let ch of originalText) {
            out += mapping[ch] !== undefined && mapping[ch] !== "" ? mapping[ch] : ch;
          }
          textarea.value = out;
        }

        // helper buttons
        document.getElementById("clear-mapping").addEventListener("click", () => {
          substitutionRow.querySelectorAll(".sub-input").forEach(inp => inp.value = "");
          Object.keys(mapping).forEach(k => mapping[k] = "");
          updateTextarea();
        });
        document.getElementById("reset-text").addEventListener("click", () => {
          textarea.value = originalText;
          freqOutput.innerText = "";
        });
      }

      /* ---------- Frequency / Polybius / Unique / Text Spacer ---------- */
      else if (["frequency", "polybius", "unique", "text_spacer"].includes(selected)) {
        let extra = "";
        if (selected === "text_spacer") {
          extra = `
            <div class="inline-controls">
              <label for="block-length" class="cipher-label">Block Length</label>
              <input type="number" id="block-length" min="1" value="5" class="num-input">
            </div>
          `;
        }
        if (selected === "unique") {
          extra = `
            <div class="inline-controls">
              <label for="block-length" class="cipher-label">Block Length</label>
              <input type="number" id="block-length" min="1" value="2" class="num-input">
            </div>
          `;
        }

        toolContainer.innerHTML = `
          <p class="tool-description">${toolExplanations[selected]}</p>
          <textarea id="tool-text" placeholder="Paste or type your text…"></textarea>
          ${extra}
          <button id="tools-run" class="btn" type="button">Run</button>
          <div id="tool-result" class="result-box" aria-live="polite"></div>
        `;

        document.getElementById("tools-run").addEventListener("click", async () => {
          const text = document.getElementById("tool-text").value;
          const formData = new FormData();
          formData.append("text", text);
          formData.append("tool_type", selected);

          const blockEl = document.getElementById("block-length");
          if (blockEl) formData.append("block_length", blockEl.value);

          const res = await fetch("/tools/run", { method: "POST", body: formData });
          const data = await res.json();
          document.getElementById("tool-result").innerText = data.text || "";
        });
      }
    });
  </script>
</body>
</html>
