<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Cipher Lab — Tools</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    html { overflow-y: scroll; scrollbar-gutter: stable both-edges; }

    .cb-shell {
      min-height: calc(100dvh - 80px);
      display: grid;
      place-items: start center;
      padding: 50px 16px 40px;
      box-sizing: border-box;
    }

    .cb-card {
      width: 100vw;
      max-width: 1000px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--elev-shadow);
      overflow: hidden;
      animation: fadeIn .5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cb-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px 22px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(0deg, rgba(0,0,0,0.04), transparent);
    }

    .cb-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent-soft);
    }

    .cb-title {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text);
      font-weight: 700;
      letter-spacing: .2px;
    }

    .tools-grid {
      display: grid;
      gap: 18px;
      padding: 20px;
    }

    @media (min-width: 900px) {
      .tools-grid { grid-template-columns: 1fr; }
    }

    .cb-panel {
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 20px;
    }

    .cb-panel h3 {
      margin: 0 0 12px;
      color: var(--accent);
      font-size: 1rem;
      letter-spacing: .2px;
    }

    .cipher-label {
      color: var(--text);
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }

    select, textarea, input[type="number"], input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: var(--text);
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 15px;
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
    }

    select:hover, textarea:hover, input:hover { background: var(--input-hover); }
    select:focus, textarea:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .btn {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #0f0f0f;
      font-weight: 650;
      font-size: 15px;
      cursor: pointer;
      transition: background .15s ease, box-shadow .18s ease, transform .06s ease;
    }

    .btn:hover {
      background: var(--accent-strong);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }

    .btn.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line-2);
    }

    .btn.secondary:hover {
      background: var(--input-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .btn.copy-btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      font-size: .9rem;
      margin-top: 10px;
      align-self: flex-end;
      cursor: pointer;
      transition: all .2s ease;
    }
    .btn.copy-btn:hover { background: var(--accent); color: #0f0f0f; }

    .result-box {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 14px;
      color: var(--text);
      font-family: 'Fira Code', monospace;
      font-size: .95rem;
      min-height: 48px;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top: 10px;
    }

    .sub-letter-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      width: 48px;
      padding: 8px 6px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
    }

    .sub-top { color: var(--text-dim); font-size: .85rem; font-weight: 700; text-transform: lowercase; }
    .sub-arrow { font-size: .8rem; color: var(--muted-2); }
    .sub-input {
      width: 36px;
      height: 34px;
      text-align: center;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text);
      font-family: 'Fira Code', monospace;
      font-size: 15px;
      transition: .18s ease;
    }
    .sub-input:focus {
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
      outline: none;
    }

    .helper-bar {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      border-top: 1px dashed var(--line);
      padding-top: 12px;
      margin-top: 8px;
      font-size: .9rem;
      color: var(--muted);
    }

    @media (max-width: 720px) {
      .cb-shell { padding: 80px 12px 32px; }
      .cb-panel { padding: 14px; }
      .btn { width: 100%; }
      .btn.copy-btn { width: 100%; text-align: center; }
    }
  </style>
</head>

<body>
  {% include 'base_nav.html' %}

  <main class="cb-shell">
    <section class="cb-card" aria-label="Cipher Tools">
      <header class="cb-header">
        <span class="cb-dot"></span>
        <h1 class="cb-title">Cipher Tools</h1>
      </header>

      <div class="tools-grid">
        <div class="cb-panel">
          <h3>Select Tool</h3>
          <select id="tool-select">
            <option value="frequency" selected>Frequency Analyzer</option>
            <option value="polybius">Polybius Standardizer</option>
            <option value="substitution">Substitution Cipher Analyzer</option>
            <option value="unique">Unique Symbol Finder</option>
            <option value="text_spacer">Text Spacer</option>
            <option value="text_replacer">Text Replacer</option>
          </select>
        </div>

        <div id="tool-container" class="cb-panel" style="display:none;"></div>
      </div>
    </section>
  </main>

  <script>
  (function () {
    const toolSelect = document.getElementById("tool-select");
    const toolContainer = document.getElementById("tool-container");
    const alphabet = 'abcdefghijklmnopqrstuvwxyz'.split('');

    const toolExplanations = {
      frequency: "Counts how often each letter appears. Great first step for substitution-style ciphers.",
      polybius: "Normalizes Polybius outputs to a clean letter stream you can feed into other tools.",
      substitution: "Map each plaintext letter (top) to a ciphertext letter (input).",
      unique: "Splits text into blocks of length n and counts unique blocks. Helpful for pattern hunting.",
      text_spacer: "Removes spaces, then re-blocks your text into fixed-size chunks for readability.",
      text_replacer: "Replaces every occurrence of one substring with another. Case-sensitive."
    };

    const showCard = () => { toolContainer.style.display = 'flex'; toolContainer.style.flexDirection = 'column'; };

    function addCopyButton(targetId) {
      const btn = document.createElement("button");
      btn.className = "btn copy-btn";
      btn.textContent = "Copy";
      btn.onclick = () => {
        const text = document.getElementById(targetId).innerText;
        navigator.clipboard.writeText(text);
        btn.textContent = "Copied!";
        btn.style.background = "var(--accent)";
        btn.style.color = "#0f0f0f";
        setTimeout(() => {
          btn.textContent = "Copy";
          btn.style.background = "transparent";
          btn.style.color = "var(--accent)";
        }, 1000);
      };
      return btn;
    }

    function renderTool(selected) {
      toolContainer.innerHTML = "";
      if (!selected) { toolContainer.style.display = 'none'; return; }
      showCard();

      // --- Substitution ---
      if (selected === "substitution") {
        toolContainer.innerHTML = `
          <p style="color:var(--muted);font-size:.95rem;margin:0 0 10px;">${toolExplanations['substitution']}</p>
          <textarea id="ciphertext" placeholder="Paste ciphertext here…" style="min-height:160px;"></textarea>
          <div id="substitution-row" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(46px,1fr));gap:10px;margin-top:10px;"></div>
          <div class="helper-bar">
            <div>Tip: Ciphertext input goes <strong>below</strong> each lowercase letter marker.</div>
            <div style="display:flex;gap:8px;">
              <button class="btn secondary" id="clear-mapping" type="button">Clear Mapping</button>
              <button class="btn secondary" id="reset-text" type="button">Reset Text</button>
            </div>
          </div>
          <div id="frequency-output" class="result-box"></div>
        `;
        const copyBtn = addCopyButton("frequency-output");
        toolContainer.appendChild(copyBtn);

        const substitutionRow = document.getElementById("substitution-row");
        const mapping = {};
        let originalText = "";
        const textarea = document.getElementById("ciphertext");
        const freqOutput = document.getElementById("frequency-output");

        alphabet.forEach(plainLetter => {
          const box = document.createElement("div");
          box.className = "sub-letter-box";
          const top = document.createElement("span");
          top.className = "sub-top";
          top.textContent = plainLetter;
          const arrow = document.createElement("span");
          arrow.className = "sub-arrow";
          arrow.textContent = "↓";
          const input = document.createElement("input");
          input.className = "sub-input";
          input.maxLength = 1;
          input.dataset.plain = plainLetter;
          input.placeholder = "…";
          input.addEventListener("input", () => {
            const plain = input.dataset.plain;
            const cipher = (input.value || "").toUpperCase();
            mapping[plain] = cipher;
            updateTextarea();
          });
          box.append(top, arrow, input);
          substitutionRow.appendChild(box);
          mapping[plainLetter] = "";
        });

        textarea.addEventListener("input", async () => {
          originalText = textarea.value.toUpperCase();
          updateTextarea();
          if (originalText.trim()) {
            try {
              const formData = new FormData();
              formData.append("text", originalText);
              formData.append("tool_type", "frequency");
              const res = await fetch("/tools/run", { method: "POST", body: formData });
              const data = await res.json();
              freqOutput.innerText = data.text || "";
            } catch { freqOutput.innerText = "Error fetching frequency analysis."; }
          } else freqOutput.innerText = "";
        });

        function updateTextarea() {
          let out = "";
          for (let ch of originalText) {
            let replaced = false;
            for (const [plain, cipher] of Object.entries(mapping)) {
              if (ch === cipher) { out += plain; replaced = true; break; }
            }
            if (!replaced) out += ch;
          }
          textarea.value = out;
        }

        document.getElementById("clear-mapping").onclick = () => {
          substitutionRow.querySelectorAll(".sub-input").forEach(inp => inp.value = "");
          Object.keys(mapping).forEach(k => mapping[k] = "");
          updateTextarea();
        };
        document.getElementById("reset-text").onclick = () => {
          textarea.value = originalText;
          freqOutput.innerText = "";
        };
      }

      // --- Text Replacer ---
      else if (selected === "text_replacer") {
        toolContainer.innerHTML = `
          <p style="color:var(--muted);font-size:.95rem;margin-bottom:10px;">${toolExplanations['text_replacer']}</p>
          <label class="cipher-label">Input Text</label>
          <textarea id="replace-text" placeholder="Paste your text here…" style="min-height:120px;"></textarea>
          <label class="cipher-label">Find</label>
          <input type="text" id="replace-find" placeholder="Text to find">
          <label class="cipher-label">Replace With</label>
          <input type="text" id="replace-with" placeholder="Replacement text">
          <div style="display:flex;gap:10px;margin-top:10px;">
            <button id="replace-run" class="btn">Run</button>
            <button id="replace-clear" class="btn secondary">Clear</button>
          </div>
          <div id="replace-result" class="result-box"></div>
        `;
        const copyBtn = addCopyButton("replace-result");
        toolContainer.appendChild(copyBtn);

        document.getElementById("replace-run").onclick = async () => {
          const text = document.getElementById("replace-text").value;
          const find = document.getElementById("replace-find").value;
          const replacement = document.getElementById("replace-with").value;
          const formData = new FormData();
          formData.append("text", text);
          formData.append("tool_type", "text_replacer");
          formData.append("to_replace", find);
          formData.append("replacement", replacement);
          const res = await fetch("/tools/run", { method: "POST", body: formData });
          const data = await res.json();
          document.getElementById("replace-result").innerText = data.text || "";
        };
        document.getElementById("replace-clear").onclick = () => {
          ["replace-text","replace-find","replace-with"].forEach(id => document.getElementById(id).value = "");
          document.getElementById("replace-result").innerText = "";
        };
      }

      // --- Other Tools ---
      else if (["frequency","polybius","unique","text_spacer"].includes(selected)) {
        let extra = "";
        if (selected === "text_spacer" || selected === "unique") {
          const defaultVal = selected === "unique" ? 2 : 5;
          extra = `
            <div style="display:flex;align-items:center;gap:10px;margin-top:12px;">
              <label for="block-length" class="cipher-label" style="width:auto;">Block Length</label>
              <input type="number" id="block-length" min="1" value="${defaultVal}" style="width:100px;">
            </div>`;
        }

        toolContainer.innerHTML = `
          <p style="color:var(--muted);font-size:.95rem;margin-bottom:10px;">${toolExplanations[selected]}</p>
          <textarea id="tool-text" placeholder="Paste or type your text…" style="min-height:160px;"></textarea>
          ${extra}
          <div style="display:flex;gap:10px;margin-top:10px;">
            <button id="tools-run" class="btn">Run</button>
            <button id="tools-clear" class="btn secondary">Clear</button>
          </div>
          <div id="tool-result" class="result-box"></div>
        `;
        const copyBtn = addCopyButton("tool-result");
        toolContainer.appendChild(copyBtn);

        document.getElementById("tools-run").onclick = async () => {
          const text = document.getElementById("tool-text").value;
          const formData = new FormData();
          formData.append("text", text);
          formData.append("tool_type", selected);
          const blockEl = document.getElementById("block-length");
          if (blockEl) formData.append("block_length", blockEl.value);
          const res = await fetch("/tools/run", { method: "POST", body: formData });
          const data = await res.json();
          document.getElementById("tool-result").innerText = data.text || "";
        };
        document.getElementById("tools-clear").onclick = () => {
          document.getElementById("tool-text").value = "";
          document.getElementById("tool-result").innerText = "";
        };
      }
    }

    document.addEventListener("DOMContentLoaded", () => renderTool(toolSelect.value));
    toolSelect.addEventListener("change", () => renderTool(toolSelect.value));
  })();

  // Fun samples
  const funSamples = [
    "I told my toaster to encrypt my breakfast, but it just gave me burnt toast.",
    "This sentence knows it’s about to be encrypted and is very nervous.",
    "My secret code is hidden in plain sight, but even I forgot the key.",
    "Somewhere, a potato is learning Morse code faster than I can learn Python.",
    "Warning: decoding this message may summon unintended consequences.",
    "The cake is a cipher. You just haven’t decrypted it yet.",
    "Behind every random string lies someone trying to be mysterious.",
    "Sometimes I encrypt my thoughts just so I can feel like a secret agent.",
    "I whispered my password to a pigeon. I regret everything.",
    "My diary is written entirely in base64. Even I can’t read it anymore.",
    "The vending machine only accepts encrypted coins.",
    "Somewhere, a cat just brute-forced the Wi-Fi.",
    "My coffee tastes like ciphertext and regret.",
    "I accidentally encrypted my shopping list. Now I just buy random stuff.",
    "Trust no one. Except maybe the hash function.",
    "I lost my key… literally. It’s somewhere in the cipher.",
    "The real ciphertext was the friends we made along the way.",
    "I asked for a decryption key and got a therapy session instead.",
    "The key was under the doormat the whole time."
  ];

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("textarea").forEach(area => {
      if (!area.value.trim()) area.value = funSamples[Math.floor(Math.random()*funSamples.length)];
    });
  });
  </script>
</body>
</html>
