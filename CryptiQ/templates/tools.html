<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Primary SEO -->
  <title>Cipher Analysis Tools & Utilities | The Cipher Lab</title>
  <meta name="description"
        content="Free cipher analysis tools including frequency analysis, substitution helpers, Polybius tools, text spacers, and cryptography utilities. Built for puzzle solvers and codebreakers." />
  <meta name="robots" content="index, follow" />

  <!-- Canonical -->
  <link rel="canonical" href="{{ request.url }}" />

  <!-- Open Graph (Reddit / Discord / social previews) -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="The Cipher Lab" />
  <meta property="og:title" content="Cipher Analysis Tools | The Cipher Lab" />
  <meta property="og:description"
        content="Explore free cryptography tools: frequency analyzers, substitution helpers, Polybius utilities, and more. Designed for serious cipher solvers." />
  <meta property="og:url" content="{{ request.url }}" />

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Cipher Analysis Tools | The Cipher Lab" />
  <meta name="twitter:description"
        content="A powerful collection of cipher analysis and cryptography tools for solving puzzles and challenges." />

  <!-- Theme -->
  <meta name="theme-color" content="#00ffd5" />

  <!-- Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    html { overflow-y: scroll; scrollbar-gutter: stable both-edges; }

    .cb-shell {
      min-height: calc(100dvh - 80px);
      display: grid;
      place-items: start center;
      padding: 50px 16px 40px;
      box-sizing: border-box;
    }

    .cb-card {
      width: 100vw;
      max-width: 1000px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--elev-shadow);
      overflow: hidden;
      animation: fadeIn .5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cb-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px 22px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(0deg, rgba(0,0,0,0.04), transparent);
      flex-wrap: wrap;
    }

    .cb-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent-soft);
    }

    .cb-title {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text);
      font-weight: 700;
      letter-spacing: .2px;
    }

    /* ===== Labs integration header actions ===== */
    .cb-header-actions{
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .lab-btn{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--line-2, #343434);
      background: transparent;
      color: var(--text, #f0f0f0);
      font-weight: 800;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease, transform .06s ease;
      white-space: nowrap;
      font-size: .9rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .lab-btn:hover{
      background: var(--input-hover, rgba(255,255,255,0.06));
      border-color: var(--accent, #00ffd5);
      box-shadow: 0 0 0 2px var(--accent-soft, #00ffd57c);
    }
    .lab-btn:active{ transform: translateY(1px); }
    .lab-btn.primary{
      background: var(--accent, #00ffd5);
      border-color: var(--accent, #00ffd5);
      color: #0f0f0f;
    }
    .lab-btn.primary:hover{
      background: var(--accent-strong, #00e6c0);
      border-color: var(--accent-strong, #00e6c0);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }
    .lab-btn:disabled{
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none !important;
    }

    .tools-grid {
      display: grid;
      gap: 18px;
      padding: 20px;
    }

    @media (min-width: 900px) {
      .tools-grid { grid-template-columns: 1fr; }
    }

    .cb-panel {
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 20px;
    }

    .cb-panel h3 {
      margin: 0 0 12px;
      color: var(--accent);
      font-size: 1rem;
      letter-spacing: .2px;
    }

    .cipher-label {
      color: var(--text);
      font-weight: 600;
      margin-bottom: 6px;
      display: block;
    }

    select, textarea, input[type="number"], input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      color: var(--text);
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 15px;
      font-family: 'Fira Code','JetBrains Mono','Courier New',monospace;
      transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
    }

    select:hover, textarea:hover, input:hover { background: var(--input-hover); }
    select:focus, textarea:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .btn {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #0f0f0f;
      font-weight: 650;
      font-size: 15px;
      cursor: pointer;
      transition: background .15s ease, box-shadow .18s ease, transform .06s ease;
    }

    .btn:hover {
      background: var(--accent-strong);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }

    .btn.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line-2);
    }

    .btn.secondary:hover {
      background: var(--input-hover);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    .btn.copy-btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      font-size: .9rem;
      margin-top: 10px;
      align-self: flex-end;
      cursor: pointer;
      transition: all .2s ease;
    }
    .btn.copy-btn:hover { background: var(--accent); color: #0f0f0f; }

    .result-box {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 8px;
      padding: 14px;
      color: var(--text);
      font-family: 'Fira Code', monospace;
      font-size: .95rem;
      min-height: 48px;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top: 10px;
    }

    .sub-letter-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      width: 48px;
      padding: 8px 6px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
    }

    .sub-top { color: var(--text-dim); font-size: .85rem; font-weight: 700; text-transform: lowercase; }
    .sub-arrow { font-size: .8rem; color: var(--muted-2); }
    .sub-input {
      width: 36px;
      height: 34px;
      text-align: center;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text);
      font-family: 'Fira Code', monospace;
      font-size: 15px;
      transition: .18s ease;
    }
    .sub-input:focus {
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
      outline: none;
    }

    .helper-bar {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      border-top: 1px dashed var(--line);
      padding-top: 12px;
      margin-top: 8px;
      font-size: .9rem;
      color: var(--muted);
    }

    @media (max-width: 720px) {
      .cb-shell { padding: 80px 12px 32px; }
      .cb-panel { padding: 14px; }
      .btn { width: 100%; }
      .btn.copy-btn { width: 100%; text-align: center; }
    }

    /* ===============================
       Labs Modal
       =============================== */
    .lmodal{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 8000;
    }
    .lmodal.open{ display: flex; }

    .lmodal-backdrop{
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(6px);
    }

    .lmodal-box{
      position: relative;
      width: min(560px, 92vw);
      background: var(--panel, #1d1d1d);
      border: 1px solid var(--line, #2a2a2a);
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      padding: 12px;
      display: grid;
      gap: 10px;
      animation: lmodalPop .12s ease-out;
    }
    @keyframes lmodalPop{
      from { transform: translateY(6px) scale(.98); opacity: .6; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }

    .lmodal-top{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 4px 0;
    }
    .lmodal-title{
      color: var(--text, #f0f0f0);
      font-weight: 900;
      font-size: .98rem;
    }
    .lmodal-x{
      border: 1px solid var(--line-2, #343434);
      background: transparent;
      color: var(--text, #f0f0f0);
      font-weight: 900;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
    }
    .lmodal-x:hover{
      background: var(--input-hover, rgba(255,255,255,0.06));
      border-color: var(--accent, #00ffd5);
      box-shadow: 0 0 0 2px var(--accent-soft, #00ffd57c);
    }
    .lmodal-body{
      color: var(--muted, #a0a0a0);
      line-height: 1.45;
      padding: 0 4px;
      display: grid;
      gap: 10px;
    }
    .lmodal-actions{
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 6px 4px 2px;
      flex-wrap: wrap;
    }
    .lmodal-row{
      display: grid;
      gap: 6px;
    }
    .lmodal-help{
      font-size: .86rem;
      color: var(--muted, #a0a0a0);
    }
    .lmodal-note{
      font-size: .82rem;
      color: var(--muted, #a0a0a0);
      opacity: .9;
    }
    .ltextarea{
      min-height: 140px;
      border-radius: 10px;
      border: 1px solid var(--input-border,#343434);
      background: var(--input-bg,#0e0e0e);
      color: var(--text,#f0f0f0);
      padding: 10px 12px;
      font-family: 'Fira Code','JetBrains Mono',monospace;
      resize: vertical;
      outline: none;
    }
    .ltextarea:focus{
      border-color: var(--accent, #00ffd5);
      background: var(--input-focus, #161616);
      box-shadow: 0 0 0 2px var(--accent-soft, #00ffd57c);
    }
  </style>
</head>

<body>
  {% include 'base_nav.html' %}

  <main class="cb-shell">
    <section class="cb-card" aria-label="Cipher Tools">
      <header class="cb-header">
        <span class="cb-dot"></span>
        <h1 class="cb-title">Cipher Tools</h1>

        <div class="cb-header-actions">
          {% if user %}
            <button class="lab-btn primary" id="save-to-lab" type="button">Save to Lab</button>
            <a class="lab-btn" href="{{ url_for('workspace_list') }}">My Labs</a>
          {% else %}
            <a class="lab-btn primary" id="save-to-lab-loggedout" href="{{ url_for('login') }}?next={{ request.path }}">Login to save</a>
            <a class="lab-btn" href="{{ url_for('workspace_list') }}">My Labs</a>
          {% endif %}
        </div>
      </header>

      <div class="tools-grid">
        <div class="cb-panel">
          <h3>Select Tool</h3>
          <select id="tool-select">
            <option value="frequency" selected>Frequency Analyzer</option>
            <option value="polybius">Polybius Standardizer</option>
            <option value="substitution">Substitution Cipher Analyzer</option>
            <option value="unique">Unique Symbol Finder</option>
            <option value="text_spacer">Text Spacer</option>
            <option value="text_replacer">Text Replacer</option>
            <option value="remove_spaces">Space Remover</option>
            <option value="remove_punctuation">Punctuation Remover</option>
          </select>
        </div>

        <div id="tool-container" class="cb-panel" style="display:none;"></div>
      </div>
    </section>
              {% include "base_footer.html" %}

  </main>

  <!-- ===== Labs Modal ===== -->
  <div id="labs-modal" class="lmodal" aria-hidden="true">
    <div class="lmodal-backdrop" data-close="1"></div>

    <div class="lmodal-box" role="dialog" aria-modal="true" aria-label="Save to Lab">
      <div class="lmodal-top">
        <div class="lmodal-title">Save to Lab</div>
        <button class="lmodal-x" id="labs-x" type="button" aria-label="Close">✕</button>
      </div>

      <div class="lmodal-body">
        <div class="lmodal-help">
          Creates a new Lab (workspace) and saves the current tool output + notes into it.
        </div>

        <div class="lmodal-row">
          <label for="labs-title">Lab title</label>
          <input id="labs-title" type="text" placeholder="e.g. Tools — Frequency Analyzer" />
        </div>

        <div class="lmodal-row">
          <label for="labs-notes">Notes</label>
          <textarea id="labs-notes" class="ltextarea" placeholder="Add your notes (optional)"></textarea>
          <div class="lmodal-note">
            We’ll include: selected tool, input, and the latest output.
          </div>
        </div>
      </div>

      <div class="lmodal-actions">
        <button class="lab-btn" id="labs-cancel" type="button">Cancel</button>
        <button class="lab-btn primary" id="labs-confirm" type="button">Create Lab</button>
      </div>
    </div>
  </div>

  <script>
  (function () {
    const toolSelect = document.getElementById("tool-select");
    const toolContainer = document.getElementById("tool-container");
    const alphabet = 'abcdefghijklmnopqrstuvwxyz'.split('');

    // ===== Labs integration =====
    const saveToLabBtn = document.getElementById("save-to-lab");
    const labsModal = document.getElementById("labs-modal");
    const labsX = document.getElementById("labs-x");
    const labsCancel = document.getElementById("labs-cancel");
    const labsConfirm = document.getElementById("labs-confirm");
    const labsTitle = document.getElementById("labs-title");
    const labsNotes = document.getElementById("labs-notes");

    const DRAFT_KEY = "tcl_tools_draft_v1";

    const toolExplanations = {
      frequency: "Counts how often each letter appears. Great first step for substitution-style ciphers.",
      polybius: "Normalizes Polybius outputs to a clean letter stream you can feed into other tools.",
      substitution: "Map each plaintext letter (top) to a ciphertext letter (input).",
      unique: "Splits text into blocks of length n and counts unique blocks. Helpful for pattern hunting.",
      text_spacer: "Removes spaces, then re-blocks your text into fixed-size chunks for readability.",
      text_replacer: "Replaces every occurrence of one substring with another. Case-sensitive.",
      remove_spaces: "Removes all spaces",
      remove_punctuation: "Removes all punctuation"
    };

    const showCard = () => { toolContainer.style.display = 'flex'; toolContainer.style.flexDirection = 'column'; };

    function safeGetVal(id) {
      const el = document.getElementById(id);
      return el ? (el.value ?? "") : "";
    }
    function safeGetText(id) {
      const el = document.getElementById(id);
      return el ? (el.innerText ?? "") : "";
    }

    function buildDraft() {
      return {
        ts: Date.now(),
        tool: toolSelect.value,
        // common ids (present depending on tool)
        tool_text: safeGetVal("tool-text"),
        tool_result: safeGetText("tool-result"),
        block_length: safeGetVal("block-length"),

        // substitution ids
        sub_ciphertext: safeGetVal("ciphertext"),
        sub_output: safeGetText("frequency-output"),
        sub_mapping: Array.from(document.querySelectorAll(".sub-input")).map(inp => ({
          plain: inp.dataset.plain,
          v: inp.value || ""
        })),

        // replacer ids
        rep_text: safeGetVal("replace-text"),
        rep_find: safeGetVal("replace-find"),
        rep_with: safeGetVal("replace-with"),
        rep_result: safeGetText("replace-result")
      };
    }

    function saveDraft() {
      try { localStorage.setItem(DRAFT_KEY, JSON.stringify(buildDraft())); } catch {}
    }
    function loadDraft() {
      try {
        const raw = localStorage.getItem(DRAFT_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }
    function clearDraft() {
      try { localStorage.removeItem(DRAFT_KEY); } catch {}
    }

    function addCopyButton(targetId) {
      const btn = document.createElement("button");
      btn.className = "btn copy-btn";
      btn.textContent = "Copy";
      btn.onclick = () => {
        const text = document.getElementById(targetId).innerText;
        navigator.clipboard.writeText(text);
        btn.textContent = "Copied!";
        btn.style.background = "var(--accent)";
        btn.style.color = "#0f0f0f";
        setTimeout(() => {
          btn.textContent = "Copy";
          btn.style.background = "transparent";
          btn.style.color = "var(--accent)";
        }, 1000);
      };
      return btn;
    }

    function renderTool(selected) {
      toolContainer.innerHTML = "";
      if (!selected) { toolContainer.style.display = 'none'; return; }
      showCard();

      // --- Substitution ---
      if (selected === "substitution") {
        toolContainer.innerHTML = `
          <p style="color:var(--muted);font-size:.95rem;margin:0 0 10px;">${toolExplanations['substitution']}</p>
          <textarea id="ciphertext" placeholder="Paste ciphertext here…" style="min-height:160px;"></textarea>
          <div id="substitution-row" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(46px,1fr));gap:10px;margin-top:10px;"></div>
          <div class="helper-bar">
            <div>Tip: Ciphertext input goes <strong>below</strong> each lowercase letter marker.</div>
            <div style="display:flex;gap:8px;">
              <button class="btn secondary" id="clear-mapping" type="button">Clear Mapping</button>
              <button class="btn secondary" id="reset-text" type="button">Reset Text</button>
            </div>
          </div>
          <div id="frequency-output" class="result-box"></div>
        `;
        const copyBtn = addCopyButton("frequency-output");
        toolContainer.appendChild(copyBtn);

        const substitutionRow = document.getElementById("substitution-row");
        const mapping = {};
        let originalText = "";
        const textarea = document.getElementById("ciphertext");
        const freqOutput = document.getElementById("frequency-output");

        alphabet.forEach(plainLetter => {
          const box = document.createElement("div");
          box.className = "sub-letter-box";
          const top = document.createElement("span");
          top.className = "sub-top";
          top.textContent = plainLetter;
          const arrow = document.createElement("span");
          arrow.className = "sub-arrow";
          arrow.textContent = "↓";
          const input = document.createElement("input");
          input.className = "sub-input";
          input.maxLength = 1;
          input.dataset.plain = plainLetter;
          input.placeholder = "…";
          input.addEventListener("input", () => {
            const plain = input.dataset.plain;
            const cipher = (input.value || "").toUpperCase();
            mapping[plain] = cipher;
            updateTextarea();
            saveDraft();
          });
          box.append(top, arrow, input);
          substitutionRow.appendChild(box);
          mapping[plainLetter] = "";
        });

        textarea.addEventListener("input", async () => {
          originalText = textarea.value.toUpperCase();
          updateTextarea();
          saveDraft();

          if (originalText.trim()) {
            try {
              const formData = new FormData();
              formData.append("text", originalText);
              formData.append("tool_type", "frequency");
              const res = await fetch("/tools/run", { method: "POST", body: formData });
              const data = await res.json();
              freqOutput.innerText = data.text || "";
              saveDraft();
            } catch {
              freqOutput.innerText = "Error fetching frequency analysis.";
              saveDraft();
            }
          } else {
            freqOutput.innerText = "";
            saveDraft();
          }
        });

        function updateTextarea() {
          let out = "";
          for (let ch of originalText) {
            let replaced = false;
            for (const [plain, cipher] of Object.entries(mapping)) {
              if (ch === cipher) { out += plain; replaced = true; break; }
            }
            if (!replaced) out += ch;
          }
          textarea.value = out;
        }

        document.getElementById("clear-mapping").onclick = () => {
          substitutionRow.querySelectorAll(".sub-input").forEach(inp => inp.value = "");
          Object.keys(mapping).forEach(k => mapping[k] = "");
          updateTextarea();
          saveDraft();
        };
        document.getElementById("reset-text").onclick = () => {
          textarea.value = originalText;
          freqOutput.innerText = "";
          saveDraft();
        };
      }

      // --- Text Replacer ---
      else if (selected === "text_replacer") {
        toolContainer.innerHTML = `
          <p style="color:var(--muted);font-size:.95rem;margin-bottom:10px;">${toolExplanations['text_replacer']}</p>
          <label class="cipher-label">Input Text</label>
          <textarea id="replace-text" placeholder="Paste your text here…" style="min-height:120px;"></textarea>
          <label class="cipher-label">Find</label>
          <input type="text" id="replace-find" placeholder="Text to find">
          <label class="cipher-label">Replace With</label>
          <input type="text" id="replace-with" placeholder="Replacement text">
          <div style="display:flex;gap:10px;margin-top:10px;">
            <button id="replace-run" class="btn" type="button">Run</button>
            <button id="replace-clear" class="btn secondary" type="button">Clear</button>
          </div>
          <div id="replace-result" class="result-box"></div>
        `;
        const copyBtn = addCopyButton("replace-result");
        toolContainer.appendChild(copyBtn);

        const repText = document.getElementById("replace-text");
        const repFind = document.getElementById("replace-find");
        const repWith = document.getElementById("replace-with");
        const repRes  = document.getElementById("replace-result");

        [repText, repFind, repWith].forEach(el => el.addEventListener("input", saveDraft, { passive: true }));

        document.getElementById("replace-run").onclick = async () => {
          const text = repText.value;
          const find = repFind.value;
          const replacement = repWith.value;
          const formData = new FormData();
          formData.append("text", text);
          formData.append("tool_type", "text_replacer");
          formData.append("to_replace", find);
          formData.append("replacement", replacement);
          const res = await fetch("/tools/run", { method: "POST", body: formData });
          const data = await res.json();
          repRes.innerText = data.text || "";
          saveDraft();
        };
        document.getElementById("replace-clear").onclick = () => {
          ["replace-text","replace-find","replace-with"].forEach(id => document.getElementById(id).value = "");
          repRes.innerText = "";
          saveDraft();
        };
      }

      // --- Other Tools ---
      else if (["frequency","polybius","unique","text_spacer","remove_spaces","remove_punctuation"].includes(selected)) {
        let extra = "";
        if (selected === "text_spacer" || selected === "unique") {
          const defaultVal = selected === "unique" ? 2 : 5;
          extra = `
            <div style="display:flex;align-items:center;gap:10px;margin-top:12px;">
              <label for="block-length" class="cipher-label" style="width:auto;">Block Length</label>
              <input type="number" id="block-length" min="1" value="${defaultVal}" style="width:100px;">
            </div>`;
        }

        toolContainer.innerHTML = `
          <p style="color:var(--muted);font-size:.95rem;margin-bottom:10px;">${toolExplanations[selected]}</p>
          <textarea id="tool-text" placeholder="Paste or type your text…" style="min-height:160px;"></textarea>
          ${extra}
          <div style="display:flex;gap:10px;margin-top:10px;">
            <button id="tools-run" class="btn" type="button">Run</button>
            <button id="tools-clear" class="btn secondary" type="button">Clear</button>
          </div>
          <div id="tool-result" class="result-box"></div>
        `;
        const copyBtn = addCopyButton("tool-result");
        toolContainer.appendChild(copyBtn);

        const tText = document.getElementById("tool-text");
        const tRes  = document.getElementById("tool-result");
        const bLen  = document.getElementById("block-length");

        tText.addEventListener("input", saveDraft, { passive: true });
        bLen?.addEventListener("input", saveDraft, { passive: true });

        document.getElementById("tools-run").onclick = async () => {
          const text = tText.value;
          const formData = new FormData();
          formData.append("text", text);
          formData.append("tool_type", selected);
          if (bLen) formData.append("block_length", bLen.value);
          const res = await fetch("/tools/run", { method: "POST", body: formData });
          const data = await res.json();
          tRes.innerText = data.text || "";
          saveDraft();
        };
        document.getElementById("tools-clear").onclick = () => {
          tText.value = "";
          tRes.innerText = "";
          saveDraft();
        };
      }
    }

    function applyDraft(d) {
      if (!d) return;

      const tool = d.tool || "frequency";
      toolSelect.value = tool;
      renderTool(tool);

      // wait a tick because renderTool builds DOM
      setTimeout(() => {
        if (tool === "text_replacer") {
          const a = document.getElementById("replace-text"); if (a) a.value = d.rep_text || "";
          const b = document.getElementById("replace-find"); if (b) b.value = d.rep_find || "";
          const c = document.getElementById("replace-with"); if (c) c.value = d.rep_with || "";
          const r = document.getElementById("replace-result"); if (r) r.innerText = d.rep_result || "";
        } else if (tool === "substitution") {
          const t = document.getElementById("ciphertext"); if (t) t.value = d.sub_ciphertext || "";
          const out = document.getElementById("frequency-output"); if (out) out.innerText = d.sub_output || "";

          const mapArr = Array.isArray(d.sub_mapping) ? d.sub_mapping : [];
          const byPlain = {};
          mapArr.forEach(x => { if (x && x.plain) byPlain[x.plain] = x.v || ""; });
          document.querySelectorAll(".sub-input").forEach(inp => {
            const p = inp.dataset.plain;
            if (p in byPlain) inp.value = byPlain[p];
          });
        } else {
          const t = document.getElementById("tool-text"); if (t) t.value = d.tool_text || "";
          const r = document.getElementById("tool-result"); if (r) r.innerText = d.tool_result || "";
          const b = document.getElementById("block-length"); if (b && d.block_length) b.value = d.block_length;
        }
      }, 0);
    }

    // ===== Labs modal =====
    function openLabsModal() {
      if (!labsModal) return;
      labsModal.classList.add("open");
      labsModal.setAttribute("aria-hidden", "false");

      const tool = toolSelect.value;
      const niceTool = (toolSelect.options[toolSelect.selectedIndex]?.textContent || tool).trim();

      const inputText =
        safeGetVal("tool-text") ||
        safeGetVal("ciphertext") ||
        safeGetVal("replace-text") ||
        "";

      const outputText =
        safeGetText("tool-result") ||
        safeGetText("frequency-output") ||
        safeGetText("replace-result") ||
        "";

      const maybeBlock = safeGetVal("block-length");

      labsTitle.value = `Tools — ${niceTool}`;

      labsNotes.value =
`[Tools]
Tool: ${tool}

${maybeBlock ? `Block length: ${maybeBlock}\n` : ""}Input:
${inputText || "(empty)"}

Output:
${outputText || "(empty)"}
`;

      setTimeout(() => labsTitle.focus(), 0);
    }

    function closeLabsModal() {
      if (!labsModal) return;
      labsModal.classList.remove("open");
      labsModal.setAttribute("aria-hidden", "true");
    }

    labsX?.addEventListener("click", closeLabsModal);
    labsCancel?.addEventListener("click", closeLabsModal);
    labsModal?.addEventListener("click", (e) => {
      const closeEl = e.target?.closest?.("[data-close='1']");
      if (closeEl) closeLabsModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && labsModal?.classList.contains("open")) closeLabsModal();
    });

    saveToLabBtn?.addEventListener("click", () => {
      saveDraft();
      openLabsModal();
    });

    async function createWorkspacePOST(title) {
      const fd = new FormData();
      fd.append("title", title || "Untitled Lab");

      const res = await fetch(`{{ url_for('workspace_new') }}`, {
        method: "POST",
        body: fd,
        redirect: "follow"
      });

      if (res.url && res.url.includes("/login")) {
        saveDraft();
        window.location.href = `{{ url_for('login') }}?next={{ request.path }}`;
        return null;
      }

      const finalUrl = res.url || "";
      const m = finalUrl.match(/\/workspaces\/(\d+)(?:\/)?$/);
      if (!m) return null;
      return Number(m[1]);
    }

    async function saveWorkspace(wsId, payload) {
      const fd = new FormData();
      fd.append("title", payload.title || "Untitled Lab");
      fd.append("notes", payload.notes || "");
      fd.append("cipher_text", payload.cipher_text || "");

      const res = await fetch(`/workspaces/${wsId}/save`, { method: "POST", body: fd });

      if (res.status === 401) {
        saveDraft();
        window.location.href = `{{ url_for('login') }}?next={{ request.path }}`;
        return false;
      }

      const data = await res.json().catch(() => null);
      return !!(data && data.ok);
    }

    labsConfirm?.addEventListener("click", async () => {
      const title = (labsTitle.value || "").trim() || "Untitled Lab";

      // Store "output" in cipher_text; store full details in notes.
      const outputText =
        safeGetText("tool-result") ||
        safeGetText("frequency-output") ||
        safeGetText("replace-result") ||
        "";

      const notes = (labsNotes.value || "").trim();

      labsConfirm.disabled = true;
      const oldText = labsConfirm.textContent;
      labsConfirm.textContent = "Creating…";

      try {
        const wsId = await createWorkspacePOST(title);
        if (!wsId) throw new Error("create failed");

        labsConfirm.textContent = "Saving…";
        const ok = await saveWorkspace(wsId, { title, notes, cipher_text: outputText });
        if (!ok) throw new Error("save failed");

        clearDraft();
        window.location.href = `/workspaces/${wsId}`;
      } catch (e) {
        labsConfirm.disabled = false;
        labsConfirm.textContent = oldText;
        alert("Could not create lab. Are you logged in?");
      }
    });

    // ===== tool switching + draft hooks =====
    toolSelect.addEventListener("change", () => {
      renderTool(toolSelect.value);
      saveDraft();
    });

    document.addEventListener("DOMContentLoaded", () => {
      // restore if coming back from login
      const d = loadDraft();
      if (d) applyDraft(d);
      else renderTool(toolSelect.value);
    });

  })();

  // Fun samples (only fill empty ones)
  const funSamples = [
    "I told my toaster to encrypt my breakfast, but it just gave me burnt toast.",
    "This sentence knows it’s about to be encrypted and is very nervous.",
    "My secret code is hidden in plain sight, but even I forgot the key.",
    "Somewhere, a potato is learning Morse code faster than I can learn Python.",
    "Warning: decoding this message may summon unintended consequences.",
    "The cake is a cipher. You just haven’t decrypted it yet.",
    "Behind every random string lies someone trying to be mysterious.",
    "Sometimes I encrypt my thoughts just so I can feel like a secret agent.",
    "I whispered my password to a pigeon. I regret everything.",
    "My diary is written entirely in base64. Even I can’t read it anymore.",
    "The vending machine only accepts encrypted coins.",
    "Somewhere, a cat just brute-forced the Wi-Fi.",
    "My coffee tastes like ciphertext and regret.",
    "I accidentally encrypted my shopping list. Now I just buy random stuff.",
    "Trust no one. Except maybe the hash function.",
    "I lost my key… literally. It’s somewhere in the cipher.",
    "The real ciphertext was the friends we made along the way.",
    "I asked for a decryption key and got a therapy session instead.",
    "The key was under the doormat the whole time."
  ];

  // IMPORTANT: toolContainer is created dynamically, so this just seeds any initial textareas
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("textarea").forEach(area => {
      if (!area.value.trim()) area.value = funSamples[Math.floor(Math.random()*funSamples.length)];
    });
  });
  </script>
</body>
</html>
