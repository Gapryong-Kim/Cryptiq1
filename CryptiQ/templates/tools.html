<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CryptiQ â€” Tools</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .tools-container {
      width: 100%;
      max-width: 720px;
      margin: 120px auto 60px;
      background: var(--panel);
      padding: 40px;
      border-radius: var(--radius-lg);
      box-shadow: var(--elev-shadow);
      border: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .tools-container h2 {
      color: var(--accent);
      text-align: center;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .tool-description {
      color: var(--muted);
      font-size: 0.95rem;
      line-height: 1.5;
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 12px 16px;
    }

    #tool-select {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: var(--radius-sm);
      color: var(--text);
      padding: 12px;
      font-size: 1rem;
      cursor: pointer;
    }
    #tool-select:hover { background: var(--input-hover); }
    #tool-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      padding: 14px;
      font-family: 'Fira Code', monospace;
      font-size: 1rem;
      min-height: 160px;
      resize: vertical;
    }
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    #tools-run {
      background: var(--accent);
      border: 1px solid var(--accent);
      color: #0f0f0f;
      border-radius: var(--radius-sm);
      padding: 12px 18px;
      font-weight: 700;
      cursor: pointer;
      transition: 0.15s ease;
      align-self: flex-start;
    }
    #tools-run:hover { background: var(--accent-strong); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35); }

    #tool-result, #frequency-output {
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 14px;
      white-space: pre-wrap;
      color: var(--text);
      font-family: 'Fira Code', monospace;
      font-size: 0.95rem;
    }

    /* Substitution grid layout */
    #substitution-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 8px;
      margin-top: 16px;
      justify-items: center;
      align-items: end;
    }

    .sub-letter-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      gap: 4px;
      text-align: center;
      width: 42px;
    }

    .sub-letter-box span {
      color: var(--text-dim);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .sub-letter-box input {
      width: 36px;
      height: 34px;
      text-align: center;
      border: 1px solid var(--input-border);
      border-radius: var(--radius-sm);
      background: var(--input-bg);
      color: var(--text);
      font-family: 'Fira Code', monospace;
      font-size: 15px;
      transition: 0.2s ease;
      text-transform: lowercase;
    }

    .sub-letter-box input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }

    @media (max-width: 768px) {
      .tools-container { padding: 28px 20px; margin: 100px 16px; }
      #substitution-row { gap: 5px; }
      .sub-letter-box input { width: 32px; height: 32px; font-size: 14px; }
    }
  </style>
</head>

<body>
  {% include 'base_nav.html' %}

  <div class="tools-container">
    <h2>Tools</h2>

    <label for="tool-select" class="cipher-label">Select Tool:</label>
    <select id="tool-select">
      <option value="">-- Select Tool --</option>
      <option value="frequency">Frequency Analyzer</option>
      <option value="polybius">Polybius Standardizer</option>
      <option value="substitution">Substitution Cipher Analyzer</option>
      <option value="unique">Unique Symbol Finder</option>
      <option value="text_spacer">Text Spacer</option>
    </select>

    <div id="tool-container"></div>
  </div>

  <script>
    const toolSelect = document.getElementById("tool-select");
    const toolContainer = document.getElementById("tool-container");
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

    const toolExplanations = {
      frequency: "The Frequency Analyzer examines how often each letter appears in your text, revealing patterns useful for breaking ciphers.",
      polybius: "The Polybius Standardizer formats text encoded via the Polybius square cipher, converting it into a substitution-ready format.",
      substitution: "The Substitution Analyzer lets you map ciphertext to plaintext interactively. Cipher letters are shown above, and your lowercase plaintext mappings appear below.",
      unique: "The Unique Symbol Finder divides text into blocks of length n and counts how many unique combinations appear.",
      text_spacer: "The Text Spacer reformats text into equal-length groups for readability or pattern analysis."
    };

    toolSelect.addEventListener("change", async () => {
      toolContainer.innerHTML = "";
      const selected = toolSelect.value;

      if (selected === "substitution") {
        toolContainer.innerHTML = `
          <p class="tool-description">${toolExplanations['substitution']}</p>
          <textarea id="ciphertext" placeholder="Enter ciphertext here..."></textarea>
          <div id="substitution-row"></div>
          <pre id="frequency-output" style="margin-top:15px;"></pre>
        `;

        const substitutionRow = document.getElementById("substitution-row");
        const mapping = {};
        let ciphertext = "";
        let originalText = "";

        alphabet.forEach(cipherLetter => {
          const box = document.createElement("div");
          box.className = "sub-letter-box";
          const top = document.createElement("span");
          top.textContent = cipherLetter;
          const input = document.createElement("input");
          input.dataset.cipher = cipherLetter;
          box.appendChild(top);
          box.appendChild(input);
          substitutionRow.appendChild(box);
          mapping[cipherLetter] = "";

          input.addEventListener("input", () => {
            const cipher = input.dataset.cipher;
            const plain = input.value.toLowerCase();
            mapping[cipher] = plain;
            updateTextarea();
          });
        });

        const textarea = document.getElementById("ciphertext");
        const freqOutput = document.getElementById("frequency-output");

        textarea.addEventListener("input", async () => {
          ciphertext = textarea.value.toUpperCase();
          originalText = ciphertext;
          updateTextarea();

          if (ciphertext.trim()) {
            try {
              const formData = new FormData();
              formData.append("text", ciphertext);
              formData.append("tool_type", "frequency");
              const response = await fetch("/tools/run", { method: "POST", body: formData });
              const data = await response.json();
              freqOutput.innerText = data.text;
            } catch {
              freqOutput.innerText = "Error fetching frequency analysis.";
            }
          } else freqOutput.innerText = "";
        });

        function updateTextarea() {
          let result = "";
          for (let char of originalText) {
            result += mapping[char] || char;
          }
          textarea.value = result;
        }
      }

      // --- Frequency / Polybius / Unique / Text Spacer ---
      else if (["frequency", "polybius", "unique", "text_spacer"].includes(selected)) {
        let extra = "";
        if (selected === "text_spacer") {
          extra = `
            <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
              <label for="block-length">Block Length:</label>
              <input type="number" id="block-length" min="1" value="5" style="width:80px;">
            </div>
          `;
        }

        toolContainer.innerHTML = `
          <p class="tool-description">${toolExplanations[selected]}</p>
          <textarea id="tool-text" placeholder="Enter text here..."></textarea>
          ${extra}
          <button id="tools-run">Run</button>
          <pre id="tool-result"></pre>
        `;

        document.getElementById("tools-run").addEventListener("click", async () => {
          const text = document.getElementById("tool-text").value;
          const formData = new FormData();
          formData.append("text", text);
          formData.append("tool_type", selected);
          if (selected === "text_spacer")
            formData.append("block_length", document.getElementById("block-length").value);
          const response = await fetch("/tools/run", { method: "POST", body: formData });
          const data = await response.json();
          document.getElementById("tool-result").innerText = data.text;
        });
      }
    });
  </script>
</body>
</html>
