<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>My Labs â€” The Cipher Lab</title>

  <!-- ðŸš« Do NOT index private pages -->
  <meta name="robots" content="noindex, nofollow, noarchive">

  <!-- Prevent duplicate URL issues -->
  <link rel="canonical" href="{{ url_for('workspace_list', _external=True) }}">

  <!-- App styling -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Accessibility / performance -->
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0a0a0a">

<style>
  html { overflow-y: scroll; scrollbar-gutter: stable both-edges; }

  .wl-shell{
    min-height: calc(100dvh - 80px);
    display: grid;
    place-items: start center;
    padding: 46px 14px 30px;
    box-sizing: border-box;
    position: relative;
  }

  .wl-card{
    width: 100%;
    max-width: 1100px;
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 16px;
    box-shadow: var(--elev-shadow);
    overflow: hidden;
    position: relative;
  }

  .wl-top{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 16px 18px;
    border-bottom: 1px solid var(--line);
    background: linear-gradient(0deg, rgba(0,0,0,0.04), transparent);
    flex-wrap: wrap;
    position: relative;
  }

  .wl-titlewrap{
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }

  .wl-dot{
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 10px var(--accent-soft);
    flex: 0 0 auto;
  }

  .wl-title{
    margin: 0;
    color: var(--text);
    font-weight: 900;
    letter-spacing: .2px;
    font-size: 1.05rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .wl-sub{
    color: var(--muted);
    font-size: .9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .wl-actions{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
  }

  .search{
    position: relative;
    width: min(520px, 100%);
    flex: 1 1 320px;
  }

  .search input{
    width: 100%;
    box-sizing: border-box;
    padding: 12px 44px;
    border-radius: 999px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text);
    font-size: 0.98rem;
    transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
  }

  .search input:focus{
    outline: none;
    border-color: var(--accent);
    background: var(--input-focus);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .search svg{
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.65;
    color: var(--muted);
    pointer-events: none;
  }

  .btn{
    padding: 11px 14px;
    border-radius: 999px;
    border: 1px solid var(--accent);
    background: var(--accent);
    color: #0f0f0f;
    font-weight: 900;
    font-size: .9rem;
    cursor: pointer;
    transition: background .15s ease, border-color .15s ease, box-shadow .18s ease, transform .06s ease;
    white-space: nowrap;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .btn:hover{
    background: var(--accent-strong);
    border-color: var(--accent-strong);
    box-shadow: 0 10px 22px rgba(0,0,0,.35);
  }

  .btn:active{ transform: translateY(1px); }

  .btn.secondary{
    background: transparent;
    border: 1px solid var(--line-2);
    color: var(--text);
    font-weight: 900;
  }

  .btn.secondary:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .wl-body{ padding: 16px; }

  .grid{
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  @media (max-width: 980px){
    .grid{ grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 640px){
    .wl-shell{ padding: 80px 12px 24px; }
    .grid{ grid-template-columns: 1fr; }
  }

  .ws-card{
    display: grid;
    gap: 10px;
    padding: 14px;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: var(--panel-2);
    box-shadow: 0 10px 26px rgba(0,0,0,.18);
    transition: transform .14s ease, box-shadow .18s ease, border-color .18s ease;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    min-height: 140px;
    user-select: none;
  }

  .ws-card:hover{
    transform: translateY(-2px);
    box-shadow: 0 14px 32px rgba(0,0,0,.26);
    border-color: rgba(0,255,213,0.22);
  }

  /* ===== Locked Labs (free plan overflow) ===== */
  .ws-card.locked{
    opacity: .55;
    filter: grayscale(.25);
    cursor: not-allowed;
  }

  .ws-card.locked:hover{
    transform: none;
    box-shadow: 0 10px 26px rgba(0,0,0,.18);
    border-color: var(--line);
  }

  .ws-lock{
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.18);
    color: var(--muted);
  }

  .ws-head{
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 10px;
  }

  .ws-name{
    font-weight: 900;
    color: var(--text);
    font-size: 1.02rem;
    line-height: 1.2;
    margin: 0;
    word-break: break-word;
  }

  .ws-chip{
    padding: 6px 10px;
    border-radius: 999px;
    font-size: .78rem;
    font-weight: 900;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--muted);
    white-space: nowrap;
    flex: 0 0 auto;
  }

  .ws-snippet{
    color: var(--muted);
    font-size: .92rem;
    line-height: 1.45;
    margin: 0;
    word-break: break-word;
  }

  .ws-meta{
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    border-top: 1px dashed var(--line);
    padding-top: 10px;
    color: var(--muted);
    font-size: .84rem;
    margin-top: auto;
  }

  .ws-meta b{ color: var(--text-dim); }

  .empty{
    padding: 26px 18px;
    text-align: center;
    color: var(--muted);
    border: 1px dashed var(--line);
    border-radius: 14px;
    background: rgba(255,255,255,0.02);
  }

  /* === Info Modal === */
  .info-modal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    z-index: 7000;
    padding: 16px;
  }
  .info-modal.open{ display: flex; animation: fadeIn .22s ease; }

  @keyframes fadeIn{
    from{ opacity: 0; }
    to{ opacity: 1; }
  }

  .info-box{
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 14px;
    width: min(560px, 92vw);
    padding: 26px 30px;
    color: var(--text);
    box-shadow: 0 18px 60px rgba(0,0,0,0.55);
    animation: fadeInUp .22s ease;
    line-height: 1.6;
    text-align: left;
    position: relative;

    max-height: 80vh;
    overflow-y: auto;
    scrollbar-gutter: stable both-edges;
    outline: none;
  }

  @keyframes fadeInUp{
    from{ opacity: 0; transform: translateY(10px); }
    to{ opacity: 1; transform: translateY(0); }
  }

  .info-box h2{
    color: var(--accent);
    font-size: 1.35rem;
    margin: 0 0 10px;
    font-weight: 950;
    letter-spacing: 0.2px;
    text-shadow: 0 0 10px var(--accent-soft);
  }

  .info-box ul li strong{
    color: var(--accent);
    font-weight: 950;
  }

  .info-box ul li{
    margin-bottom: 10px;
    color: var(--text-dim);
  }

  .info-box p{
    font-size: 0.98rem;
    margin: 0 0 10px;
    color: var(--text-dim);
  }

  .info-box ul{
    margin: 12px 0 0 18px;
    padding: 0;
    list-style-type: disc;
  }

  .info-box .tip{
    margin-top: 14px;
    color: var(--text-dim);
    font-size: 0.94rem;
  }

  .info-close{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: transparent;
    border: none;
    padding: 0;
    color: var(--muted);
    font-size: 22px;
    line-height: 1;
    cursor: pointer;
    transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    position: absolute;
    top: 12px;
    right: 12px;
  }

  .info-close:hover{
    background: color-mix(in oklab, var(--accent) 18%, transparent);
    color: var(--accent);
    box-shadow: 0 0 10px var(--accent-soft);
  }

  .info-close:focus-visible{
    outline: none;
    background: color-mix(in oklab, var(--accent) 25%, transparent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  /* === Info Button === */
  .info-btn{
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(0, 255, 213, 0.08);
    border: none;
    color: var(--accent);
    font-weight: 900;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding: 0;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.25);
    backdrop-filter: blur(6px);
    transition: all 0.25s ease;
  }

  .info-btn:hover{
    background: var(--accent);
    color: #0f0f0f;
    transform: translateY(-1px) scale(1.05);
    box-shadow: 0 0 12px var(--accent-soft);
  }

  /* faint pulse when user hasn't opened info yet */
  .info-btn.pulse{
    animation: infoPulse 1.8s ease-in-out infinite;
  }

  @keyframes infoPulse{
    0%, 100%{
      transform: translateY(0) scale(1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      background: rgba(0, 255, 213, 0.08);
    }
    50%{
      transform: translateY(-1px) scale(1.04);
      box-shadow: 0 0 14px var(--accent-soft);
      background: rgba(0, 255, 213, 0.14);
    }
  }

  @media (prefers-reduced-motion: reduce){
    .info-btn.pulse{ animation: none; }
  }

  /* === Delete button (centred) === */
  .ws-delete{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    padding: 0;
    background: transparent;
    color: var(--muted);
    display: grid;
    place-items: center;
    line-height: 0;
    cursor: pointer;
    transition: background .2s ease, color .2s ease, box-shadow .2s ease;
  }

  .ws-delete svg{
    display: block;
    width: 16px;
    height: 16px;
    transform: translateY(-1px);
  }

  .ws-delete:hover{
    background: rgba(255, 0, 80, 0.12);
    color: #ff4d6d;
    box-shadow: 0 0 10px rgba(255, 77, 109, 0.35);
  }

  /* === Confirm delete modal === */
  .confirm-modal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.6);
    backdrop-filter: blur(4px);
    z-index: 8000;
    padding: 16px;
  }
  .confirm-modal.open{ display: flex; }

  .confirm-box{
    width: min(520px, 92vw);
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 14px;
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    padding: 18px 18px 16px;
    color: var(--text);
    outline: none;
  }

  .confirm-top{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
  }

  .confirm-title{
    margin: 0;
    font-size: 1.05rem;
    font-weight: 950;
  }

  .confirm-x{
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: var(--muted);
    display: grid;
    place-items: center;
    line-height: 0;
    font-size: 22px;
    cursor: pointer;
    transition: background .2s ease, color .2s ease, box-shadow .2s ease;
  }

  .confirm-x:hover{
    background: color-mix(in oklab, var(--accent) 18%, transparent);
    color: var(--accent);
    box-shadow: 0 0 10px var(--accent-soft);
  }

  .confirm-text{
    margin: 0 0 14px;
    color: var(--text-dim);
    line-height: 1.55;
  }

  .confirm-actions{
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    flex-wrap: wrap;
  }

  .confirm-btn{
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    cursor: pointer;
    transition: background .15s ease, border-color .15s ease, box-shadow .18s ease, transform .06s ease;
  }

  .confirm-btn:active{ transform: translateY(1px); }

  .confirm-btn.secondary:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .confirm-btn.danger{
    border-color: rgba(255, 77, 109, .35);
    background: rgba(255, 0, 80, 0.10);
    color: #ff4d6d;
  }

  .confirm-btn.danger:hover{
    background: rgba(255, 0, 80, 0.16);
    box-shadow: 0 0 0 2px rgba(255, 77, 109, 0.18);
  }

  .personal {
    color: var(--accent);
    text-decoration: none;
  }

  /* =========================================================
     Labs Pro upsell modal (same treatment)
     ========================================================= */
  .promodal{
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9000;
    padding: 16px;
  }
  .promodal.open{ display: flex; }

  .promodal-backdrop{
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.68);
    backdrop-filter: blur(7px);
  }

  .promodal-box{
    position: relative;
    width: min(560px, 92vw);
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 18px;
    box-shadow: 0 22px 70px rgba(0,0,0,.6);
    overflow: hidden;
    animation: fadeInUp .18s ease;
  }

  .promodal-hero{
    padding: 16px 16px 12px;
    border-bottom: 1px solid var(--line);
    background:
      radial-gradient(70% 60% at 15% 20%, rgba(0,255,213,.16) 0%, rgba(0,255,213,0) 60%),
      radial-gradient(55% 50% at 85% 10%, rgba(0,255,213,.10) 0%, rgba(0,255,213,0) 55%);
  }

  .promodal-top{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .promodal-title{
    font-weight: 1000;
    color: var(--text);
    font-size: 1.05rem;
    letter-spacing: .1px;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }

  .pro-chip{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    background: var(--accent);
    color: #0f0f0f;
    font-weight: 1000;
    font-size: .78rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    border: 1px solid color-mix(in oklab, var(--accent) 70%, black);
    box-shadow: 0 0 0 3px var(--accent-soft);
    position: relative;
    overflow: hidden;
    flex: 0 0 auto;
  }

  .pro-chip::after{
    content:"";
    position:absolute;
    inset:-40% -70%;
    background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,.28) 45%, transparent 70%);
    transform: translateX(-80%);
    animation: proShine 2.6s ease-in-out infinite;
  }
  @keyframes proShine{
    0%{ transform: translateX(-80%); }
    55%{ transform: translateX(80%); }
    100%{ transform: translateX(80%); }
  }

  .promodal-x{
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 900;
    border-radius: 12px;
    padding: 8px 10px;
    cursor: pointer;
    flex: 0 0 auto;
  }
  .promodal-x:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .promodal-body{
    padding: 14px 16px 10px;
    color: var(--text-dim);
    line-height: 1.55;
  }

  .promodal-list{
    margin: 10px 0 0;
    padding: 0;
    list-style: none;
    display: grid;
    gap: 8px;
  }
  .promodal-list li{
    display: flex;
    gap: 10px;
    align-items: flex-start;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    font-weight: 800;
  }
  .promodal-list .tick{
    color: var(--accent);
    font-weight: 1000;
  }

  .promodal-actions{
    padding: 12px 16px 16px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-wrap: wrap;
  }

  .promodal-btn{
    padding: 11px 14px;
    border-radius: 12px;
    border: 1px solid var(--line-2);
    background: transparent;
    color: var(--text);
    font-weight: 1000;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  .promodal-btn:hover{
    background: var(--input-hover);
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-soft);
  }

  .promodal-btn.primary{
    background: var(--accent);
    color: #0f0f0f;
    border-color: var(--accent);
    box-shadow: 0 10px 26px rgba(0,0,0,0.35), 0 0 0 3px var(--accent-soft);
  }
  .promodal-btn.primary:hover{ filter: brightness(1.05); transform: translateY(-1px); }

  @media (prefers-reduced-motion: reduce){
    .pro-chip::after{ animation: none; }
  }
  .wl-title{
  position: relative;
  padding-bottom: 3px;  
}

.wl-title::after{
  content:"";
  position:absolute;
  left: 0;
  bottom: -6px;
  width: 42px;
  height: 3px;
  border-radius: 999px;
  background: var(--accent);
  box-shadow: 0 0 14px var(--accent-soft);
  opacity: .85;
}
.wl-title{
  margin: 0;
  font-size: 1.22rem;
  font-weight: 950;
  letter-spacing: .15px;
  color: var(--text);

  /* subtle depth, not glow */
  text-shadow: 0 1px 0 rgba(255,255,255,0.02);
}

</style>
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" sizes="any">
<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
<link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='android-chrome-192x192.png') }}">
<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">

</head>

<body>
  {% include 'base_nav.html' %}

  <!-- Info Modal -->
  <div class="info-modal" id="info-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="info-title">
    <div class="info-box" role="document" tabindex="-1">
      <button class="info-close" id="info-close" title="Close" aria-label="Close">&times;</button>

      <h2 id="info-title">About Labs</h2>
      <p>
        Tired of fumbling with different documents, notes and tabs while codebreaking? Look no further â€” Labs are your private cipher-solving environments. Each one holds a cipher text, notes, and access to our suite of cipher-solving tools and helpers.
        Use them to keep different puzzles separate and to build a history of your attempts. It's the ultimate cipher-solving environment.
      </p>

      <ul>
        <li><strong>Create & Organise</strong><br>Make a new workspace for each puzzle.</li>
        <li><strong>Search</strong><br>Filter by workspace title or cipher text.</li>
        <li><strong>Open & Continue</strong><br>Your edits are always saved.</li>
        <li><strong>Tips</strong><br>Keep hypotheses and cribs in notes.</li>
      </ul>

      <p class="tip">ðŸ§  <em>Tip:</em> Keep one workspace as a scratchpad.</p>
    </div>
  </div>

  <main class="wl-shell">
    <section class="wl-card" aria-label="Workspaces list">
      <header class="wl-top">
        <div class="wl-titlewrap">
          <span class="wl-dot" aria-hidden="true"></span>
          <div style="min-width:0;">
            <h1 class="wl-title">Your Labs</h1>
            <div class="wl-sub">Open a workspace to solve and annotate.</div>
          </div>
        </div>

        <div class="wl-actions">
          <div class="search">
            <input id="ws-search" type="text" placeholder="Search workspacesâ€¦" autocomplete="off" />
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </div>

          <!-- Info button: pulses only if logged in AND not seen -->
          <button
            class="info-btn {% if user and (not user.get('labs_info_seen')) %}pulse{% endif %}"
            id="info-open"
            type="button"
            aria-label="About Labs"
            data-user="{{ 1 if user else 0 }}"
            data-seen="{{ 1 if (user and user.get('labs_info_seen')) else 0 }}"
          >i</button>

          <!-- New Lab: if logged out, send to login (with next redirect) -->
          {% if user %}
            <a class="btn" href="{{ url_for('workspace_new') }}" id="new-lab-btn">New Lab</a>
          {% else %}
            <a class="btn" href="{{ url_for('login', next=request.path) }}">Log in to create a Lab</a>
          {% endif %}
        </div>
      </header>

      <div class="wl-body">
        {% if not user %}
          <div class="empty">
            <b>Labs are private.</b><br><br>
            Click the <b>i</b> button above to learn what Labs are.<br>
             <a class="personal" href="{{ url_for('login', next=request.path) }}">Log in</a> to create and manage your Labs.<br><br>
          </div>
        {% else %}
          {% if workspaces|length == 0 %}
            <div class="empty">
              No Lab yet.<br><br>
              <a class="btn" href="{{ url_for('workspace_new') }}" id="create-first-lab">Create your first Lab</a>
            </div>
          {% else %}
            <div class="grid" id="ws-grid">
              {% set ns = namespace(owned_seen=0) %}
              {% for w in workspaces %}
                {% set is_owner = (w.is_owner == 1) %}
                {% if is_owner %}{% set ns.owned_seen = ns.owned_seen + 1 %}{% endif %}
                {% set is_locked = (not viewer_is_pro) and is_owner and (ns.owned_seen > (free_max_labs or 3)) %}

                {% if is_locked %}
                  <div
                    class="ws-card locked"
                    draggable="false"
                    data-id="{{ w.id }}"
                    data-locked="1"
                    data-title="{{ (w.title or 'Untitled Workspace')|lower }}"
                    data-snippet="{{ ((w.cipher_text or w.notes or '')[:160])|lower }}"
                    title="Locked â€” upgrade to Labs Pro to unlock"
                    aria-disabled="true"
                  >
                {% else %}
                  <a
                    class="ws-card"
                    draggable="true"
                    data-id="{{ w.id }}"
                    href="{{ url_for('workspace_view', ws_id=w.id) }}"
                    data-title="{{ (w.title or 'Untitled Workspace')|lower }}"
                    data-snippet="{{ ((w.cipher_text or w.notes or '')[:160])|lower }}"
                  >
                {% endif %}
                  <div class="ws-head">
                    <h2 class="ws-name">{{ w.title or "Untitled Workspace" }}</h2>

                    <div style="display:flex;gap:8px;align-items:center;">
                      {% if is_locked %}
                        <span class="ws-lock" aria-hidden="true">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                          </svg>
                        </span>
                      {% endif %}
                      <span class="ws-chip">#{{ w.id }}</span>

                      <button
                        class="ws-delete"
                        data-id="{{ w.id }}"
                        type="button"
                        title="Delete workspace"
                        aria-label="Delete workspace"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24"
                          fill="none" stroke="currentColor" stroke-width="2"
                          stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                          <path d="M10 11v6"></path>
                          <path d="M14 11v6"></path>
                          <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                        </svg>
                      </button>
                    </div>
                  </div>

                  <p class="ws-snippet">
                    {% set preview = (w.cipher_text or w.notes or "") %}
                    {{ preview | striptags | truncate(180, True, "â€¦") }}
{% if preview|length > 180 %}â€¦{% endif %}
                  </p>

                  <div class="ws-meta">
                    <div><b>Updated:</b> {{ w.updated_at or "â€”" }}</div>
                    <div><b>Created:</b> {{ w.created_at or "â€”" }}</div>
                  </div>
                {% if is_locked %}
                  </div>
                {% else %}
                  </a>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        {% endif %}
      </div>
    </section>
  </main>

  <!-- Confirm Delete Modal -->
  <div class="confirm-modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
    <div class="confirm-box" role="document" tabindex="-1">
      <div class="confirm-top">
        <h3 id="confirm-title" class="confirm-title">Delete workspace?</h3>
        <button class="confirm-x" id="confirm-x" type="button" aria-label="Close">Ã—</button>
      </div>

      <p class="confirm-text">This will permanently delete the workspace. This canâ€™t be undone.</p>

      <div class="confirm-actions">
        <button class="confirm-btn secondary" id="confirm-cancel" type="button">Cancel</button>
        <button class="confirm-btn danger" id="confirm-ok" type="button">Delete</button>
      </div>
    </div>
  </div>

  <!-- Labs Pro Modal (same treatment) -->
  <div id="pro-modal" class="promodal" aria-hidden="true">
    <div class="promodal-backdrop" data-pro-close="1"></div>

    <div class="promodal-box" role="dialog" aria-modal="true" aria-label="Labs Pro required">
      <div class="promodal-hero">
        <div class="promodal-top">
          <div class="promodal-title">
            <span class="pro-chip">PRO</span>
            <span id="pro-title">Labs Pro required</span>
          </div>
          <button class="promodal-x" id="pro-x" type="button" aria-label="Close">âœ•</button>
        </div>
      </div>

      <div class="promodal-body">
        <div id="pro-body">
          Youâ€™ve hit the free limit. Upgrade to Labs Pro to keep going.
        </div>

        <ul class="promodal-list">
          <li><span class="tick">âœ“</span> Export lab as PDF</li>
          <li><span class="tick">âœ“</span> Clone any lab instantly</li>
          <li><span class="tick">âœ“</span> Lab history (snapshots)</li>
          <li><span class="tick">âœ“</span> Unlimited Labs</li>
          <li><span class="tick">âœ“</span> Unlimited Tabs (images)</li>
          <li><span class="tick">âœ“</span> Pro badge across the site</li>

        </ul>
      </div>

      <div class="promodal-actions">
        <button class="promodal-btn" id="pro-cancel" type="button">Not now</button>
        <a class="promodal-btn primary" id="pro-go" href="/labs-pro">View Labs Pro</a>
      </div>
    </div>
  </div>

  <script>
  // ===== Labs Pro modal helpers (same behavior) =====
  function openProModal({
    title = "Labs Pro required",
    body = "Youâ€™ve hit the free limit. Upgrade to Labs Pro to keep going.",
    href = "/labs-pro",
    cta = "View Labs Pro"
  } = {}) {
    const modal = document.getElementById("pro-modal");
    const titleEl = document.getElementById("pro-title");
    const bodyEl = document.getElementById("pro-body");
    const btnX = document.getElementById("pro-x");
    const btnCancel = document.getElementById("pro-cancel");
    const btnGo = document.getElementById("pro-go");

    if (!modal || !titleEl || !bodyEl || !btnCancel || !btnGo) return;

    titleEl.textContent = title;
    bodyEl.textContent = body;
    btnGo.textContent = cta;
    btnGo.href = href;

    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");

    const close = () => {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      btnCancel.removeEventListener("click", onClose);
      btnX?.removeEventListener("click", onClose);
      modal.removeEventListener("click", onBackdrop);
      document.removeEventListener("keydown", onKey);
    };

    const onClose = () => close();
    const onBackdrop = (e) => {
      const closeEl = e.target?.closest?.("[data-pro-close='1']");
      if (closeEl) close();
    };
    const onKey = (e) => {
      if (e.key === "Escape") close();
    };

    btnCancel.addEventListener("click", onClose);
    btnX?.addEventListener("click", onClose);
    modal.addEventListener("click", onBackdrop);
    document.addEventListener("keydown", onKey);
  }

  async function maybeHandleProGate(res, data, context = "action") {
    const status = res?.status;

    if (status === 402 || status === 403) {
      openProModal({
        title: "Labs Pro required",
        body: context === "create"
          ? "Youâ€™ve hit the free Lab limit. Upgrade to create unlimited Labs."
          : "Youâ€™ve hit a free limit. Upgrade to Labs Pro to keep going.",
        href: "/labs-pro",
        cta: "Upgrade to Pro"
      });
      return true;
    }

    const err = (data?.error || "").toLowerCase();
    if (err.includes("pro") || err.includes("limit") || err.includes("upgrade")) {
      openProModal({
        title: "Labs Pro required",
        body: data?.error || "Youâ€™ve hit a free limit. Upgrade to Labs Pro to keep going.",
        href: "/labs-pro",
        cta: "View Labs Pro"
      });
      return true;
    }

    return false;
  }

  // Locked Lab cards (for users who downgraded from Pro but still have > free_max_labs)
  (() => {
    const locked = [...document.querySelectorAll(".ws-card.locked[data-locked='1']")];
    if (!locked.length) return;

    locked.forEach(card => {
      card.addEventListener("click", (e) => {
        // let delete button still work
        if (e.target?.closest?.(".ws-delete")) return;
        e.preventDefault?.();
        openProModal({
          title: "Locked Lab",
          body: "Upgrade to Labs Pro to open Labs beyond the free limit.",
          href: "/labs-pro",
          cta: "Upgrade to Pro"
        });
      });
    });
  })();

  // Intercept "New Lab" + "Create your first Lab" to show Pro modal on gate
  (() => {
    const btns = [
      document.getElementById("new-lab-btn"),
      document.getElementById("create-first-lab")
    ].filter(Boolean);

    if (btns.length === 0) return;

    btns.forEach(a => {
      a.addEventListener("click", async (e) => {
        // If it isn't an <a> or has no href, do nothing
        const href = a.getAttribute("href");
        if (!href) return;

        e.preventDefault();

        try {
          // Ask server if creation is allowed (you implement this endpoint OR reuse your create route)
          // Recommended: return {ok:true, redirect:"/workspaces/new"} or {ok:false, error:"..."} with 402/403 for Pro gating.
          const res = await fetch("/workspaces/can-create", { method: "GET" });
          const data = await res.json().catch(() => ({}));

          if (await maybeHandleProGate(res, data, "create")) return;

          if (data.ok && data.redirect) {
            window.location.href = data.redirect;
            return;
          }

          // fallback: just go to the normal new page
          window.location.href = href;
        } catch {
          window.location.href = href;
        }
      });
    });
  })();

  // Search (only meaningful when logged in + cards exist)
  (() => {
    const input = document.getElementById("ws-search");
    const cards = [...document.querySelectorAll(".ws-card")];
    if (!input || cards.length === 0) return;

    input.addEventListener("input", () => {
      const q = input.value.toLowerCase();
      cards.forEach(c => {
        c.style.display =
          !q || c.dataset.title.includes(q) || c.dataset.snippet.includes(q)
          ? "" : "none";
      });
    });
  })();

  // Drag & drop reorder (only when grid exists)
  (() => {
    const grid = document.getElementById("ws-grid");
    if (!grid) return;

    let dragged = null;

    grid.querySelectorAll(".ws-card").forEach(card => {
      card.addEventListener("dragstart", () => {
        dragged = card;
        card.style.opacity = "0.5";
      });

      card.addEventListener("dragend", () => {
        dragged = null;
        card.style.opacity = "";
      });

      card.addEventListener("dragover", e => e.preventDefault());

      card.addEventListener("drop", e => {
        e.preventDefault();
        if (!dragged || dragged === card) return;

        const cards = [...grid.children];
        const from = cards.indexOf(dragged);
        const to = cards.indexOf(card);

        grid.insertBefore(dragged, from < to ? card.nextSibling : card);
        persistOrder();
      });
    });

    async function persistOrder(){
      const order = [...grid.children].map(c => c.dataset.id);

      try{
        const res = await fetch("/workspaces/reorder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ order })
        });

        const data = await res.json().catch(() => ({}));
        if (await maybeHandleProGate(res, data, "reorder")) return;
      }catch(_e){}
    }
  })();

  // Delete workspace (custom modal confirm) â€” only if delete buttons exist
  (() => {
    const modal = document.getElementById("confirm-modal");
    const box = modal?.querySelector(".confirm-box");
    const okBtn = document.getElementById("confirm-ok");
    const cancelBtn = document.getElementById("confirm-cancel");
    const xBtn = document.getElementById("confirm-x");
    const deleteBtns = document.querySelectorAll(".ws-delete");
    if (!modal || !box || !okBtn || !cancelBtn || !xBtn || deleteBtns.length === 0) return;

    let pending = { id: null, card: null, opener: null };

    function openConfirm({ id, card, opener }) {
      pending = { id, card, opener };
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      box.focus();
    }

    function closeConfirm() {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      pending.opener?.focus?.();
      pending = { id: null, card: null, opener: null };
    }

    deleteBtns.forEach(btn => {
      btn.addEventListener("click", e => {
        e.preventDefault();
        e.stopPropagation();
        const id = btn.dataset.id;
        const card = btn.closest(".ws-card");
        openConfirm({ id, card, opener: btn });
      });
    });

    okBtn.addEventListener("click", async () => {
      if (!pending.id) return closeConfirm();
      okBtn.disabled = true;
      okBtn.textContent = "Deletingâ€¦";
      try {
        const res = await fetch(`/workspaces/${pending.id}/delete`, { method: "POST" });
        const data = await res.json().catch(() => ({}));

        if (await maybeHandleProGate(res, data, "delete")) return;

        if (res.ok) pending.card?.remove();
      } finally {
        okBtn.disabled = false;
        okBtn.textContent = "Delete";
        closeConfirm();
      }
    });

    cancelBtn.addEventListener("click", closeConfirm);
    xBtn.addEventListener("click", closeConfirm);

    modal.addEventListener("click", (e) => { if (e.target === modal) closeConfirm(); });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("open")) closeConfirm();
    });
  })();

  // Info modal (+ mark as seen once ONLY if logged in)
  (() => {
    const modal = document.getElementById("info-modal");
    const open = document.getElementById("info-open");
    const close = document.getElementById("info-close");
    const box = modal?.querySelector(".info-box");
    if (!modal || !open || !close || !box) return;

    async function markInfoSeenOnce(){
      // logged out? don't persist "seen"
      if (open.dataset.user !== "1") return;

      if (open.dataset.seen === "1") return;

      // stop pulsing immediately
      open.classList.remove("pulse");
      open.dataset.seen = "1";

      // best-effort server update
      try{
        await fetch("/prefs/labs-info-seen", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ seen: true })
        });
      }catch(_e){}
    }

    open.addEventListener("click", () => {
      modal.classList.add("open");
      modal.setAttribute("aria-hidden", "false");
      box.focus();
      document.body.style.overflow = "hidden";
      markInfoSeenOnce();
    });

    close.addEventListener("click", () => {
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      open.focus();
    });

    modal.addEventListener("click", (e) => { if (e.target === modal) close.click(); });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("open")) close.click();
    });
  })();
  </script>
</body>
</html>
