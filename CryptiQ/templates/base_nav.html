<!-- base_nav.html -->

<!-- === FLASH MESSAGE BAR === -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-bar flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
    <script>
      setTimeout(() => {
        document.querySelectorAll('.flash-bar').forEach(el => {
          el.classList.add('hide');
          setTimeout(() => el.remove(), 500);
        });
      }, 4000);
    </script>
  {% endif %}
{% endwith %}

<!-- === NAVBAR === -->
<nav class="navbar">
  {% set setup_needed = setup_needed_global|default(false) %}
  <div class="nav-left">
    <a href="{{ url_for('index') }}" class="nav-logo">The Cipher Lab</a>
  </div>

  <!-- Hamburger -->
  <button class="hamburger" id="hamburger" aria-label="Menu" aria-expanded="false">
    <span></span><span></span><span></span>
  </button>

  <ul class="nav-items" id="nav-menu">
    {% if user %}
      <!-- Mobile account panel -->
      <li class="nav-account-mobile">
        <button class="mobile-account-trigger" id="mobile-account-trigger" type="button" aria-expanded="false">
          <div class="avatar{% if setup_needed %} setup-pulse{% endif %}">{{ user['username'][0].upper() }}</div>

          <div class="mobile-account-meta">
            <div class="mobile-account-name">
              <span class="mobile-username">{{ user['username'] }}</span>
              <span class="mobile-badges">
                {% if user.is_admin %}<span class="admin-badge">Admin</span>{% endif %}
                {% if user.is_pro %}<span class="pro-badge">PRO</span>{% endif %}
              </span>
            </div>
            <div class="mobile-account-sub">Signed in</div>
            {% if setup_needed %}
              <div class="setup-hint">Click here to set username &amp; password</div>
            {% endif %}
          </div>

          <span class="chev" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2"
                 stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </button>

        <div class="mobile-account-panel" id="mobile-account-panel" aria-hidden="true">
          <a class="account-item" href="{{ url_for('account') }}">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21a8 8 0 0 0-16 0"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </span>
            <span>Account</span>
          </a>

          <a class="account-item" href="{{ url_for('posts_new') }}">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
              </svg>
            </span>
            <span>New Post</span>
          </a>

          <div class="account-sep"></div>

          <a class="account-item danger" href="{{ url_for('logout') }}">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                   stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <path d="M16 17l5-5-5-5"/>
                <path d="M21 12H9"/>
              </svg>
            </span>
            <span>Logout</span>
          </a>
        </div>
      </li>
    {% endif %}

    <!-- ===== MOBILE DROPDOWNS (Tools / Community) ===== -->
    <li class="m-dd" data-mdd="tools">
      <button class="m-dd-trigger" type="button" aria-expanded="false">
        <span>Tools</span>
        <span class="m-dd-caret" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </span>
      </button>
      <div class="m-dd-panel" aria-hidden="true">
        <a class="m-dd-item" href="{{ url_for('encode_decode') }}">Encode/Decode</a>
        <a class="m-dd-item" href="{{ url_for('breaker') }}">Cipher Breaker</a>
        <a class="m-dd-item" href="{{ url_for('tools_page') }}">All Tools</a>
      </div>
    </li>

    <li class="m-only"><a class="nav-link" href="{{ url_for('info_page') }}">Info</a></li>

    <li class="m-dd" data-mdd="community">
      <button class="m-dd-trigger" type="button" aria-expanded="false">
        <span>Community</span>
        <span class="m-dd-caret" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </span>
      </button>
      <div class="m-dd-panel" aria-hidden="true">
        <a class="m-dd-item" href="{{ url_for('posts_list') }}">Posts</a>
        <a class="m-dd-item" href="{{ url_for('weekly_page') }}">Weekly Cipher</a>
        <a class="m-dd-item" href="{{ url_for('leaderboard') }}">Leaderboard</a>
      </div>
    </li>

    <li class="m-only"><a class="nav-link" href="{{ url_for('workspace_list') }}">My Labs</a></li>

    <li class="m-only">
      <a class="nav-link" href="{{ url_for('labs_pro_page') }}">
        Labs <span class="pro-badge">PRO</span>
      </a>
    </li>

    {% if user and user.is_admin %}
      <li class="m-only"><a class="nav-link" href="{{ url_for('admin_dashboard') }}">Admin</a></li>
    
    {% endif %}

    {% if not user %}
      <li class="m-only"><a class="nav-link" href="{{ url_for('login') }}">Login</a></li>
      <li class="m-only"><a class="nav-link" href="{{ url_for('register') }}">Register</a></li>
    {% endif %}

    <!-- ===== DESKTOP NAV (Tools / Community) ===== -->
    <li class="nav-dd" data-dd="tools">
      <button class="nav-dd-trigger" type="button" aria-expanded="false">
        Tools
        <span class="nav-dd-caret" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </span>
      </button>
      <div class="nav-dd-menu" role="menu" aria-hidden="true">
  <div class="nav-dd-inner">
    <a role="menuitem" href="{{ url_for('encode_decode') }}">Encode/Decode</a>
    <a role="menuitem" href="{{ url_for('breaker') }}">Cipher Breaker</a>
    <a role="menuitem" href="{{ url_for('tools_page') }}">All Tools</a>
  </div>
</div>

    </li>

    <li class="d-only"><a class="nav-link" href="{{ url_for('info_page') }}">Info</a></li>

    <li class="nav-dd" data-dd="community">
      <button class="nav-dd-trigger" type="button" aria-expanded="false">
        Community
        <span class="nav-dd-caret" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
               stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </span>
      </button>
      <div class="nav-dd-menu" role="menu" aria-hidden="true">
        <a role="menuitem" href="{{ url_for('posts_list') }}">Posts</a>
        <a role="menuitem" href="{{ url_for('weekly_page') }}">Weekly Cipher</a>
        <a role="menuitem" href="{{ url_for('leaderboard') }}">Leaderboard</a>
      </div>
    </li>

    <li class="d-only"><a class="nav-link" href="{{ url_for('workspace_list') }}">My Labs</a></li>

    <li class="d-only">
      <a class="nav-link" href="{{ url_for('labs_pro_page') }}">
        Labs <span class="pro-badge">PRO</span>
      </a>
    </li>

    {% if user and user.is_admin %}
      <li class="d-only"><a class="nav-link" href="{{ url_for('admin_dashboard') }}">Admin</a></li>
      <li class="d-only"><a class="nav-link" href="{{ url_for('admin_labs_analytics') }}">Labs Analytics</a></li>

    {% endif %}

    {% if not user %}
      <li class="d-only"><a class="nav-link" href="{{ url_for('login') }}">Login</a></li>
      <li class="d-only"><a class="nav-link" href="{{ url_for('register') }}">Register</a></li>
    {% endif %}

    <li class="nav-extra-mobile">
      <button id="theme-toggle-mobile" aria-label="Toggle theme" title="Toggle theme">
        <svg id="theme-icon-mobile" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
        <span id="theme-toggle-text-mobile">Dark</span>
      </button>
    </li>
  </ul>

  <!-- Right side desktop -->
  <div class="nav-right">
    <button id="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
      <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
           viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
      <span id="theme-toggle-text">Dark</span>
    </button>

    {% if user %}
      <!-- Notification bell -->
      <div class="notif-wrapper">
        <button id="notif-btn" class="notif-btn" aria-label="Notifications" title="Notifications">
          <svg id="notif-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span id="notif-badge" class="notif-badge">0</span>
        </button>

        <div class="notif-dropdown" id="notif-dropdown">
          <div class="notif-header">Notifications</div>
          <div class="notif-list" id="notif-list">
            <p class="notif-empty">No notifications yet.</p>
          </div>
        </div>
      </div>

      <!-- Desktop profile dropdown -->
      <div class="profile-dropdown" id="profile-dd">
        <button class="profile-btn" id="profile-btn" aria-label="Profile menu" aria-expanded="false">
          <div class="avatar{% if setup_needed %} setup-pulse{% endif %}">{{ user['username'][0].upper() }}</div>
          {% if setup_needed %}<span class="setup-bubble">Click here to set username &amp; password</span>{% endif %}
        </button>

        <div class="account-menu" id="profile-menu" aria-hidden="true">
          <div class="account-head">
            <div class="account-head-left">
              <div class="dd-avatar{% if setup_needed %} setup-pulse{% endif %}">{{ user['username'][0].upper() }}</div>
              <div class="account-head-meta">
                <div class="account-name-row">
                  <span class="account-username">{{ user['username'] }}</span>
                    {% if user.is_admin %}<span class="admin-badge">Admin</span>{% endif %}
                    {% if user.is_pro %}<span class="pro-badge">PRO</span>{% endif %}
                </div>
                <div class="account-sub">Signed in</div>
              </div>
            </div>
          </div>

          <div class="account-list">
            <a class="account-item" href="{{ url_for('account') }}">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21a8 8 0 0 0-16 0"/>
                  <circle cx="12" cy="7" r="4"/>
                </svg>
              </span>
              <span>Account</span>
            </a>

            <a class="account-item" href="{{ url_for('posts_new') }}">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 20h9"/>
                  <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                </svg>
              </span>
              <span>New Post</span>
            </a>

            <div class="account-sep"></div>

            <a class="account-item danger" href="{{ url_for('logout') }}">
              <span class="ico" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                  <path d="M16 17l5-5-5-5"/>
                  <path d="M21 12H9"/>
                </svg>
              </span>
              <span>Logout</span>
            </a>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</nav>

<!-- === STYLES === -->
<style>
/* === NAVBAR === */
.navbar {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 68px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(18,18,18,0.8);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding: 0 20px;
  z-index: 1000;
}

body { padding-top: 80px; }
@media (max-width: 900px) {
  .navbar { height: 60px; }
  body { padding-top: 75px; }
}

/* Logo */
.nav-logo {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  text-decoration: none;
  transition: color 0.25s ease;
}
.nav-logo:hover { color: #00e6c2; }

/* Menu links container */
.nav-items {
  display: flex;
  list-style: none;
  gap: 14px;
  align-items: center;
  margin: 0 auto;
  padding: 0;
}

/* Consistent links/buttons */
.nav-link,
.nav-dd-trigger {
  all: unset;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 10px;
  font-weight: 650;
  line-height: 1;
  color: var(--text);
  cursor: pointer;
  user-select: none;
  transition: background .16s ease, color .16s ease, transform .16s ease;
}
.nav-link { text-decoration: none; }
.nav-link:hover,
.nav-dd-trigger:hover {
  background: rgba(255,255,255,0.05);
  color: var(--accent);
}
.nav-link:active,
.nav-dd-trigger:active { transform: translateY(0.5px); }
.nav-dd-trigger:focus-visible,
.nav-link:focus-visible{
  outline: 2px solid rgba(0,255,213,0.35);
  outline-offset: 2px;
}

/* Right side */
.nav-right {
  display: flex;
  align-items: center;
  gap: 18px;
  position: relative;
}

/* Theme toggle */
#theme-toggle, #theme-toggle-mobile {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border: 1px solid var(--line, #333);
  border-radius: 10px;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s;
}
#theme-toggle:hover, #theme-toggle-mobile:hover {
  background: rgba(0,255,213,0.12);
  border-color: rgba(0,255,213,0.4);
}

/* Avatar */
.profile-btn {
  all: unset;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-radius: 50%;
}
.avatar {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  font-weight: 800;
  font-size: 1rem;
  transition: box-shadow .2s ease, transform .2s ease;
}
:root:not([data-theme="light"]) .avatar {
  background: #0b0b0b;
  color: var(--accent);
  border: 1.5px solid var(--accent);
}
[data-theme="light"] .avatar {
  background: #f5f5f5;
  color: #00bfae;
  border: 1.5px solid #00bfae;
}
.profile-btn:hover .avatar{
  box-shadow: 0 0 10px rgba(0,255,213,0.35);
  transform: scale(1.03);
}

/* ===== Account setup attention (Pro-first users) ===== */
@keyframes setupPulse {
  0%   { box-shadow: 0 0 0 rgba(0,255,213,0.0); transform: scale(1); }
  50%  { box-shadow: 0 0 22px rgba(0,255,213,0.45); transform: scale(1.06); }
  100% { box-shadow: 0 0 0 rgba(0,255,213,0.0); transform: scale(1); }
}
.avatar.setup-pulse,
.dd-avatar.setup-pulse{
  animation: setupPulse 1.25s ease-in-out infinite;
}

/* Mobile hint under Signed in */
.setup-hint{
  margin-top: 4px;
  font-size: 0.78rem;
  font-weight: 850;
  color: var(--accent);
}

@media (max-width: 900px){
  }


@keyframes proShine{
  0%, 55% { transform: translateX(-120%) rotate(8deg); }
  100%    { transform: translateX(120%) rotate(8deg); }
}
@media (max-width: 640px) {
  .pro-badge{
    font-size: 0.65rem;
    padding: 2px 6px;
    border-radius: 6px;
  }
}

/* Desktop dropdowns */
.nav-dd{ position: relative; }
.nav-dd-caret{
  display: grid;
  place-items: center;
  width: 14px;
  height: 14px;
  opacity: .75;
  transition: transform .18s ease, opacity .18s ease;
}
.nav-dd-caret svg{ width: 14px; height: 14px; display:block; }
.nav-dd.open .nav-dd-caret{ transform: rotate(180deg); opacity: .95; }

.nav-dd-menu{
  position: absolute;
  left: 0;
  top: calc(100% + 10px);
  min-width: 220px;
  padding: 8px;
  border-radius: 14px;
  background: color-mix(in oklab, var(--panel) 92%, transparent);
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: 0 18px 50px rgba(0,0,0,0.55);
  backdrop-filter: blur(16px);
  z-index: 2000;

  transform-origin: top;
  opacity: 0;
  transform: translateY(-6px) scale(0.98);
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
}
.nav-dd.open .nav-dd-menu{
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}
.nav-dd-menu a{
  display: flex;
  align-items: center;
  padding: 9px 10px;
  border-radius: 10px;
  text-decoration: none;
  color: var(--text);
  font-weight: 650;
  line-height: 1.1;
  transition: background .16s ease, color .16s ease;
}
.nav-dd-menu a:hover{
  background: rgba(255,255,255,0.06);
  color: var(--accent);
}

/* Notifications (same as before) */
.notif-wrapper { position: relative; }
.notif-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--line, #333);
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s;
}
.notif-btn:hover {
  background: rgba(0,255,213,0.12);
  border-color: rgba(0,255,213,0.4);
}
.notif-badge {
  position: absolute;
  top: -4px;
  right: -2px;
  min-width: 16px;
  height: 16px;
  padding: 0 4px;
  border-radius: 999px;
  background: #ff4d4f;
  color: #fff;
  font-size: 0.7rem;
  display: none;
  align-items: center;
  justify-content: center;
  line-height: 1;
}
.notif-dropdown {
  position: absolute;
  right: 0;
  top: 120%;
  width: 280px;
  background: color-mix(in oklab, var(--panel) 90%, transparent);
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  backdrop-filter: blur(14px);
  z-index: 2001;
  opacity: 0;
  transform: translateY(-4px) scale(0.97);
  pointer-events: none;
  transition: opacity .2s ease, transform .2s ease;
}
.notif-dropdown.open {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: all;
}
.notif-header {
  padding: 8px 12px;
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--accent);
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.notif-list { max-height: 260px; overflow-y: auto; }
.notif-empty { padding: 10px 12px; font-size: 0.9rem; color: var(--muted); margin: 0; }
.notif-item {
  width: 100%;
  border: none;
  background: transparent;
  padding: 8px 12px;
  text-align: left;
  display: block;
  cursor: pointer;
  transition: background 0.18s ease;
}
.notif-item:hover { background: rgba(255,255,255,0.06); }
.notif-title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
.notif-message { font-size: 0.82rem; color: var(--muted); margin-top: 2px; }

/* Desktop account menu */
.profile-dropdown{ position: relative; }
.account-menu{
  position: absolute;
  right: 0;
  top: calc(100% + 10px);
  width: 280px;
  max-width: calc(100vw - 20px);
  padding: 10px;
  border-radius: 16px;
  background: color-mix(in oklab, var(--panel) 92%, transparent);
  border: 1px solid rgba(255,255,255,0.10);
  box-shadow: 0 18px 50px rgba(0,0,0,0.55);
  backdrop-filter: blur(16px);
  z-index: 2002;

  opacity: 0;
  transform: translateY(-6px) scale(0.98);
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
  overflow: hidden;
}
.profile-dropdown.open .account-menu{
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: all;
}
.account-head{
  padding: 10px;
  border-radius: 14px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  margin-bottom: 8px;
}
.account-head-left{
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
}
.dd-avatar{
  width: 40px;
  height: 40px;
  border-radius: 999px;
  display: grid;
  place-items: center;
  font-weight: 900;
  background: rgba(0,255,213,0.10);
  border: 1px solid rgba(0,255,213,0.35);
  color: var(--accent);
  flex: 0 0 auto;
}
.account-head-meta{ min-width: 0; flex: 1; }
.account-name-row{
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  min-width: 0;
}
.account-username{
  font-weight: 850;
  color: var(--text);
  min-width: 0;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.account-badges{
  display: inline-flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  min-width: 0;
}
.account-sub{
  margin-top: 3px;
  font-size: .85rem;
  color: var(--muted);
}
.account-list{ display: grid; gap: 6px; padding: 2px; }
.account-item{
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 10px;
  border-radius: 12px;
  text-decoration: none;
  color: var(--text);
  font-weight: 650;
  border: 1px solid transparent;
  background: transparent;
  transition: background .16s ease, border-color .16s ease, transform .16s ease;
}
.account-item:hover{
  background: rgba(255,255,255,0.06);
  border-color: rgba(255,255,255,0.08);
  transform: translateY(-1px);
}
.account-item .ico{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  display: grid;
  place-items: center;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.08);
  color: var(--text);
  flex: 0 0 auto;
}
.account-item .ico svg{ width: 16px; height: 16px; display:block; opacity: .95; }
.account-item.danger{ color: #ff6b6b; }
.account-item.danger .ico{
  color: #ff6b6b;
  border-color: rgba(255,90,90,0.18);
  background: rgba(255,90,90,0.06);
}
.account-item.danger:hover{
  background: rgba(255,90,90,0.12);
  border-color: rgba(255,90,90,0.22);
}
.account-sep{
  height: 1px;
  background: rgba(255,255,255,0.08);
  margin: 6px 6px;
}

/* Hamburger */
.hamburger {
  display: none;
  position: absolute;
  right: 20px;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 50%;
  width: 44px; height: 44px;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.hamburger span {
  width: 20px;
  height: 2px;
  background: var(--text);
  border-radius: 2px;
  transition: all 0.3s ease;
}
.hamburger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity: 0; }
.hamburger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

.nav-extra-mobile, .nav-account-mobile { display: none; }

/* Visibility helpers */
.m-dd, .m-only { display: none; }
.d-only { display: list-item; }

/* MOBILE SIDEBAR */
@media (max-width: 900px) {
  .hamburger { display: flex; }
  .nav-right { display: none; }

  /* desktop-only items hidden inside sidebar */
  .nav-dd, .d-only { display: none !important; }

  /* mobile-only items appear */
  .m-dd, .m-only { display: block; }
  .nav-account-mobile, .nav-extra-mobile { display: block; width: 100%; }

  .nav-items {
    position: fixed;
    top: 60px;
    right: -100%;
    flex-direction: column;
    align-items: flex-start;
    background: var(--panel);
    border-left: 1px solid rgba(255,255,255,0.06);
    width: 280px;
    height: calc(100vh - 60px);
    padding: 16px;
    gap: 10px;
    transition: right 0.35s cubic-bezier(0.25, 1, 0.3, 1);
    overflow-y: auto;
  }
  .nav-items.open { right: 0; }

  .nav-items li { width: 100%; }

  .nav-items li a.nav-link{
    width: 100%;
    box-sizing: border-box;
    justify-content: flex-start;
  }

  /* Mobile account trigger */
  .mobile-account-trigger{
    width: 100%;
    display: grid;
    grid-template-columns: 34px 1fr 16px;
    align-items: center;
    column-gap: 10px;
    padding: 10px 10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.03);
    color: var(--text);
    cursor: pointer;
    text-align: left;
  }
  .mobile-account-trigger .avatar{ width: 34px; height: 34px; }

  .mobile-account-meta{
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 2px;
  }
  .mobile-account-name{
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
    min-width: 0;
    line-height: 1.15;
  }
  .mobile-username{
    flex: 1 1 auto;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 850;
  }
  .mobile-badges{
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }
  .mobile-account-sub{
    margin: 0;
    line-height: 1.1;
    font-size: .85rem;
    color: var(--muted);
  }

  .chev{ display:grid; place-items:center; width:16px; height:16px; opacity:.8; transition: transform .18s ease; }
  .nav-account-mobile.open .chev{ transform: rotate(180deg); opacity:.95; }

  .mobile-account-panel{
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.02);
    display: none;
    box-sizing: border-box;
  }
  .nav-account-mobile.open .mobile-account-panel{
    display: grid;
    gap: 6px;
  }

  .mobile-account-panel a.account-item{
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 10px;
    min-height: 44px;
    border-radius: 12px;
    text-decoration: none;
    color: var(--text);
    font-weight: 650;
    border: 1px solid transparent;
    transition: background .16s ease, border-color .16s ease;
  }
  .mobile-account-panel a.account-item:hover{
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.08);
  }
  .mobile-account-panel a.account-item .ico{
    display: grid;
    place-items: center;
    width: 26px;
    height: 26px;
    border-radius: 10px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    flex: 0 0 26px;
  }
  .mobile-account-panel a.account-item .ico svg{
    width: 16px; height: 16px; display:block;
  }

  /* ===== Mobile dropdown sections ===== */
  .m-dd-trigger{
    all: unset;
    width: 100%;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1px;
    padding: 1px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);
    color: var(--text);
    font-weight: 750;
    cursor: pointer;
    transition: background .16s ease, border-color .16s ease;
  }
  .m-dd-trigger:hover{
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.12);
  }
  .m-dd-caret{
    display: grid;
    place-items: center;
    width: 18px; height: 18px;
    opacity: .8;
    transition: transform .18s ease, opacity .18s ease;
  }
  .m-dd-caret svg{ width: 16px; height: 16px; display:block; }
  .m-dd.open .m-dd-caret{ transform: rotate(180deg); opacity: .95; }

  .m-dd-panel{
    margin-top: 8px;
    padding: 8px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);

    display: grid;
    gap: 6px;

    /* animate open/close */
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-4px);
    transition: max-height .22s ease, opacity .18s ease, transform .18s ease;
  }
  .m-dd.open .m-dd-panel{
    max-height: 220px; /* enough for 3 links */
    opacity: 1;
    transform: translateY(0);
  }
  .m-dd-item{
    display: flex;
    align-items: center;
    padding: 3px 10px;
    border-radius: 10px;
    text-decoration: none;
    color: var(--text);
    font-weight: 650;
    background: transparent;
    border: 1px solid transparent;
    transition: background .16s ease, border-color .16s ease, color .16s ease;
  }
  .m-dd-item:hover{
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.08);
    color: var(--accent);
  }
}
/* === Tighten mobile sidebar spacing (dropdown gaps) === */
@media (max-width: 900px){

  /* overall vertical spacing between rows */
  .nav-items{
    gap: 8px; /* was ~10 */
  }

  /* reduce vertical padding on each dropdown trigger */
  .m-dd-trigger{
    padding: 8px 10px; /* was 10px 10px */
  }

  /* shrink the space BETWEEN trigger and its panel */
  .m-dd-panel{
    margin-top: 6px;   /* was 8px */
    padding: 6px;      /* was 8px */
    gap: 5px;          /* was 6px */
    border-radius: 11px;
  }

  /* shrink the clickable rows inside the panel */
  .m-dd-item{
    padding: 9px 10px; /* was 9px 10px */
    border-radius: 9px;
  }

  /* if account panel also feels roomy */
  .mobile-account-panel{
    margin-top: 6px; /* was 10px */
    padding: 8px;    /* was 10px */
  }
}
/* ===== Fix mobile dropdown “leaking / click-through” ===== */
@media (max-width: 900px){

  /* CLOSED state: panel is truly non-interactive + takes no space */
  .m-dd-panel{
    max-height: 0 !important;
    overflow: hidden !important;

    padding: 0 !important;
    margin-top: 0 !important;

    border: 0 !important;
    opacity: 0 !important;

    pointer-events: none !important;  /* ✅ stops clicking the first link */
  }

  /* OPEN state */
  .m-dd.open .m-dd-panel{
    max-height: 340px !important;     /* enough for your items; adjust if needed */
    overflow: hidden !important;

    margin-top: 6px !important;
    padding: 6px !important;

    border: 1px solid rgba(255,255,255,0.08) !important;
    opacity: 1 !important;

    pointer-events: auto !important;  /* ✅ clickable only when open */
  }

  /* If you want scroll inside when lots of items */
  .m-dd.open .m-dd-panel{
    overflow-y: auto !important;
  }
}
/* ===== Mobile: make dropdown triggers line up EXACTLY with normal links ===== */
@media (max-width: 900px){

  /* Make every list row full-width, no weird left padding */
  .nav-items > li{
    width: 100%;
    margin: 0;
    padding: 0;
  }

  /* Normal links in sidebar */
  .nav-items a.nav-link{
    width: 100%;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: space-between; /* keeps text + caret consistent if any */
    padding: 10px 10px;            /* <-- match your trigger */
  }

  /* Dropdown block itself */
  .m-dd{
    width: 100%;
    margin: 0;
    padding: 0;
  }

  /* Dropdown button (the thing that looks inset right now) */
  .m-dd-trigger{
    width: 100% !important;
    box-sizing: border-box !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;

    margin: 0 !important;
    padding: 10px 10px !important;   /* MUST match .nav-link padding */
    border-radius: 12px;
  }

  /* If the caret is making the right side feel different */
  .m-dd-caret{
    margin-left: 10px;
    flex: 0 0 auto;
  }
}

@media (max-width: 900px){

  /* smoother animation: use grid row animation instead of max-height */
  .m-dd-panel{
    display: grid !important;
    grid-template-rows: 0fr;          /* closed */
    opacity: 0;
    transform: translateY(-4px);
    transition: grid-template-rows .22s ease, opacity .18s ease, transform .18s ease;

    /* stop click-through */
    pointer-events: none;

    /* keep your look but avoid layout thrash */
    overflow: hidden;
  }

  /* inner wrapper to contain content height */
  .m-dd-panel > *{
    overflow: hidden;
  }

  .m-dd.open .m-dd-panel{
    grid-template-rows: 1fr;          /* open */
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* IMPORTANT: don't turn on scrolling during the animation */
  .m-dd.open .m-dd-panel{
    overflow-y: hidden !important;
  }

  /* If you need scrolling, only allow it AFTER it opens */
  .m-dd.open .m-dd-panel{
    max-height: none !important;
  }
}

/* Smooth dropdown reveal (no “first item then the rest”) */
.nav-dd-menu{
  display: grid;               /* override the old block/flex */
  grid-template-rows: 0fr;     /* closed */
  padding: 0 !important;       /* padding moves to inner */
  overflow: hidden;            /* important for 0fr */
  opacity: 0;
  transform: translateY(-6px) scale(0.98);
  pointer-events: none;
  transform-origin: top;

  transition:
    grid-template-rows 220ms cubic-bezier(.2,.8,.2,1),
    opacity 180ms ease,
    transform 180ms ease;
}

.nav-dd.open .nav-dd-menu{
  grid-template-rows: 1fr;     /* open */
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}

/* Inner keeps the real “card” styling stable */
.nav-dd-inner{
  overflow: hidden;
  padding: 8px;               /* was on .nav-dd-menu */
  border-radius: 14px;        /* match your menu radius */
}

/* keep links the same */
.nav-dd-inner a{
  display: flex;
  align-items: center;
}
/* =========================
   DESKTOP DROPDOWN — HOVER
   ========================= */

@media (min-width: 901px){

  .nav-dd{
    position: relative;
  }

  /* menu base */
  .nav-dd-menu{
    position: absolute;
    left: 0;
    top: calc(100% + 10px);
    min-width: 220px;

    padding: 8px;
    border-radius: 14px;
    background: color-mix(in oklab, var(--panel) 92%, transparent);
    border: 1px solid rgba(255,255,255,0.10);
    box-shadow: 0 18px 50px rgba(0,0,0,0.55);
    backdrop-filter: blur(16px);
    z-index: 2000;

    /* animation */
    opacity: 0;
    transform: translateY(-8px) scale(0.98);
    pointer-events: none;

    transition:
      opacity 180ms ease,
      transform 220ms cubic-bezier(.2,.8,.2,1);
  }

  /* show on hover OR keyboard focus */
  .nav-dd:hover .nav-dd-menu,
  .nav-dd:focus-within .nav-dd-menu{
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }

  /* caret animation */
  .nav-dd:hover .nav-dd-caret,
  .nav-dd:focus-within .nav-dd-caret{
    transform: rotate(180deg);
    opacity: .95;
  }

  /* menu items */
  .nav-dd-menu a{
    display: flex;
    align-items: center;
    padding: 9px 10px;
    border-radius: 10px;
    text-decoration: none;
    color: var(--text);
    font-weight: 650;
    line-height: 1.1;

    transition: background .16s ease, color .16s ease;
  }

  .nav-dd-menu a:hover{
    background: rgba(255,255,255,0.06);
    color: var(--accent);
  }
}
@media (min-width: 901px){

  /* reduce the gap so it's easier to reach */
  .nav-dd-menu{
    top: calc(100% + 6px) !important;
    display: block; /* ensure it isn't collapsing */
  }

  /* invisible hover bridge so moving mouse doesn't cancel hover */
  .nav-dd-menu::before{
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    top: -10px;      /* covers the gap above the menu */
    height: 10px;    /* must be >= the gap */
    background: transparent;
    pointer-events: auto;
  }

  /* make sure it stays open while hovering the menu itself */
  .nav-dd:hover .nav-dd-menu,
  .nav-dd:focus-within .nav-dd-menu{
    pointer-events: auto;
  }

  /* optional: make the dropdown feel more solid */
  .nav-dd-menu a{
    color: var(--text) !important;
  }
}
/* ===== DESKTOP: dropdown opens on hover (no click) ===== */
@media (min-width: 901px){

  .nav-dd{ position: relative; }

  /* Put menu directly under the trigger (no gap) */
  .nav-dd-menu{
    top: 100% !important;        /* was calc(100% + 10px) */
    left: 0;
    margin-top: 6px;             /* small spacing, but controlled */
    display: block;              /* ensure it can animate */
    pointer-events: none;
    opacity: 0;
    transform: translateY(-6px) scale(0.98);
    transition: opacity .18s ease, transform .18s ease;
    z-index: 2000;
  }

  /* THIS is the trick: extend hover area below the trigger */
  .nav-dd::after{
    content:"";
    position:absolute;
    left: -12px;                 /* widen to avoid “sweet spot” */
    right: -12px;
    top: 100%;
    height: 10px;                /* matches margin-top-ish */
    background: transparent;
  }

  /* Open when hovering trigger OR menu */
  .nav-dd:hover .nav-dd-menu,
  .nav-dd:focus-within .nav-dd-menu{
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }

  /* Optional: keep it open while hovering the menu itself */
  .nav-dd-menu:hover{
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }
}


/* ===== Setup hint bubble positioning (avoid navbar overlap) ===== */
.setup-bubble{
  position:absolute;
  right: 52px;           /* sit to the left of the avatar */
  top: 50%;
  transform: translateY(-50%);
  max-width: 260px;
  padding: 8px 10px;
  border-radius: 999px;
  font-weight: 900;
  font-size: 12px;
  line-height: 1;
  letter-spacing: .01em;
  color: var(--text);
  background: rgba(10, 20, 18, 0.92);
  border: 1px solid rgba(0,255,213,0.28);
  box-shadow: 0 8px 22px rgba(0,0,0,0.35);
  white-space: nowrap;
  pointer-events: none; /* never block clicks */
  z-index: 5;
}

/* If space is tight, move bubble below avatar instead of into nav links */
@media (max-width: 980px){
  .setup-bubble{
    right: 0;
    top: calc(100% + 10px);
    transform: none;
    white-space: normal;
    width: max-content;
    max-width: min(70vw, 320px);
  }
}

/* On very small screens, hide bubble (mobile already shows hint in the drawer) */
@media (max-width: 620px){
  .setup-bubble{ display:none; }
}

/* Mobile hint line style */
.setup-hint{
  margin-top: 6px;
  font-size: 12px;
  font-weight: 900;
  color: rgba(0,255,213,0.92);
}

</style>

<!-- === SCRIPT === -->
<script>
(function() {
  const burger = document.getElementById("hamburger");
  const menu = document.getElementById("nav-menu");

  const btn = document.getElementById("theme-toggle");
  const btnMobile = document.getElementById("theme-toggle-mobile");
  const icon = document.getElementById("theme-icon");
  const iconMobile = document.getElementById("theme-icon-mobile");
  const label = document.getElementById("theme-toggle-text");
  const labelMobile = document.getElementById("theme-toggle-text-mobile");
  const root = document.documentElement;

  const SUN = '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
  const MOON = '<path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/>';
  const STORAGE_KEY = "cipherlab.theme";

  function applyTheme(theme) {
    const isLight = theme === "light";
    if (isLight) {
      root.setAttribute("data-theme", "light");
      if (icon) icon.innerHTML = SUN;
      if (iconMobile) iconMobile.innerHTML = SUN;
      if (label) label.textContent = "Light";
      if (labelMobile) labelMobile.textContent = "Light";
    } else {
      root.removeAttribute("data-theme");
      if (icon) icon.innerHTML = MOON;
      if (iconMobile) iconMobile.innerHTML = MOON;
      if (label) label.textContent = "Dark";
      if (labelMobile) labelMobile.textContent = "Dark";
    }
  }

  const saved = localStorage.getItem(STORAGE_KEY);
  applyTheme(saved || (window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark"));

  [btn, btnMobile].forEach(b => {
    if (!b) return;
    b.addEventListener("click", () => {
      const isLight = root.getAttribute("data-theme") === "light";
      const next = isLight ? "dark" : "light";
      applyTheme(next);
      localStorage.setItem(STORAGE_KEY, next);
    });
  });

  // ===== Desktop nav dropdowns (Tools / Community) =====
  const dds = Array.from(document.querySelectorAll(".nav-dd"));
  function closeAllDD(except = null){
    dds.forEach(dd => {
      if (except && dd === except) return;
      dd.classList.remove("open");
      const trig = dd.querySelector(".nav-dd-trigger");
      const panel = dd.querySelector(".nav-dd-menu");
      trig?.setAttribute("aria-expanded","false");
      panel?.setAttribute("aria-hidden","true");
    });
  }
  dds.forEach(dd => {
    const trig = dd.querySelector(".nav-dd-trigger");
    const panel = dd.querySelector(".nav-dd-menu");
    if (!trig || !panel) return;
    panel.addEventListener("click", (e) => e.stopPropagation());
    trig.addEventListener("click", (e) => {
      e.stopPropagation();
      const willOpen = !dd.classList.contains("open");
      closeAllDD(dd);
      dd.classList.toggle("open", willOpen);
      trig.setAttribute("aria-expanded", willOpen ? "true" : "false");
      panel.setAttribute("aria-hidden", willOpen ? "false" : "true");
    });
  });
  document.addEventListener("click", () => closeAllDD(null));

  // ===== Mobile dropdown sections =====
  const mdds = Array.from(document.querySelectorAll(".m-dd"));
  function closeAllMDD(except = null){
    mdds.forEach(dd => {
      if (except && dd === except) return;
      dd.classList.remove("open");
      const trig = dd.querySelector(".m-dd-trigger");
      const panel = dd.querySelector(".m-dd-panel");
      trig?.setAttribute("aria-expanded","false");
      panel?.setAttribute("aria-hidden","true");
    });
  }
  mdds.forEach(dd => {
    const trig = dd.querySelector(".m-dd-trigger");
    const panel = dd.querySelector(".m-dd-panel");
    if (!trig || !panel) return;
    panel.addEventListener("click", (e) => e.stopPropagation());
    trig.addEventListener("click", (e) => {
      e.stopPropagation();
      const willOpen = !dd.classList.contains("open");
      closeAllMDD(dd); // accordion feel inside sidebar
      dd.classList.toggle("open", willOpen);
      trig.setAttribute("aria-expanded", willOpen ? "true" : "false");
      panel.setAttribute("aria-hidden", willOpen ? "false" : "true");
    });
  });

  // ===== Burger sidebar =====
  if (burger && menu) {
    burger.addEventListener("click", () => {
      const open = !menu.classList.contains("open");
      menu.classList.toggle("open", open);
      burger.classList.toggle("open", open);
      burger.setAttribute("aria-expanded", open ? "true" : "false");

      // close mobile account + mobile dropdowns whenever sidebar opens/closes
      const mobAcc = document.querySelector(".nav-account-mobile");
      mobAcc?.classList.remove("open");
      document.getElementById("mobile-account-trigger")?.setAttribute("aria-expanded", "false");
      document.getElementById("mobile-account-panel")?.setAttribute("aria-hidden", "true");
      closeAllMDD(null);
    });

    document.addEventListener("click", e => {
      if (!menu.contains(e.target) && !burger.contains(e.target)) {
        menu.classList.remove("open");
        burger.classList.remove("open");
        burger.setAttribute("aria-expanded", "false");

        const mobAcc = document.querySelector(".nav-account-mobile");
        mobAcc?.classList.remove("open");
        document.getElementById("mobile-account-trigger")?.setAttribute("aria-expanded", "false");
        document.getElementById("mobile-account-panel")?.setAttribute("aria-hidden", "true");
        closeAllMDD(null);
      }
    });
  }

  // ===== Notifications =====
  function humanTime(ts) {
    const date = new Date(ts);
    if (isNaN(date)) return ts;
    const now = new Date();
    const diff = (now - date) / 1000;
    if (diff < 60) return "Just now";
    if (diff < 3600) return Math.floor(diff / 60) + "m ago";
    if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
    if (date.toDateString() === now.toDateString()) return "Today";
    return date.toLocaleDateString("en-GB", { day: "2-digit", month: "short" });
  }

  const notifBtn = document.getElementById("notif-btn");
  const notifDropdown = document.getElementById("notif-dropdown");
  const notifList = document.getElementById("notif-list");
  const notifBadge = document.getElementById("notif-badge");

  async function refreshNotifications(openDropdown = false) {
    if (!notifBtn || !notifList || !notifBadge) return;
    try {
      const res = await fetch("/notifications/unread");
      if (!res.ok) return;
      const data = await res.json();
      if (!data.ok) return;

      const items = data.notifications || [];
      const unread = data.count || 0;

      if (unread > 0) {
        notifBadge.style.display = "flex";
        notifBadge.textContent = unread > 9 ? "9+" : String(unread);
      } else {
        notifBadge.style.display = "none";
      }

      if (openDropdown) {
        notifList.innerHTML = "";
        if (!items.length) {
          notifList.innerHTML = '<p class="notif-empty">No notifications yet.</p>';
        } else {
          items.forEach(n => {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "notif-item";
            if (n.is_read == 0) b.style.fontWeight = "700";

            const title = document.createElement("div");
            title.className = "notif-title";
            title.textContent = n.post_title || "Your post";

            const msg = document.createElement("div");
            msg.className = "notif-message";
            msg.textContent = `${n.message} • ${humanTime(n.created_at)}`;

            b.appendChild(title);
            b.appendChild(msg);

            b.addEventListener("click", () => {
              window.location.href = n.url;
            });

            notifList.appendChild(b);
          });
        }

        const unreadIds = items.filter(n => n.is_read === 0).map(n => n.id);
        if (unreadIds.length) {
          fetch("/notifications/mark_read", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids: unreadIds })
          }).catch(() => {});
          notifBadge.style.display = "none";
        }
      }
    } catch (err) {
      console.error("notif error", err);
    }
  }

  if (notifBtn && notifDropdown) {
    notifBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const open = !notifDropdown.classList.contains("open");
      notifDropdown.classList.toggle("open", open);
      if (open) await refreshNotifications(true);
    });

    document.addEventListener("click", e => {
      if (!notifDropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        notifDropdown.classList.remove("open");
      }
    });

    refreshNotifications(false);
    setInterval(() => refreshNotifications(false), 45000);
  }

  // ===== Desktop profile dropdown =====
  const profileDD = document.getElementById("profile-dd");
  const profileBtn = document.getElementById("profile-btn");
  const profileMenu = document.getElementById("profile-menu");

  function closeProfile() {
    profileDD?.classList.remove("open");
    profileBtn?.setAttribute("aria-expanded","false");
    profileMenu?.setAttribute("aria-hidden","true");
  }

  if (profileDD && profileBtn && profileMenu) {
    profileBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const open = !profileDD.classList.contains("open");
      profileDD.classList.toggle("open", open);
      profileBtn.setAttribute("aria-expanded", open ? "true" : "false");
      profileMenu.setAttribute("aria-hidden", open ? "false" : "true");
    });

    document.addEventListener("click", (e) => {
      if (!profileDD.contains(e.target)) closeProfile();
    });
  }

  // ===== Mobile account panel toggle =====
  const mobAcc = document.querySelector(".nav-account-mobile");
  const mobTrig = document.getElementById("mobile-account-trigger");
  const mobPanel = document.getElementById("mobile-account-panel");

  function closeMobileAccount() {
    mobAcc?.classList.remove("open");
    mobTrig?.setAttribute("aria-expanded","false");
    mobPanel?.setAttribute("aria-hidden","true");
  }

  if (mobAcc && mobTrig && mobPanel) {
    mobTrig.addEventListener("click", (e) => {
      e.stopPropagation();
      const open = !mobAcc.classList.contains("open");
      mobAcc.classList.toggle("open", open);
      mobTrig.setAttribute("aria-expanded", open ? "true" : "false");
      mobPanel.setAttribute("aria-hidden", open ? "false" : "true");
    });

    document.addEventListener("click", (e) => {
      if (!mobAcc.contains(e.target)) closeMobileAccount();
    });
  }

  // ESC closes all
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeProfile();
      closeMobileAccount();
      closeAllDD(null);
      closeAllMDD(null);
      notifDropdown?.classList.remove("open");
    }
  });
})();
</script>
