<!-- === FLASH MESSAGE BAR === -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="flash-bar flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
    <script>
      setTimeout(() => {
        document.querySelectorAll('.flash-bar').forEach(el => {
          el.classList.add('hide');
          setTimeout(() => el.remove(), 500);
        });
      }, 4000);
    </script>
  {% endif %}
{% endwith %}

<!-- === NAVBAR === -->
<nav class="navbar">
  <div class="nav-left">
    <a href="{{ url_for('index') }}" class="nav-logo">The Cipher Lab</a>
  </div>

  <!-- Hamburger -->
  <button class="hamburger" id="hamburger" aria-label="Menu" aria-expanded="false">
    <span></span><span></span><span></span>
  </button>

  <ul class="nav-items" id="nav-menu">
    {% if user %}
      <li class="nav-account-mobile">
        <div class="profile-dropdown mobile">
          <button class="profile-btn" id="profile-btn-mobile">
            <div class="avatar">{{ user['username'][0].upper() }}</div>
          </button>
          <div class="dropdown-menu mobile-menu" id="profile-menu-mobile">
            <p class="dropdown-username">{{ user['username'] }}</p>
            <a href="{{ url_for('account') }}">Account</a>
            <a href="{{ url_for('posts_new') }}">New Post</a>
            <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
          </div>
        </div>
      </li>
    {% endif %}
    <li><a href="{{ url_for('encode_decode') }}">Encode/Decode</a></li>
    <li><a href="{{ url_for('breaker') }}">Cipher Breaker</a></li>
    <li><a href="{{ url_for('tools_page') }}">Tools</a></li>
    <li><a href="{{ url_for('info_page') }}">Info</a></li>
    <li><a href="{{ url_for('posts_list') }}">Posts</a></li>
    <li><a href="{{ url_for('weekly_page') }}">Weekly Cipher</a></li>
    <li><a href="{{ url_for('leaderboard') }}">Leaderboard</a></li>
    <li><a href="{{ url_for('workspace_list') }}">My Labs</a></li>
      <li><a href="{{ url_for('labs_pro_page') }}">Labs Pro</a>
</li>


      {% if user and user.is_admin %}
  <li><a href="{{ url_for('admin_dashboard') }}">Admin</a></li>
{% endif %}

    {% if not user %}
      <li><a href="{{ url_for('login') }}">Login</a></li>
      <li><a href="{{ url_for('register') }}">Register</a></li>
    {% endif %}

    <li class="nav-extra-mobile">
      <button id="theme-toggle-mobile" aria-label="Toggle theme" title="Toggle theme">
        <svg id="theme-icon-mobile" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
             viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
        <span id="theme-toggle-text-mobile">Dark</span>
      </button>
    </li>
  </ul>

  <!-- Right side desktop -->
  <div class="nav-right">
    <button id="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
      <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
           viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
      <span id="theme-toggle-text">Dark</span>
    </button>

    {% if user %}
      <!-- ðŸ”” Notification bell -->
      <div class="notif-wrapper">
        <button id="notif-btn" class="notif-btn" aria-label="Notifications" title="Notifications">
          <svg id="notif-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span id="notif-badge" class="notif-badge">0</span>
        </button>

        <div class="notif-dropdown" id="notif-dropdown">
          <div class="notif-header">Notifications</div>
          <div class="notif-list" id="notif-list">
            <p class="notif-empty">No notifications yet.</p>
          </div>
        </div>
      </div>

      <div class="profile-dropdown">
        <button class="profile-btn" id="profile-btn">
          <div class="avatar">{{ user['username'][0].upper() }}</div>
        </button>
        <div class="dropdown-menu" id="profile-menu">
          <p class="dropdown-username">{{ user['username'] }}</p>
          <a href="{{ url_for('account') }}">Account</a>
          <a href="{{ url_for('posts_new') }}">New Post</a>
          <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
        </div>
      </div>
    {% endif %}
  </div>
</nav>

<!-- === STYLES === -->
<style>
/* === NAVBAR === */
.navbar {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 68px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(18,18,18,0.8);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  padding: 0 20px;
  z-index: 1000;
}

body { padding-top: 80px; }
@media (max-width: 900px) {
  .navbar { height: 60px;
   }
  body { padding-top: 75px; }
  
}

/* Logo */
.nav-logo {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
  text-decoration: none;
  transition: color 0.25s ease;
}
.nav-logo:hover { color: #00e6c2; }

/* Menu links */
.nav-items {
  display: flex;
  list-style: none;
  gap: 24px;
  align-items: center;
  margin: 0 auto;
  padding: 0;
}
.nav-items li a {
  color: var(--text);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.2s ease;
}
.nav-items li a:hover { color: var(--accent); }

/* Right side */
.nav-right {
  display: flex;
  align-items: center;
  gap: 18px;
  position: relative;
}

/* Theme toggle */
#theme-toggle, #theme-toggle-mobile {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  border: 1px solid var(--line, #333);
  border-radius: 8px;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s;
}
#theme-toggle:hover, #theme-toggle-mobile:hover {
  background: rgba(0,255,213,0.12);
  border-color: rgba(0,255,213,0.4);
}

/* Avatar */
.profile-btn {
  all: unset;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-radius: 50%;
}
.avatar {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  font-weight: 700;
  font-size: 1rem;
  transition: all 0.25s ease;
}
:root:not([data-theme="light"]) .avatar {
  background: #0b0b0b;
  color: var(--accent);
  border: 1.5px solid var(--accent);
}
[data-theme="light"] .avatar {
  background: #f5f5f5;
  color: #00bfae;
  border: 1.5px solid #00bfae;
}
.avatar:hover {
  box-shadow: 0 0 10px rgba(0,255,213,0.35);
  transform: scale(1.03);
}

/* === Dropdown menu === */
.profile-dropdown {
  position: relative;
}

.dropdown-menu {
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: -1px;
  background: color-mix(in oklab, var(--panel) 90%, transparent);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.45), inset 0 0 20px rgba(0,255,213,0.05);
  backdrop-filter: blur(14px);
  padding: 0;
  min-width: 200px;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  opacity: 0;
  transform: translateY(-4px) scale(0.97);
  pointer-events: none;
  transition: opacity .2s ease, transform .2s ease;
}

.profile-dropdown.open .dropdown-menu {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: all;
}

/* Username header */
.dropdown-username {
  font-weight: 700;
  color: var(--accent);
  background: linear-gradient(90deg, rgba(0,255,213,0.12), rgba(0,255,213,0));
  border-bottom: 1px solid rgba(255,255,255,0.06);
  margin: 0;
  padding: 8px 16px 10px;
  font-size: 0.95rem;
  text-align: left;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
}

.dropdown-menu a {
  color: var(--text);
  text-decoration: none;
  padding: 10px 16px;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  transition: background 0.2s ease, color 0.2s ease;
}

.dropdown-menu a:hover {
  background: var(--accent);
  color: #0f0f0f;
}

.logout-link {
  color: #ff6b6b !important;
  font-weight: 600;
  border-top: 1px solid rgba(255,255,255,0.08);
  margin-top: 4px;
  padding-top: 10px;
}

/* === Notifications === */
.notif-wrapper {
  position: relative;
}

.notif-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--line, #333);
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s;
}
.notif-btn:hover {
  background: rgba(0,255,213,0.12);
  border-color: rgba(0,255,213,0.4);
}

.notif-badge {
  position: absolute;
  top: -4px;
  right: -2px;
  min-width: 16px;
  height: 16px;
  padding: 0 4px;
  border-radius: 999px;
  background: #ff4d4f;
  color: #fff;
  font-size: 0.7rem;
  display: none;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* Dropdown */
.notif-dropdown {
  position: absolute;
  right: 0;
  top: 120%;
  width: 280px;
  background: color-mix(in oklab, var(--panel) 90%, transparent);
  border: 1px solid rgba(255,255,255,0.09);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  backdrop-filter: blur(14px);
  z-index: 1002;
  opacity: 0;
  transform: translateY(-4px) scale(0.97);
  pointer-events: none;
  transition: opacity .2s ease, transform .2s ease;
}

.notif-dropdown.open {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: all;
}

.notif-header {
  padding: 8px 12px;
  font-weight: 700;
  font-size: 0.9rem;
  color: var(--accent);
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.notif-list {
  max-height: 260px;
  overflow-y: auto;
}

.notif-empty {
  padding: 10px 12px;
  font-size: 0.9rem;
  color: var(--muted);
  margin: 0;
}

.notif-item {
  width: 100%;
  border: none;
  background: transparent;
  padding: 8px 12px;
  text-align: left;
  display: block;
  cursor: pointer;
  transition: background 0.18s ease;
}
.notif-item:hover {
  background: var(--input-hover, rgba(255,255,255,0.06));
}

.notif-title {
  font-weight: 600;
  font-size: 0.9rem;
  color: var(--text);
}
.notif-message {
  font-size: 0.82rem;
  color: var(--muted);
  margin-top: 2px;
}

/* Mobile */
.hamburger {
  display: none;
  position: absolute;
  right: 20px;
  background: rgba(255,255,255,0.07);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 50%;
  width: 44px; height: 44px;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.hamburger span {
  width: 20px;
  height: 2px;
  background: var(--text);
  border-radius: 2px;
  transition: all 0.3s ease;
}
.hamburger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity: 0; }
.hamburger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

.nav-extra-mobile, .nav-account-mobile { display: none; }

@media (max-width: 900px) {
  .hamburger { display: flex; }
  .nav-right { display: none; }

  .nav-items {
    position: fixed;
    top: 60px;
    right: -100%;
    flex-direction: column;
    align-items: flex-start;
    background: color-mix(in oklab, var(--panel, #f9f9f9) 90%, transparent);
    backdrop-filter: blur(14px);
    border-left: 1px solid rgba(255,255,255,0.06);
    width: 260px;
    height: calc(100vh - 60px);
    padding: 20px;
    gap: 14px;
    transition: right 0.35s cubic-bezier(0.25, 1, 0.3, 1);
  }
  .nav-items.open { right: 0; }
  .nav-account-mobile { display: block; }
  .nav-extra-mobile { display: block; }
}

/* Disable navbar spacing on certain pages */
body.no-nav-padding {
  padding-top: 0 !important;
}
/* ===============================
   MOBILE NAV â€” OPAQUE SIDEBAR
=============================== */
@media (max-width: 900px) {
  .nav-items {
    background: var(--panel);       /* solid background */
    backdrop-filter: none;          /* remove blur noise */
    -webkit-backdrop-filter: none;
  }
}

</style>

<!-- === SCRIPT === -->
<script>
(function() {
  const burger = document.getElementById("hamburger");
  const menu = document.getElementById("nav-menu");
  const btn = document.getElementById("theme-toggle");
  const btnMobile = document.getElementById("theme-toggle-mobile");
  const icon = document.getElementById("theme-icon");
  const iconMobile = document.getElementById("theme-icon-mobile");
  const label = document.getElementById("theme-toggle-text");
  const labelMobile = document.getElementById("theme-toggle-text-mobile");
  const root = document.documentElement;

  const SUN = '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
  const MOON = '<path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"/>';
  const STORAGE_KEY = "cipherlab.theme";

  function applyTheme(theme) {
    const isLight = theme === "light";
    if (isLight) {
      root.setAttribute("data-theme", "light");
      icon.innerHTML = iconMobile.innerHTML = SUN;
      label.textContent = labelMobile.textContent = "Light";
    } else {
      root.removeAttribute("data-theme");
      icon.innerHTML = iconMobile.innerHTML = MOON;
      label.textContent = labelMobile.textContent = "Dark";
    }
  }

  const saved = localStorage.getItem(STORAGE_KEY);
  applyTheme(saved || (window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark"));

  [btn, btnMobile].forEach(b => {
    if (!b) return;
    b.addEventListener("click", () => {
      const isLight = root.getAttribute("data-theme") === "light";
      const next = isLight ? "dark" : "light";
      applyTheme(next);
      localStorage.setItem(STORAGE_KEY, next);
    });
  });

  if (burger && menu) {
    burger.addEventListener("click", () => {
      const open = !menu.classList.contains("open");
      menu.classList.toggle("open", open);
      burger.classList.toggle("open", open);
    });

    document.addEventListener("click", e => {
      if (!menu.contains(e.target) && !burger.contains(e.target)) {
        menu.classList.remove("open");
        burger.classList.remove("open");
      }
    });
  }

  // =====================================================
  // ðŸ”” Relative time formatting ("1h ago", "Yesterday", etc.)
  // =====================================================
  function humanTime(ts) {
    const date = new Date(ts);
    if (isNaN(date)) return ts;

    const now = new Date();
    const diff = (now - date) / 1000;

    if (diff < 60) return "Just now";
    if (diff < 3600) return Math.floor(diff / 60) + "m ago";
    if (diff < 86400) return Math.floor(diff / 3600) + "h ago";

    // Yesterday?
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);

    if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
    if (date.toDateString() === now.toDateString()) return "Today";

    // 12 Nov format
    return date.toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "short"
    });
  }

  // =====================================================
  // ðŸ”” Notifications logic
  // =====================================================
  const notifBtn = document.getElementById("notif-btn");
  const notifDropdown = document.getElementById("notif-dropdown");
  const notifList = document.getElementById("notif-list");
  const notifBadge = document.getElementById("notif-badge");

  async function refreshNotifications(openDropdown = false) {
    if (!notifBtn || !notifList || !notifBadge) return;

    try {
      const res = await fetch("/notifications/unread");
      if (!res.ok) return;
      const data = await res.json();
      if (!data.ok) return;

      const items = data.notifications || [];
      const unread = data.count || 0;

      // ðŸ”´ Badge update
      if (unread > 0) {
        notifBadge.style.display = "flex";
        notifBadge.textContent = unread > 9 ? "9+" : String(unread);
      } else {
        notifBadge.style.display = "none";
      }

      if (openDropdown) {
        notifList.innerHTML = "";

        if (!items.length) {
          notifList.innerHTML = '<p class="notif-empty">No notifications yet.</p>';
        } else {
          items.forEach(n => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "notif-item";

            if (n.is_read == 0) btn.style.fontWeight = "700";

            const title = document.createElement("div");
            title.className = "notif-title";
            title.textContent = n.post_title || "Your post";

            const msg = document.createElement("div");
            msg.className = "notif-message";
            msg.textContent = `${n.message} â€¢ ${humanTime(n.created_at)}`;

            btn.appendChild(title);
            btn.appendChild(msg);

            btn.addEventListener("click", () => {
              window.location.href = n.url;
            });


            notifList.appendChild(btn);
          });
        }

        // Mark unread notifications as read (keep them in list)
        const unreadIds = items.filter(n => n.is_read === 0).map(n => n.id);
        if (unreadIds.length) {
          fetch("/notifications/mark_read", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ids: unreadIds })
          }).catch(() => {});
          notifBadge.style.display = "none";
        }
      }

    } catch (err) {
      console.error("notif error", err);
    }
  }

  if (notifBtn && notifDropdown) {
    notifBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const open = !notifDropdown.classList.contains("open");
      notifDropdown.classList.toggle("open", open);
      if (open) {
        await refreshNotifications(true);
      }
    });

    document.addEventListener("click", e => {
      if (!notifDropdown.contains(e.target) && !notifBtn.contains(e.target)) {
        notifDropdown.classList.remove("open");
      }
    });

    refreshNotifications(false);
    setInterval(() => refreshNotifications(false), 45000);
  }

  // =====================================================
  // Profile dropdown
  // =====================================================
  document.querySelectorAll(".profile-dropdown").forEach(dd => {
    const btn = dd.querySelector(".profile-btn");
    if (!btn) return;
    btn.addEventListener("click", e => {
      e.stopPropagation();
      dd.classList.toggle("open");
    });
    document.addEventListener("click", () => dd.classList.remove("open"));
  });

})();
</script>

