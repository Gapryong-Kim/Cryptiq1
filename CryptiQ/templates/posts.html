<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CryptiQ â€” Posts</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    /* ===== Posts Page Polish (uses global CSS variables) ===== */

    .posts-wrap {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .post-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--elev-shadow);
      padding: 18px;
      position: relative;
    }

    .post-top {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .post-title {
      color: var(--text);
      font-weight: 700;
      font-size: 1.05rem;
    }
    .post-meta {
      color: var(--muted);
      font-size: .9rem;
      white-space: nowrap;
      margin-left: auto;
    }
    .post-header-sub {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      color: var(--muted);
      font-size: .95rem;
    }
    .post-author { color: var(--text-dim); }

    .post-image { margin-top: 12px; }
    .post-image img {
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: var(--radius-md);
      border: 1px solid var(--line);
    }

    .post-body {
      margin-top: 12px;
      color: var(--text);
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.55;
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      padding: 12px;
    }

    /* --- Kebab (post actions) --- */
    .kebab-wrap { position: relative; margin-left: 8px; }
    .kebab-btn {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
      cursor: pointer;
      padding: 6px 8px;
      border-radius: var(--radius-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .kebab-btn:hover { background: var(--input-hover); }
    .kebab-dot {
      width: 4px; height: 4px; border-radius: 50%;
      background: currentColor; display: block; margin: 2px 0;
    }
    .kebab-menu {
      position: absolute; top: 38px; right: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      box-shadow: var(--elev-shadow);
      min-width: 180px; padding: 6px;
      display: none; z-index: 10;
    }
    .kebab-menu.open { display: block; }
    .kebab-item {
      width: 100%;
      background: transparent;
      color: var(--text);
      text-decoration: none;
      border: none;
      padding: 10px 12px;
      margin: 2px 0;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font: inherit;
      display: flex; align-items: center; justify-content: flex-start;
    }
    .kebab-item:hover { background: var(--input-hover); }
    .kebab-danger { color: var(--danger); }
    .kebab-danger:hover { background: rgba(255, 107, 107, .12); }

    /* --- Comments --- */
    .comments {
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: var(--radius-md);
      margin-top: 14px;
      display: none;
    }
    .comments.open { display: block; }
    .comments-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; border-bottom: 1px solid var(--line);
    }
    .comments-count { color: var(--accent); font-weight: 600; }

    .comment-list { list-style: none; margin: 0; padding: 0; }

    .comment {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 10px 14px; border-bottom: 1px solid var(--line);
      width: 100%; box-sizing: border-box;
    }
    .comment:last-child { border-bottom: none; }

    .comment-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      flex: 0 0 28px; display: flex; align-items: center; justify-content: center;
      color: var(--muted); font-weight: 700; font-size: 12px;
    }
    .comment-main { flex: 1 1 auto; min-width: 0; }
    .comment-top { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .comment-user { color: var(--text); font-weight: 600; }
    .comment-time { color: var(--muted-2); font-size: 12px; }
    .comment-body {
      color: var(--text);
      margin-top: 4px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
      max-width: 100%;
      line-height: 1.55;
    }

    .comment-actions { margin-left: auto; }
    .comment-delete {
      background: transparent; border: none; color: var(--danger);
      cursor: pointer; padding: 6px 8px; border-radius: var(--radius-sm);
    }
    .comment-delete:hover { background: rgba(255, 107, 107, .12); }

    /* Add comment at TOP */
    .comment-add {
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display: flex; gap: 10px; align-items: flex-end;
      background: var(--panel);
      border-top-left-radius: var(--radius-md);
      border-top-right-radius: var(--radius-md);
    }
    .comment-input {
      flex: 1 1 auto;
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--input-border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      min-width: 0;
      min-height: 44px;
      max-height: 240px;
      resize: vertical;
      line-height: 1.45;
      font: inherit;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: break-word;
      overflow-y: auto;
      transition: border-color var(--transition), box-shadow var(--transition), background-color var(--transition);
    }
    .comment-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
      background: var(--input-focus);
    }
    .comment-submit {
      background: var(--accent); color: #0f0f0f;
      border: 1px solid var(--accent);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-weight: 700; cursor: pointer;
      transition: background-color .15s ease, box-shadow var(--transition), transform .06s ease, border-color var(--transition);
    }
    .comment-submit:hover {
      background: var(--accent-strong);
      border-color: var(--accent-strong);
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    .comment-submit:active { transform: translateY(1px); }

    .comments-toggle {
      margin-top: 12px;
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background .15s ease, color .15s ease, box-shadow var(--transition);
    }
    .comments-toggle:hover {
      background: var(--accent);
      color: #0f0f0f;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }

    @media (max-width: 520px) {
      .post-meta { display: none; }
      .post-top { gap: 8px; }
    }
  </style>
</head>

<body>
  {% include 'base_nav.html' %}

  <div class="container">
    <h2>Community Posts</h2>

    {% if posts | length == 0 %}
      <p>No posts yet â€” be the first to <a href="{{ url_for('posts_new') }}">create one</a>!</p>
    {% endif %}

    <div class="posts-wrap">
      {% for p in posts %}
      <article class="post-card" data-post-id="{{ p['id'] }}">
        <div class="post-top">
          <strong class="post-title">{{ p['title'] }}</strong>

          <small class="post-meta">{{ p['created_at'][:19].replace('T',' ') }}</small>

          {% if user and (user['id'] == p['owner_id'] or user_is_admin) %}
          <div class="kebab-wrap" data-post-id="{{ p['id'] }}">
            <button class="kebab-btn" aria-haspopup="true" aria-expanded="false" aria-label="Post menu">
              <span class="kebab-dot"></span>
              <span class="kebab-dot"></span>
              <span class="kebab-dot"></span>
            </button>
            <div class="kebab-menu" role="menu" aria-label="Post actions">
              <a class="kebab-item" href="{{ url_for('posts_edit', post_id=p['id']) }}">âœŽ Edit</a>
              <form method="post" action="{{ url_for('posts_delete', post_id=p['id']) }}"
                    onsubmit="return confirm('Delete this post?');">
                <button type="submit" class="kebab-item kebab-danger">ðŸ—‘ Delete</button>
              </form>
            </div>
          </div>
          {% endif %}
        </div>

        <div class="post-header-sub">
          <em class="post-author">by {{ p['username'] }}</em>
          <div></div>
        </div>

        {% if p['image_filename'] %}
        <div class="post-image">
          <img src="{{ url_for('uploaded_file', filename=p['image_filename']) }}" alt="post image">
        </div>
        {% endif %}

        <div class="post-body">{{ p['body'] }}</div>

        <!-- Toggle -->
        <button class="comments-toggle" data-state="closed">Show comments</button>

        <!-- Comments -->
        <div class="comments" id="comments-{{ p['id'] }}">
          <div class="comments-header">
            <div class="comments-count" id="comments-count-{{ p['id'] }}">0 comments</div>
            <div></div>
          </div>

          {% if user %}
          <div class="comment-add">
            <textarea class="comment-input" id="comment-input-{{ p['id'] }}" placeholder="Add a commentâ€¦" rows="1"></textarea>
            <button class="comment-submit" data-post-id="{{ p['id'] }}">Comment</button>
          </div>
          {% else %}
          <div class="comment-add" style="justify-content:center;">
            <em style="color:var(--muted);">Log in to add a comment</em>
          </div>
          {% endif %}

          <ul class="comment-list" id="comment-list-{{ p['id'] }}"></ul>
        </div>
      </article>
      {% endfor %}
    </div>
  </div>

  <script>
    // --- kebab dropdown (post actions) ---
    (function () {
      const wraps = document.querySelectorAll('.kebab-wrap');
      function closeAll(except = null) {
        document.querySelectorAll('.kebab-menu.open').forEach(m => {
          if (!except || m !== except) {
            m.classList.remove('open');
            const btn = m.parentElement.querySelector('.kebab-btn');
            if (btn) btn.setAttribute('aria-expanded', 'false');
          }
        });
      }
      wraps.forEach(wrap => {
        const btn = wrap.querySelector('.kebab-btn');
        const menu = wrap.querySelector('.kebab-menu');
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.contains('open');
          closeAll();
          if (!isOpen) {
            menu.classList.add('open');
            btn.setAttribute('aria-expanded', 'true');
          }
        });
        menu.addEventListener('click', (e) => e.stopPropagation());
      });
      document.addEventListener('click', () => closeAll());
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAll(); });
    })();

    // --- helpers ---
    function autoGrow(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 240) + 'px';
    }
    function fmtTime(iso) {
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    }

    // Render single comment
    function renderCommentLi(c) {
      const li = document.createElement('li');
      li.className = 'comment';
      li.dataset.commentId = c.id;

      const initials = (c.username || '?').slice(0, 1).toUpperCase();

      li.innerHTML = `
        <div class="comment-avatar">${initials}</div>
        <div class="comment-main">
          <div class="comment-top">
            <span class="comment-user"></span>
            <span class="comment-time"></span>
          </div>
          <div class="comment-body"></div>
        </div>
        <div class="comment-actions"></div>
      `;

      li.querySelector('.comment-user').textContent = c.username;
      li.querySelector('.comment-time').textContent = 'â€¢ ' + fmtTime(c.created_at);
      li.querySelector('.comment-body').textContent = c.body || '';

      if (c.can_delete) {
        const del = document.createElement('button');
        del.className = 'comment-delete';
        del.textContent = 'Delete';
        del.addEventListener('click', async () => {
          if (!confirm('Delete this comment?')) return;
          try {
            const res = await fetch(`/comments/${c.id}/delete`, { method: 'POST' });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Failed');
            li.remove();
            const countEl = document.getElementById(`comments-count-${c.post_id}`);
            if (countEl) {
              const current = Math.max((parseInt(countEl.dataset.count || '1', 10) - 1), 0);
              countEl.dataset.count = String(current);
              countEl.textContent = `${current} comment${current === 1 ? '' : 's'}`;
            }
          } catch (e) {
            alert(e.message || 'Failed to delete.');
          }
        });
        li.querySelector('.comment-actions').appendChild(del);
      }

      return li;
    }

    async function loadComments(postId) {
      const listEl = document.getElementById(`comment-list-${postId}`);
      const countEl = document.getElementById(`comments-count-${postId}`);
      listEl.innerHTML = `<li class="comment" style="justify-content:center;"><em style="color:var(--muted);">Loading...</em></li>`;
      try {
        const res = await fetch(`/comments/list?post_id=${postId}`);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Error');
        listEl.innerHTML = '';
        data.comments.forEach(c => listEl.appendChild(renderCommentLi(c)));
        countEl.dataset.count = String(data.count);
        countEl.textContent = `${data.count} comment${data.count === 1 ? '' : 's'}`;
      } catch (e) {
        listEl.innerHTML = `<li class="comment" style="justify-content:center;"><em style="color:#ff9f9f;">Failed to load comments</em></li>`;
      }
    }

    async function addComment(postId, bodyEl) {
      const body = bodyEl.value.trim();
      if (!body) return;

      const btn = bodyEl.nextElementSibling;
      const originalText = btn.textContent;
      btn.disabled = true; btn.textContent = 'Postingâ€¦';

      try {
        const res = await fetch('/comments/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ post_id: postId, body })
        });
        const data = await res.json();
        if (!data.ok) {
          alert(data.error || 'Failed to post.');
          return;
        }

        const listEl = document.getElementById(`comment-list-${postId}`);
        listEl.insertBefore(renderCommentLi(data.comment), listEl.firstChild);

        const countEl = document.getElementById(`comments-count-${postId}`);
        const current = (parseInt(countEl.dataset.count || '0', 10) + 1);
        countEl.dataset.count = String(current);
        countEl.textContent = `${current} comment${current === 1 ? '' : 's'}`;

        bodyEl.value = '';
        autoGrow(bodyEl);
      } catch (e) {
        alert('Network error.');
      } finally {
        btn.disabled = false; btn.textContent = originalText;
      }
    }

    // Attach UI behavior per post
    document.querySelectorAll('.post-card').forEach(card => {
      const postId = parseInt(card.dataset.postId, 10);
      const toggleBtn = card.querySelector('.comments-toggle');
      const commentsBox = card.querySelector('.comments');
      const submitBtn = card.querySelector('.comment-submit');
      const inputEl = card.querySelector('.comment-input');

      // Toggle comments + lazy load
      toggleBtn.addEventListener('click', async () => {
        const open = toggleBtn.dataset.state === 'open';
        if (open) {
          commentsBox.classList.remove('open');
          toggleBtn.dataset.state = 'closed';
          toggleBtn.textContent = 'Show comments';
        } else {
          commentsBox.classList.add('open');
          toggleBtn.dataset.state = 'open';
          toggleBtn.textContent = 'Hide comments';
          const listEl = document.getElementById(`comment-list-${postId}`);
          if (!listEl.dataset.loaded) {
            await loadComments(postId);
            listEl.dataset.loaded = '1';
          }
          if (inputEl) autoGrow(inputEl);
        }
      });

      if (inputEl) {
        inputEl.addEventListener('input', () => autoGrow(inputEl));
        inputEl.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            addComment(postId, inputEl);
          }
        });
      }
      if (submitBtn && inputEl) {
        submitBtn.addEventListener('click', () => addComment(postId, inputEl));
      }
    });
  </script>
</body>
</html>
