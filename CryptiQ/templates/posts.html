<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Posts — The Cipher Lab</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
      margin: 0;
    }

    .posts-container {
      width: min(960px, 94%);
      margin: 25px auto 80px;
      display: flex;
      flex-direction: column;
      gap: 26px;
      padding: 0 8px;
    }

    .posts-header {
      text-align: center;
      margin-bottom: 12px;
    }

    .posts-header h2 {
      font-size: clamp(1.6rem, 4vw, 2rem);
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .posts-header p {
      color: var(--muted);
      font-size: clamp(0.9rem, 2vw, 1rem);
      margin-top: 6px;
    }

    /* === Sort pills (New / Top / Hot) === */
    .posts-sort {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .sort-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.02);
      color: var(--muted);
      font-size: 0.86rem;
      text-decoration: none;
      cursor: pointer;
      font-weight: 500;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .sort-pill:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .sort-pill.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #0f0f0f;
      font-weight: 700;
    }

    .post-card {
      position: relative;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 20px 22px;
      box-shadow: 0 6px 20px rgba(0,0,0,.22);
      backdrop-filter: blur(6px);
      transition: transform .16s ease, box-shadow .2s ease;
      word-break: break-word;
    }

    .post-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(0,0,0,.28);
    }

    .post-card.pinned {
      border: 1px solid var(--accent);
    }

    .pinned-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--accent);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(0,255,213,0.15);
    }

    .post-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }

    .post-title {
      font-size: clamp(1.1rem, 3vw, 1.25rem);
      font-weight: 700;
      color: var(--text);
    }

    .post-author {
      color: var(--text-dim);
      font-size: .95rem;
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    

    .banned-badge {
      background: #ff6b6b;
      color: #0f0f0f;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 6px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .post-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .post-meta {
      font-size: .85rem;
      color: var(--muted);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .post-menu {
      position: relative;
    }

    .kebab-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      line-height: 1;
      padding: 4px 6px;
      transition: color .2s ease;
    }

    .kebab-btn:hover { color: var(--text-dim); }

    .menu {
      position: absolute;
      top: 26px;
      right: 0;
      min-width: 140px;
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 10px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      padding: 6px;
      display: none;
      z-index: 20;
    }

    .menu.open { display: block; }

    .menu a,
    .menu button {
      display: block;
      width: 100%;
      text-align: left;
      background: transparent;
      border: 0;
      color: var(--text);
      padding: 8px 10px;
      border-radius: 8px;
      font: inherit;
      cursor: pointer;
      text-decoration: none;
      transition: background .15s;
    }

    .menu a:hover,
    .menu button:hover { background: var(--input-hover); }

    .menu .danger { color: #ff6b6b; }

    .menu .ban-user {
      color: #ff7070;
    }

    .menu .ban-user:hover {
      background: #ff7070;
      color: #0f0f0f;
    }

    .post-body {
      margin-top: 10px;
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px 14px;
      color: var(--text);
      line-height: 1.55;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* --- Auto-collapse long bodies --- */
    .post-body.collapsed {
      max-height: 160px;
      overflow: hidden;
      position: relative;
    }

    .post-body.collapsed::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: linear-gradient(to bottom, transparent, var(--panel-2));
    }

    .show-more-btn {
      margin-top: 8px;
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background .15s, color .15s;
    }

    .show-more-btn:hover {
      background: var(--accent);
      color: #0f0f0f;
    }

    /* ==========================
       Post image wrap (cover crop)
    =========================== */
    .post-image-wrap {
      width: 100%;
      aspect-ratio: 16 / 9;
      overflow: hidden;
      border-radius: 10px;
      background: var(--panel-2);
      margin-top: 10px;
    }

    .post-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 0;
      max-height: none;
    }

    /* Comments */
    .comments {
      margin-top: 16px;
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-5px);
      transition: max-height .4s ease, opacity .35s ease, transform .35s ease;
    }

    .comments.open {
      opacity: 1;
      transform: translateY(0);
      max-height: 1000px;
    }

    .comments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
    }

    .comments-count { font-weight: 600; color: var(--accent); }

    .comment-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .comment {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
    }

    .comment:last-child { border-bottom: none; }

    .comment-avatar {
      flex: 0 0 34px;
      height: 34px;
      border-radius: 999px;
      background: var(--input-bg);
      border: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--accent);
      font-size: 0.9rem;
      text-transform: uppercase;
    }

    .comment-main {
      flex: 1 1 auto;
      min-width: 0;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
    }

    .comment-user {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text);
    }

    .comment-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.78rem;
      color: var(--muted);
      flex-shrink: 0;
    }

    .comment-time {
      opacity: 0.9;
    }

    .comment-delete {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .comment-delete:hover {
      background: rgba(255, 107, 107, 0.12);
      color: #ff8b8b;
    }

    .comment-body {
      margin-top: 2px;
      color: var(--text);
      line-height: 1.5;
      word-break: break-word;
      font-size: 0.9rem;
    }

    .comment-add {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
      background: var(--panel);
      flex-wrap: wrap;
    }

    .comment-input {
      flex: 1;
      border: 1px solid var(--input-border);
      border-radius: 999px;
      background: var(--input-bg);
      color: var(--text);
      padding: 9px 14px;
      min-height: 40px;
      resize: vertical;
      font: inherit;
    }

    .comment-submit {
      background: var(--accent);
      color: #0f0f0f;
      font-weight: 700;
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: transform .08s, box-shadow .12s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      white-space: nowrap;
    }

    .comment-submit:hover { transform: translateY(-1px); }

    .comments-toggle {
      margin-top: 12px;
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: background .15s, color .15s;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
    }

    .comments-toggle:hover { background: var(--accent); color: #0f0f0f; }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 22px;
      font-size: 0.95rem;
    }

    .page-btn {
      background: var(--accent);
      color: #0f0f0f;
      padding: 8px 14px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      transition: background 0.2s ease;
    }

    .page-btn:hover { background: var(--accent-strong, #00e6c0); }

    .pagination span { color: var(--text-dim); }

    /* FAB */
    .fab {
      position: fixed;
      bottom: 30px;
      right: 28px;
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--line-2);
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      cursor: pointer;
      z-index: 2500;
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
      transition: transform .12s ease, box-shadow .15s ease;
    }

    .fab span { font-size: 1.8rem; font-weight: 500; }

    .fab:hover { transform: translateY(-2px); }

    @media (max-width: 700px) {
      .posts-container { margin: 85px auto 60px; gap: 22px; }
      .post-card { padding: 16px 14px; border-radius: 12px; }
      .fab { bottom: 20px; right: 20px; width: 48px; height: 48px; }
      .pagination { flex-wrap: wrap; gap: 8px; }
      .page-btn { padding: 8px 12px; font-size: 0.9rem; }

      .comment { padding: 8px 10px; }
    }

    /* === Search Bar (Google-style) === */
    .posts-search {
      position: relative;
      width: min(620px, 90%);
      margin: 0 auto 14px;
    }

    .posts-search input {
      width: 100%;
      padding: 14px 48px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--panel);
      color: var(--text);
      font-size: 1rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.15);
      transition: box-shadow .2s, border-color .2s, background .2s;
    }

    .posts-search input::placeholder { color: var(--muted); }

    .posts-search input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--input-focus);
      box-shadow: 0 0 0 3px var(--accent-soft), 0 4px 18px rgba(0,0,0,0.30);
    }

    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.65;
      pointer-events: none;
      color: var(--muted);
    }

    .search-suggestions {
      position: absolute;
      top: 48px;
      left: 0;
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.35);
      max-height: 260px;
      overflow-y: auto;
      display: none;
      z-index: 2000;
    }

    .search-suggestions.open { display: block; }

    .suggestion-item {
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
      transition: background .15s;
    }

    .suggestion-item:last-child { border-bottom: none; }

    .suggestion-item:hover { background: var(--input-hover); }

    .suggestion-title {
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .suggestion-snippet {
      font-size: 0.85rem;
      color: var(--muted);
    }

    /* Glow highlight */
    @keyframes postGlow {
      0% { box-shadow: 0 0 0 rgba(0,255,213,0); border-color: var(--accent); }
      50% { box-shadow: 0 0 20px rgba(0,255,213,0.55); border-color: var(--accent); }
      100% { box-shadow: 0 0 0 rgba(0,255,213,0); border-color: var(--line); }
    }
    .post-glow { animation: postGlow 1.1s ease-out; }

    /* =============================
       HEART / UPVOTE
    ============================== */
    .heart-anchor { display: block; }

    .heart-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--muted);
      position: absolute;
      bottom: 12px;
      right: 16px;
      z-index: 5;
    }

    .heart-box {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.06);
      position: relative;
    }

    .heart-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
    }

    .heart-icon {
      width: 18px;
      height: 18px;
      fill: transparent;
      stroke: var(--muted);
      stroke-width: 1.8;
      transition: fill 0.18s ease-out, stroke 0.18s ease-out, transform 0.12s ease-out;
      transform-origin: center;
    }

    .heart-btn:hover .heart-icon { stroke: var(--accent); }

    .heart-btn.active-heart .heart-icon {
      fill: var(--accent-strong);
      stroke: var(--accent);
      transform: scale(1.08);
    }

    @keyframes heartPop {
      0%   { transform: scale(0.85); }
      45%  { transform: scale(1.22); }
      100% { transform: scale(1.0); }
    }

    .heart-pop .heart-icon { animation: heartPop 0.26s ease-out; }
    .heart-unpop .heart-icon { animation: heartPop 0.20s ease-out reverse; }

    .heart-count {
      min-width: 16px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .heart-pulse-ring {
      position: absolute;
      inset: -2px;
      border-radius: 999px;
      border: 1px solid rgba(0,255,213,0.0);
      pointer-events: none;
    }

    @keyframes pulseRing {
      0% {
        transform: scale(0.9);
        border-color: rgba(0,255,213,0.45);
        opacity: 1;
      }
      100% {
        transform: scale(1.25);
        border-color: rgba(0,255,213,0);
        opacity: 0;
      }
    }

    .heart-box.pulse .heart-pulse-ring { animation: pulseRing 0.42s ease-out; }

    /* ✅ When comments are open: move heart next to toggle (inline) */
    .post-card.comments-open .heart-row {
      position: static;
      bottom: auto;
      right: auto;
      margin-top: 0;
    }

    .post-card.comments-open .comments-toggle + .heart-row{
      display: inline-flex;
      margin-left: 10px;
      vertical-align: middle;
    }

    /* ============================================================
       DELETE POPUP (Global)
    ============================================================ */
    .delete-popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5000;
      animation: fadeIn .15s ease-out;
    }

    .delete-popup-overlay.open { display: flex; }

    .delete-popup-box {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 22px 26px;
      width: min(350px, 88%);
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
      animation: popIn .18s ease-out;
      text-align: center;
    }

    .delete-popup-box h3 {
      margin: 0 0 8px;
      color: var(--text);
      font-size: 1.2rem;
    }

    .delete-popup-box p {
      color: var(--muted);
      margin-bottom: 18px;
    }

    .delete-popup-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    #delete-popup-cancel,
    #delete-popup-confirm {
      padding: 8px 14px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-size: 0.92rem;
    }

    #delete-popup-cancel {
      background: var(--panel-2);
      color: var(--text);
    }

    #delete-popup-cancel:hover { background: var(--input-hover); }

    #delete-popup-confirm {
      background: #ff6b6b;
      color: #0f0f0f;
    }

    #delete-popup-confirm:hover { background: #ff7f7f; }

    @keyframes popIn {
      from { transform: scale(.87); opacity: 0; }
      to   { transform: scale(1); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .post-titles { padding-bottom: 2vh; }
  </style>
</head>

<body>
  {% include 'base_nav.html' %}

  <main class="posts-container">
    <div class="posts-header">
      <h2 class="post-titles">Community Posts</h2>

      <div class="posts-search">
        <input type="text" id="post-search-input" placeholder="Search posts..." autocomplete="off">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <div class="search-suggestions" id="search-suggestions"></div>
      </div>

      <div id="no-results" style="
        display:none;
        text-align:center;
        margin-top:4px;
        color:var(--muted);
        font-size:0.95rem;
      ">
        No results found.
      </div>

      <div class="posts-sort">
        <a href="{{ url_for('posts_list', sort='new') }}" class="sort-pill {% if sort == 'new' %}active{% endif %}">New</a>
        <a href="{{ url_for('posts_list', sort='top') }}" class="sort-pill {% if sort == 'top' %}active{% endif %}">Top</a>
        <a href="{{ url_for('posts_list', sort='hot') }}" class="sort-pill {% if sort == 'hot' %}active{% endif %}">Hot</a>
      </div>

      <p>Share your ciphers, solver tips, and cryptic insights with others.</p>
    </div>

    {% if posts|length == 0 %}
      <p style="text-align:center;">
        No posts yet — be the first to
        <a href="{{ url_for('posts_new') }}" style="color:var(--accent);">create one</a>!
      </p>
    {% endif %}

    {% for p in posts %}
    <article id="post-{{ p.id }}" class="post-card {% if p.pinned %}pinned{% endif %}" data-post-id="{{ p.id }}">
      <div class="post-top">
        <div>
          <div class="post-title">{{ p.title }}</div>
          <div class="post-author">
            by {{ p.username or '[Deleted User]' }}
            {% if p.is_admin %}<span class="admin-badge">Admin</span>{% endif %}
            {% if p.is_pro %}
  <span class="pro-badge">PRO</span>
{% endif %}
            {% if p.banned %}<span class="banned-badge">BANNED</span>{% endif %}
          </div>
        </div>

        <div class="post-right">
          <div class="post-meta">
            {% if p.pinned %}
              <span class="pinned-badge" title="Pinned post">
                <img src="{{ url_for('static', filename='assets/pin.svg') }}" alt="Pinned"
                  style="width:14px;height:14px;vertical-align:-2px;filter:invert(63%) sepia(95%) saturate(500%) hue-rotate(125deg) brightness(102%) contrast(101%);">
                Pinned
              </span>
            {% endif %}
            <span>{{ p.created_at[:19].replace('T',' ') }}</span>
          </div>

          {% if user and (user.id == p.owner_id or user_is_admin) %}
          <div class="post-menu">
            <button class="kebab-btn" title="Options">⋯</button>
            <div class="menu">
              {% if user_is_admin %}
                <button class="toggle-pin" data-id="{{ p.id }}" data-state="{{ 1 if p.pinned else 0 }}">
                  {% if p.pinned %}Unpin{% else %}Pin{% endif %}
                </button>
                <button class="ban-user" data-username="{{ p.username }}" data-banned="{{ 1 if p.banned else 0 }}">
                  {% if p.banned %}Unban user{% else %}Ban user{% endif %}
                </button>
              {% endif %}
              <a href="{{ url_for('posts_edit', post_id=p.id) }}">Edit</a>
              <form method="post" action="{{ url_for('posts_delete', post_id=p.id) }}">
                <button type="submit" class="danger">Delete</button>
              </form>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      {% if p.image_filename %}
      <div class="post-image-wrap">
        <img class="post-image" src="{{ url_for('uploaded_file', filename=p.image_filename) }}" alt="Post image">
      </div>
      {% endif %}

      <div class="post-body">{{ p.body }}</div>

      <!-- anchor so we can snap the upvote back to bottom-right -->
      <div class="heart-anchor"></div>

      <!-- Hearts row -->
      <div class="heart-row">
        <div class="heart-box" data-post-id="{{ p.id }}">
          <span class="heart-pulse-ring"></span>
          <button class="heart-btn {% if p.viewer_hearted %}active-heart{% endif %}"
                  type="button"
                  aria-label="Heart this post"
                  aria-pressed="{% if p.viewer_hearted %}true{% else %}false{% endif %}">
            <svg class="heart-icon" viewBox="0 0 24 24">
              <path d="M12 4 L18 12 H14 V20 H10 V12 H6 Z"/>
            </svg>
          </button>
          <span class="heart-count" id="heart-count-{{ p.id }}">{{ p.upvotes or 0 }}</span>
        </div>
      </div>

      <button class="comments-toggle" data-state="closed" id="comments-toggle-{{ p.id }}">
        Show comments (<span id="comments-num-{{ p.id }}">0</span>)
      </button>

      <div class="comments" id="comments-{{ p.id }}">
        <div class="comments-header">
          <div class="comments-count" id="comments-count-{{ p.id }}">0 comments</div>
        </div>

        {% if user %}
        <div class="comment-add">
          <textarea class="comment-input" id="comment-input-{{ p.id }}" placeholder="Add a comment…" rows="1"></textarea>
          <button class="comment-submit" data-post-id="{{ p.id }}">Post</button>
        </div>
        {% else %}
        <div class="comment-add" style="justify-content:center;">
          <em style="color:var(--muted);">
            <a href="{{ url_for('login') }}" style="color:var(--accent); text-decoration:none; font-weight:600;">Log in</a>
            to comment
          </em>
        </div>
        {% endif %}

        <ul class="comment-list" id="comment-list-{{ p.id }}"></ul>
      </div>
    </article>
    {% endfor %}

    {% if total_pages > 1 %}
    <div class="pagination">
      {% if page > 1 %}
        <a href="{{ url_for('posts_list', page=page-1, sort=sort) }}" class="page-btn">‹ Prev</a>
      {% endif %}
      <span>Page {{ page }} of {{ total_pages }}</span>
      {% if page < total_pages %}
        <a href="{{ url_for('posts_list', page=page+1, sort=sort) }}" class="page-btn">Next ›</a>
      {% endif %}
    </div>
    {% endif %}

    <a href="{% if user %}{{ url_for('posts_new') }}{% else %}{{ url_for('login') }}{% endif %}"
      class="fab" title="{% if user %}Create a new post{% else %}Log in to post{% endif %}">
      <span>＋</span>
    </a>

    <!-- Delete Confirmation Popup -->
    <div id="delete-popup" class="delete-popup-overlay">
      <div class="delete-popup-box">
        <h3>Confirm Delete</h3>
        <p id="delete-popup-text">Are you sure you want to delete this?</p>

        <div class="delete-popup-actions">
          <button id="delete-popup-cancel">Cancel</button>
          <button id="delete-popup-confirm">Delete</button>
        </div>
      </div>
    </div>

    <!-- Login Required Popup -->
    <div id="login-popup" class="delete-popup-overlay">
      <div class="delete-popup-box">
        <h3>Login Required</h3>
        <p>
          <a href="{{ url_for('login') }}" style="color:var(--accent);font-weight:700;">Log in</a>
          to upvote posts.
        </p>

        <div class="delete-popup-actions">
          <a href="{{ url_for('login') }}" id="login-popup-login"
             style="padding:8px 14px;border-radius:8px;background:var(--accent);color:#0f0f0f;font-weight:700;text-decoration:none;">
            Log in
          </a>
          <button id="login-popup-close"
                  style="padding:8px 14px;border-radius:8px;background:var(--panel-2);color:var(--text);font-weight:600;">
            Close
          </button>
        </div>
      </div>
    </div>
              {% include "base_footer.html" %}

  </main>

<script>
/* ============================================================
   Collapse Long Post Bodies
============================================================ */
function setupPostBodyCollapsing(root = document) {
  root.querySelectorAll(".post-body").forEach(body => {
    if (body.dataset.collapseInit === "1") return;

    if (body.textContent.trim().length > 350) {
      body.dataset.collapseInit = "1";
      body.classList.add("collapsed");

      const btn = document.createElement("button");
      btn.className = "show-more-btn";
      btn.textContent = "Show more";

      btn.addEventListener("click", () => {
        const c = body.classList.toggle("collapsed");
        btn.textContent = c ? "Show more" : "Show less";
      });

      body.insertAdjacentElement("afterend", btn);
    }
  });
}
document.addEventListener("DOMContentLoaded", () => setupPostBodyCollapsing());

/* ============================================================
   Kebab Menu Toggle (delegated)
============================================================ */
document.addEventListener("click", e => {
  const btn = e.target.closest(".kebab-btn");
  const all = document.querySelectorAll(".menu");

  if (btn) {
    const menu = btn.nextElementSibling;
    const open = menu.classList.contains("open");
    all.forEach(m => m.classList.remove("open"));
    if (!open) menu.classList.add("open");
  } else {
    all.forEach(m => m.classList.remove("open"));
  }
});

/* ============================================================
   COMMENT UTIL FUNCTIONS
============================================================ */
function escapeHtml(str) {
  return (str || "").replace(/[&<>"']/g, s =>
    ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s])
  );
}

function formatCommentTime(ts) {
  const d = new Date(ts);
  if (isNaN(d)) return ts;
  return d.toLocaleString("en-GB", {
    day: "2-digit",
    month: "short",
    hour: "2-digit",
    minute: "2-digit",
  }).replace(",", "");
}

function renderComment(c) {
  const li = document.createElement("li");
  li.className = "comment";
  li.dataset.commentId = c.id;

  const initial = (c.username || "?")[0].toUpperCase();
  const time = formatCommentTime(c.created_at);

  li.innerHTML = `
    <div class="comment-avatar">${initial}</div>
    <div class="comment-main">
      <div class="comment-header">
        <div class="comment-user">${escapeHtml(c.username || "[Deleted]")}</div>
        <div class="comment-meta">
          <span class="comment-time">${time}</span>
          ${c.can_delete ? `<button class="comment-delete" data-id="${c.id}">Delete</button>` : ""}
        </div>
      </div>
      <div class="comment-body">${escapeHtml(c.body)}</div>
    </div>
  `;
  return li;
}

/* ============================================================
   LOAD COMMENTS
============================================================ */
async function loadComments(postId) {
  const list = document.getElementById(`comment-list-${postId}`);
  const count = document.getElementById(`comments-count-${postId}`);
  const numSpan = document.getElementById(`comments-num-${postId}`);

  list.innerHTML = `<li class="comment"><em style="color:var(--muted);">Loading…</em></li>`;

  try {
    const res = await fetch(`/comments/list?post_id=${postId}`);
    const data = await res.json();

    list.innerHTML = "";
    data.comments.forEach(c => list.appendChild(renderComment(c)));

    count.textContent = `${data.count} comment${data.count !== 1 ? "s" : ""}`;
    if (numSpan) numSpan.textContent = data.count;
  } catch {
    list.innerHTML = `<li><em style="color:#ff9f9f;">Failed to load comments.</em></li>`;
  }
}

/* ============================================================
   COMMENTS (toggle, post)
   ✅ (delete is handled ONLY by popup handler at bottom)
============================================================ */
document.addEventListener("click", async e => {
  /* Toggle */
  const toggle = e.target.closest(".comments-toggle");
  if (toggle) {
    const card = toggle.closest(".post-card");
    const id = card.dataset.postId;
    const box = document.getElementById(`comments-${id}`);
    const num = document.getElementById(`comments-num-${id}`).textContent;
    const open = toggle.dataset.state === "open";

    // move upvote next to toggle when open
    const heartRow = card.querySelector(".heart-row");
    const anchor = card.querySelector(".heart-anchor");

    if (open) {
      toggle.dataset.state = "closed";
      box.classList.remove("open");
      card.classList.remove("comments-open");

      // snap back near anchor (absolute bottom-right again)
      if (anchor && heartRow) anchor.insertAdjacentElement("afterend", heartRow);

      toggle.innerHTML = `Show comments (<span id="comments-num-${id}">${num}</span>)`;
    } else {
      toggle.dataset.state = "open";
      box.classList.add("open");
      card.classList.add("comments-open");

      // move heart beside toggle
      if (heartRow) toggle.insertAdjacentElement("afterend", heartRow);

      toggle.innerHTML = `Hide comments (<span id="comments-num-${id}">${num}</span>)`;
      await loadComments(id);
    }
    return;
  }

  /* Post comment */
  const postBtn = e.target.closest(".comment-submit");
  if (postBtn) {
    const id = postBtn.dataset.postId;
    const input = document.getElementById(`comment-input-${id}`);
    const body = input.value.trim();
    if (!body) return;

    postBtn.disabled = true;
    const old = postBtn.textContent;
    postBtn.textContent = "Posting…";

    try {
      const res = await fetch("/comments/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ post_id: Number(id), body })
      });
      const data = await res.json();

      if (data.ok) {
        const list = document.getElementById(`comment-list-${id}`);
        list.prepend(renderComment(data.comment));
        input.value = "";
      }
    } catch {}

    postBtn.disabled = false;
    postBtn.textContent = old;
  }

  /* Delete comment: do nothing here (popup handler handles it) */
  const delBtn = e.target.closest(".comment-delete");
  if (delBtn) return;
});

/* ============================================================
   Ban / Unban + Pin / Unpin
============================================================ */
document.addEventListener("click", async e => {
  const ban = e.target.closest(".ban-user");
  if (ban) {
    const u = ban.dataset.username;
    const b = ban.dataset.banned === "1";
    if (!confirm(b ? `Unban ${u}?` : `Ban ${u}?`)) return;
    await fetch("/admin/ban_user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: u, banned: !b })
    });
    location.reload();
  }

  const pin = e.target.closest(".toggle-pin");
  if (pin) {
    const id = pin.dataset.id;
    await fetch(`/posts/${id}/pin`, { method: "POST" });
    location.reload();
  }
});

/* ============================================================
   Glow on hash navigation
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  const h = window.location.hash;
  if (h.startsWith("#post-")) {
    const el = document.querySelector(h);
    if (el) {
      el.scrollIntoView({ behavior: "smooth", block: "center" });
      el.classList.add("post-glow");
      setTimeout(() => el.classList.remove("post-glow"), 1200);
    }
  }
});

/* ============================================================
   Load Comment Counts
============================================================ */
async function loadAllCommentCounts(root = document) {
  const toggles = root.querySelectorAll(".comments-toggle");

  for (const t of toggles) {
    const card = t.closest(".post-card");
    const id = card.dataset.postId;

    try {
      const res = await fetch(`/comments/count?post_id=${id}`);
      const data = await res.json();
      const n = data.count;

      const num = document.getElementById(`comments-num-${id}`);
      const c = document.getElementById(`comments-count-${id}`);
      if (num) num.textContent = n;
      if (c) c.textContent = `${n} comment${n !== 1 ? "s" : ""}`;
    } catch {}
  }
}
document.addEventListener("DOMContentLoaded", () => loadAllCommentCounts());

/* ============================================================
   HEART SYSTEM — Animated CSS Single-SVG
   + Login popup when logged out
============================================================ */
document.addEventListener("click", async e => {
  const btn = e.target.closest(".heart-btn");
  if (!btn) return;

  if (!{{ 'true' if user else 'false' }}) {
    const lp = document.getElementById("login-popup");
    if (lp) lp.classList.add("open");
    return;
  }

  const box = btn.closest(".heart-box");
  const postId = box.dataset.postId;

  try {
    const res = await fetch(`/posts/${postId}/vote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ vote: 1 })
    });

    const data = await res.json();
    if (!data.ok) return;

    const countEl = document.getElementById(`heart-count-${postId}`);
    if (countEl) countEl.textContent = data.hearts;

    btn.classList.remove("heart-pop", "heart-unpop");
    box.classList.remove("pulse");
    void btn.offsetWidth;

    if (data.hearted) {
      btn.classList.add("active-heart", "heart-pop");
      btn.setAttribute("aria-pressed", "true");
      box.classList.add("pulse");
    } else {
      btn.classList.remove("active-heart");
      btn.classList.add("heart-unpop");
      btn.setAttribute("aria-pressed", "false");
    }
  } catch (err) {
    console.error("Heart error:", err);
  }
});

/* ============================================================
   Levenshtein
============================================================ */
function levenshtein(a, b) {
  const la = a.length, lb = b.length;
  if (!la) return lb;
  if (!lb) return la;

  const dp = Array.from({ length: lb + 1 }, () => Array(la + 1).fill(0));
  for (let i = 0; i <= lb; i++) dp[i][0] = i;
  for (let j = 0; j <= la; j++) dp[0][j] = j;

  for (let i = 1; i <= lb; i++) {
    for (let j = 1; j <= la; j++) {
      const cost = a[j - 1] === b[i - 1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + cost
      );
    }
  }
  return dp[lb][la];
}

/* ============================================================
   SCORING MODEL — TITLE STRONG, NO PIN BIAS
============================================================ */
function scoredPost(p, rawQuery) {
  const q = rawQuery.trim().toLowerCase();
  if (!q) return 0;

  const title = (p.title || "").toLowerCase();
  const body  = (p.body  || "").toLowerCase();
  const qWords = q.split(/\s+/).filter(Boolean);

  let score = 0;

  if (title === q) return 10_000_000;

  if (title.startsWith(q)) score += 5_000_000;
  if (title.includes(q))   score += 3_000_000;

  const dt = levenshtein(title, q);
  if (dt === 1) score += 1_000_000;
  if (dt === 2) score += 500_000;

  const tWords = title.split(/\W+/).filter(Boolean);
  const bWords = body.split(/\W+/).filter(Boolean);

  for (const qw of qWords) {
    if (qw.length <= 1) continue;

    for (const tw of tWords) {
      if (tw === qw) score += 50_000;
      else if (tw.startsWith(qw)) score += 20_000;
      else if (tw.includes(qw)) score += 10_000;
      else {
        const d = levenshtein(tw, qw);
        if (d === 1) score += 5_000;
        if (d === 2) score += 2_000;
      }
    }

    for (const bw of bWords) {
      if (bw === qw) score += 400;
      else if (bw.startsWith(qw)) score += 180;
      else if (bw.includes(qw)) score += 120;
      else {
        const d = levenshtein(bw, qw);
        if (d === 1) score += 30;
        if (d === 2) score += 10;
      }
    }
  }

  return score;
}

/* ============================================================
   RENDER POST (for search results)
   NOTE: mirrors server HTML + includes heart-anchor
============================================================ */
function renderPostHTML(p, isAdmin, isLogged) {
  const created = (p.created_at || "").replace("T", " ").slice(0,19);
  const hearts = p.upvotes || 0;
  const viewerHearted = !!p.viewer_hearted;

  return `
<article id="post-${p.id}" class="post-card${p.pinned ? " pinned" : ""}" data-post-id="${p.id}">
  <div class="post-top">
    <div>
      <div class="post-title">${escapeHtml(p.title || "")}</div>
      <div class="post-author">
        by ${escapeHtml(p.username || "[Deleted User]")}
        ${p.is_admin ? `<span class="admin-badge">Admin</span>` : ""}
        ${p.banned ? `<span class="banned-badge">BANNED</span>` : ""}
      </div>
    </div>

    <div class="post-right">
      <div class="post-meta">
        ${p.pinned ? `<span class="pinned-badge">Pinned</span>` : ""}
        <span>${created}</span>
      </div>

      ${
        (isAdmin || p.can_edit || p.can_delete)
          ? `<div class="post-menu">
               <button class="kebab-btn">⋯</button>
               <div class="menu">
                 ${isAdmin ? `
                   <button class="toggle-pin" data-id="${p.id}" data-state="${p.pinned ? "1" : "0"}">${p.pinned ? "Unpin" : "Pin"}</button>
                   <button class="ban-user" data-username="${escapeHtml(p.username || "")}" data-banned="${p.banned ? "1" : "0"}">${p.banned ? "Unban user" : "Ban user"}</button>
                 ` : ""}
                 ${p.can_edit ? `<a href="/posts/${p.id}/edit">Edit</a>` : ""}
                 ${p.can_delete ? `
                   <form method="post" action="/posts/${p.id}/delete">
                     <button class="danger">Delete</button>
                   </form>
                 ` : ""}
               </div>
             </div>`
          : ""
      }
    </div>
  </div>

  ${p.image_filename ? `<div class="post-image-wrap"><img class="post-image" src="/uploads/${p.image_filename}" alt="Post image"></div>` : ""}

  <div class="post-body">${escapeHtml(p.body || "")}</div>

  <div class="heart-anchor"></div>

  <div class="heart-row">
    <div class="heart-box" data-post-id="${p.id}">
      <span class="heart-pulse-ring"></span>
      <button class="heart-btn${viewerHearted ? " active-heart" : ""}"
              type="button"
              aria-label="Heart this post"
              aria-pressed="${viewerHearted ? "true" : "false"}">
        <svg class="heart-icon" viewBox="0 0 24 24">
          <path d="M12 4 L18 12 H14 V20 H10 V12 H6 Z"/>
        </svg>
      </button>
      <span class="heart-count" id="heart-count-${p.id}">${hearts}</span>
    </div>
  </div>

  <button class="comments-toggle" data-state="closed">
    Show comments (<span id="comments-num-${p.id}">0</span>)
  </button>

  <div class="comments" id="comments-${p.id}">
    <div class="comments-header">
      <div class="comments-count" id="comments-count-${p.id}">0 comments</div>
    </div>

    ${
      isLogged
        ? `<div class="comment-add">
             <textarea class="comment-input" id="comment-input-${p.id}" placeholder="Add a comment…" rows="1"></textarea>
             <button class="comment-submit" data-post-id="${p.id}">Post</button>
           </div>`
        : `<div class="comment-add" style="justify-content:center;">
             <em><a href="/login" style="color:var(--accent)">Log in</a> to comment</em>
           </div>`
    }

    <ul class="comment-list" id="comment-list-${p.id}"></ul>
  </div>
</article>`;
}

/* ============================================================
   GLOBAL SEARCH (Option B)
============================================================ */
(function () {
  const input = document.getElementById("post-search-input");
  const noRes = document.getElementById("no-results");
  const container = document.querySelector(".posts-container");
  const header = container?.querySelector(".posts-header");

  if (!input || !container || !header) return;

  async function runSearch() {
    const raw = input.value;
    const q = raw.trim().toLowerCase();

    if (!q) {
      window.location.href = window.location.pathname + window.location.search;
      return;
    }

    try {
      const res = await fetch("/api/search");
      const data = await res.json();

      const isAdmin = data.viewer_is_admin;
      const isLogged = data.viewer_logged_in;
      const posts = data.posts || [];

      const ranked = posts
        .map(p => ({ post: p, score: scoredPost(p, raw) }))
        .filter(r => r.score > 0)
        .sort((a, b) => b.score - a.score);

      container.querySelectorAll(".post-card").forEach(e => e.remove());
      container.querySelectorAll(".pagination").forEach(e => e.remove());

      if (!ranked.length) {
        noRes.style.display = "block";
        return;
      }

      noRes.style.display = "none";

      ranked.forEach(r => {
        container.insertAdjacentHTML("beforeend", renderPostHTML(r.post, isAdmin, isLogged));
      });

      setupPostBodyCollapsing(container);
      loadAllCommentCounts(container);
    } catch (err) {
      console.error("Search error:", err);
    }
  }

  let debounce;
  input.addEventListener("input", () => {
    clearTimeout(debounce);
    debounce = setTimeout(runSearch, 140);
  });

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      runSearch();
    }
  });
})();

/* ============================================================
   DELETE POPUP HANDLER
============================================================ */
const popup = document.getElementById("delete-popup");
const popupText = document.getElementById("delete-popup-text");
const btnCancel = document.getElementById("delete-popup-cancel");
const btnConfirm = document.getElementById("delete-popup-confirm");

let pendingDeleteAction = null;

function openDeletePopup(message, onConfirm) {
  popupText.textContent = message;
  pendingDeleteAction = onConfirm;
  popup.classList.add("open");
}

function closeDeletePopup() {
  popup.classList.remove("open");
  pendingDeleteAction = null;
}

btnCancel.addEventListener("click", closeDeletePopup);
popup.addEventListener("click", e => {
  if (e.target === popup) closeDeletePopup();
});

btnConfirm.addEventListener("click", () => {
  if (pendingDeleteAction) pendingDeleteAction();
  closeDeletePopup();
});

/* ============================================================
   LOGIN POPUP HANDLER
============================================================ */
const loginPopup = document.getElementById("login-popup");
const loginClose = document.getElementById("login-popup-close");

if (loginPopup && loginClose) {
  loginClose.addEventListener("click", () => loginPopup.classList.remove("open"));
  loginPopup.addEventListener("click", e => {
    if (e.target === loginPopup) loginPopup.classList.remove("open");
  });
}

/* ============================================================
   HOOK INTO ALL DELETE BUTTONS (POSTS + COMMENTS)
   ✅ Comment delete only happens after confirm now
============================================================ */
document.addEventListener("click", e => {
  const delForm = e.target.closest("form[action*='delete']");
  const delCommentBtn = e.target.closest(".comment-delete");

  if (delForm && delForm.tagName === "FORM") {
    e.preventDefault();
    openDeletePopup("Delete this post?", () => delForm.submit());
    return;
  }

  if (delCommentBtn) {
    e.preventDefault();
    const commentId = delCommentBtn.dataset.id;

    openDeletePopup("Delete this comment?", async () => {
      const res = await fetch(`/comments/${commentId}/delete`, { method: "POST" });
      const data = await res.json();
      if (data.ok) delCommentBtn.closest(".comment").remove();
    });
  }
});
</script>
</body>
</html>
